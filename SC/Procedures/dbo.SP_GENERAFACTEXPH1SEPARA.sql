SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[SP_GENERAFACTEXPH1SEPARA] (@FE_CODIGO INT, @user int)   as

declare @folio varchar(25), @PI_CODIGO int, @fe_folio varchar(25), @CONSECUTIVO0 int, @CONSECUTIVO int, @CONSECUTIVO2 int,
  @fe_fecha varchar(11), @fed_indiced int, @FECODIGO varchar(50)


	select @folio=fe_folio, @fe_fecha=convert(varchar(11),fe_fecha,101) from factexp where fe_codigo=@FE_CODIGO

	select @FECODIGO= convert(varchar(50), @FE_CODIGO)
	-- separa primero los productos y subensambles

	if(SELECT  count(FED_TIP_ENS) FROM FACTEXPDET WHERE FE_CODIGO = @FE_CODIGO AND FED_TIP_ENS = 'F')> 0
	begin
		if exists (select * from factexp where fe_folio like @folio+'_%' and fe_folio not like @folio+' _%')
		begin
	               SET @fe_folio= @folio+'PT_'+convert(varchar(50),(SELECT max(convert(smallint,REPLACE(RIGHT(fe_folio, 2), '_', '')))+1  FROM factexp where fe_folio like @folio+'_%' and fe_folio not like @folio+' _%'))
		end
		else
		       SET @fe_folio= @folio+'PT_02'


		 EXEC SP_GETCONSECUTIVO @TIPO='FE', @VALUE=@CONSECUTIVO0 OUTPUT


		INSERT INTO FACTEXP(FE_CODIGO, FE_FOLIO, FE_FECHA, TF_CODIGO, TQ_CODIGO, FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, CP_CODIGO, FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA)
		
		
		SELECT     @CONSECUTIVO0, @fe_folio, FE_FECHA, (SELECT TF_CODIGO FROM TFACTURA WHERE TF_NOMBRE = 'EXPORTACION MAQUILA'), (SELECT TQ_CODIGO
				      FROM TEMBARQUE WHERE TQ_NOMBRE = 'PRODUCTO TERMINADO'), FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, (SELECT CP_CODIGO FROM CLAVEPED WHERE CP_CLAVE = 'J1'), FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA
		FROM         FACTEXP
		WHERE FE_CODIGO=@FE_CODIGO

		UPDATE FACTEXPDET
		SET FE_CODIGO=@CONSECUTIVO0
		WHERE FE_CODIGO=@FE_CODIGO
		AND TI_CODIGO IN (SELECT TI_CODIGO FROM CONFIGURATIPO WHERE CFT_TIPO='P' OR CFT_TIPO='S')


		update factexp
		set fe_cuentadet=(select isnull(count(factexpdet.fe_codigo),0) from factexpdet where factexpdet.fe_codigo =factexp.fe_codigo)
		where fe_codigo  =@CONSECUTIVO0

	end


        Exec sp_DescExplosionFactExp @FE_CODIGO, @user, 'S', 'N'


	-- crea la vista que indica de que materiales si alcanzara a descargar
	exec SP_CREAVISTAFALTANTE @FE_CODIGO


	exec sp_CreaTempFactExpDetH1

	-- verifica saldo en pedimentos y separa en H1 o A1

	exec('
	declare @CONSECUTIVO int,  @CANTH1 decimal(38,6),
	 @FED_NOPARTE varchar(30), @BST_HIJO int, @FED_COS_UNI decimal(38,6), @TI_CODIGO smallint,
	  @FED_NOMBRE varchar(150), @FED_NAME varchar(150), @FED_PES_UNI decimal(38,6), @PA_CODIGO int, @MA_GENERICO int, @EQ_GEN decimal(28,14), 
	  @AR_EXPMX int, @AR_IMPFO int, @EQ_IMPFO decimal(28,14), @FED_DISCHARGE char(1), @FED_TIP_ENS char(1),
	  @FED_RATEIMPFO decimal(38,6), @ME_CODIGO int, @ME_GENERICO int, @ME_AREXPMX int, @FED_GRA_MP decimal(38,6), @FED_GRA_MO decimal(38,6), 
	  @FED_GRA_EMP decimal(38,6), @FED_GRA_ADD decimal(38,6), @FED_GRA_GI decimal(38,6), @FED_GRA_GI_MX decimal(38,6), @FED_NG_MP decimal(38,6), @FED_NG_EMP decimal(38,6),
	  @FED_NG_ADD decimal(38,6), @FED_NG_USA decimal(38,6), @TCO_CODIGO int, @FED_NAFTA char(1), @FED_DEF_TIP char(1), @FED_POR_DEF decimal(38,6), 
	  @FED_SECF4 int, @fe_folio varchar(25)



	if (SELECT     count(BST_HIJO)
		FROM         VVISTAFALTANTE'+@FECODIGO+'
	   WHERE  ROUND((CantaDescargar - CantFaltante) / FACTCONV, 6)>0 ) > 0
	begin

		if exists (select * from factexp where fe_folio like '''+@folio+'''+''_%'' and fe_folio not like '''+@folio+'''+'' _%'')
		begin
	               SET @fe_folio= '''+@folio+'''+''RE_''+convert(varchar(50),(SELECT max(convert(smallint,REPLACE(RIGHT(fe_folio, 2), ''_'', '''')))+1  FROM factexp where fe_folio like '''+@folio+'''+''_%'' and fe_folio not like '''+@folio+'''+'' _%''))
		end
		else
		       SET @fe_folio= '''+@folio+'''+''RE_02''


		 EXEC SP_GETCONSECUTIVO @TIPO=''FE'', @VALUE=@CONSECUTIVO OUTPUT


		INSERT INTO FACTEXP(FE_CODIGO, FE_FOLIO, FE_FECHA, TF_CODIGO, TQ_CODIGO, FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, CP_CODIGO, FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA)
		
		
		SELECT     @CONSECUTIVO, @fe_folio, FE_FECHA, TF_CODIGO, (SELECT TQ_CODIGO FROM TEMBARQUE WHERE TQ_NOMBRE=''RETORNO''), 
                                                 FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, (SELECT CP_CODIGO FROM CLAVEPED WHERE CP_CLAVE = ''H1''), FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA
		FROM         FACTEXP
		WHERE FE_CODIGO='+@FECODIGO+' 

	end


	
	DECLARE CUR_FACTEXPH1 CURSOR FOR
		SELECT     BST_HIJO,  ROUND((CantaDescargar - CantFaltante) / FACTCONV, 6) AS CANTH1
		FROM        VVISTAFALTANTE'+@FECODIGO+'
		WHERE ROUND((CantaDescargar - CantFaltante) / FACTCONV, 6) >0
	OPEN CUR_FACTEXPH1
	
	FETCH NEXT FROM CUR_FACTEXPH1 INTO @BST_HIJO, @CANTH1
	
	WHILE (@@FETCH_STATUS = 0) 
	BEGIN

		SELECT @FED_NOPARTE=FED_NOPARTE, @FED_COS_UNI = FED_COS_UNI, @TI_CODIGO = TI_CODIGO,
			@FED_NOMBRE=FED_NOMBRE, @FED_NAME = FED_NAME, @FED_PES_UNI = FED_PES_UNI, @PA_CODIGO = PA_CODIGO, 
			@MA_GENERICO = MA_GENERICO, @EQ_GEN = EQ_GEN, @AR_EXPMX = AR_EXPMX, @AR_IMPFO = AR_IMPFO, @EQ_IMPFO = EQ_IMPFO,
			@FED_DISCHARGE = FED_DISCHARGE, @FED_TIP_ENS = FED_TIP_ENS,
			@FED_RATEIMPFO = FED_RATEIMPFO, @ME_CODIGO = ME_CODIGO, @ME_GENERICO = ME_GENERICO, @ME_AREXPMX = ME_AREXPMX, 
			@FED_GRA_MP = FED_GRA_MP, @FED_GRA_MO = FED_GRA_MO, @FED_GRA_EMP = FED_GRA_EMP, @FED_GRA_ADD = FED_GRA_ADD, 
			@FED_GRA_GI = FED_GRA_GI, @FED_GRA_GI_MX = FED_GRA_GI_MX, @FED_NG_MP = FED_NG_MP, @FED_NG_EMP = FED_NG_EMP, 
                        @FED_NG_ADD = FED_NG_ADD, @FED_NG_USA = FED_NG_USA, @TCO_CODIGO = TCO_CODIGO, 
			@FED_NAFTA = FED_NAFTA, @FED_DEF_TIP = FED_DEF_TIP, @FED_POR_DEF = FED_POR_DEF, @FED_SECF4 = FED_SECF4
		FROM FACTEXPDET 
		WHERE FE_CODIGO='+@FECODIGO+' AND MA_CODIGO= @BST_HIJO


		INSERT INTO TempFactExpDetH1 (FE_CODIGO, FED_CANT, FED_NOPARTE, MA_CODIGO, FED_COS_UNI, TI_CODIGO,
		FED_NOMBRE, FED_NAME, FED_PES_UNI, PA_CODIGO, MA_GENERICO, EQ_GEN, AR_EXPMX, AR_IMPFO, EQ_IMPFO, FED_DISCHARGE, FED_TIP_ENS,
		FED_RATEIMPFO, ME_CODIGO, ME_GENERICO, ME_AREXPMX, FED_GRA_MP, FED_GRA_MO, FED_GRA_EMP, FED_GRA_ADD, 
		FED_GRA_GI, FED_GRA_GI_MX, FED_NG_MP, FED_NG_EMP, FED_NG_ADD, FED_NG_USA, TCO_CODIGO, FED_NAFTA, FED_DEF_TIP, FED_POR_DEF, FED_SECF4)

		VALUES (@CONSECUTIVO, @CANTH1, @FED_NOPARTE, @BST_HIJO, @FED_COS_UNI, @TI_CODIGO,
		@FED_NOMBRE, @FED_NAME, @FED_PES_UNI, @PA_CODIGO, @MA_GENERICO, @EQ_GEN, @AR_EXPMX, @AR_IMPFO, @EQ_IMPFO, @FED_DISCHARGE, @FED_TIP_ENS,
		@FED_RATEIMPFO, @ME_CODIGO, @ME_GENERICO, @ME_AREXPMX, @FED_GRA_MP, @FED_GRA_MO, @FED_GRA_EMP, @FED_GRA_ADD, 
		@FED_GRA_GI, @FED_GRA_GI_MX, @FED_NG_MP, @FED_NG_EMP, @FED_NG_ADD, @FED_NG_USA, @TCO_CODIGO, @FED_NAFTA, @FED_DEF_TIP, @FED_POR_DEF, 
		@FED_SECF4)



		FETCH NEXT FROM CUR_FACTEXPH1 INTO @BST_HIJO, @CANTH1
	
	END
	
	CLOSE CUR_FACTEXPH1
	DEALLOCATE CUR_FACTEXPH1')







	exec('
	declare @CONSECUTIVO2 int, @CANTA1 decimal(38,6),
	  @FED_NOPARTE varchar(30), @BST_HIJO int, @FED_COS_UNI decimal(38,6), @TI_CODIGO smallint,
	  @FED_NOMBRE varchar(150), @FED_NAME varchar(150), @FED_PES_UNI decimal(38,6), @PA_CODIGO int, @MA_GENERICO int, @EQ_GEN decimal(28,14), 
	  @AR_EXPMX int, @AR_IMPFO int, @EQ_IMPFO decimal(28,14), @FED_DISCHARGE char(1), @FED_TIP_ENS char(1),
	  @FED_RATEIMPFO decimal(38,6), @ME_CODIGO int, @ME_GENERICO int, @ME_AREXPMX int, @FED_GRA_MP decimal(38,6), @FED_GRA_MO decimal(38,6), 
	  @FED_GRA_EMP decimal(38,6), @FED_GRA_ADD decimal(38,6), @FED_GRA_GI decimal(38,6), @FED_GRA_GI_MX decimal(38,6), @FED_NG_MP decimal(38,6), @FED_NG_EMP decimal(38,6),
	  @FED_NG_ADD decimal(38,6), @FED_NG_USA decimal(38,6), @TCO_CODIGO int, @FED_NAFTA char(1), @FED_DEF_TIP char(1), @FED_POR_DEF decimal(38,6), 
	  @FED_SECF4 int, @fe_folio varchar(25)



	if (SELECT     count(BST_HIJO)
		FROM         VVISTAFALTANTE'+@FECODIGO+'
	   WHERE  ROUND(CantFaltante / FACTCONV, 6)>0 ) > 0
	begin

		if exists (select * from factexp where fe_folio like '''+@folio+'''+''_%'' and fe_folio not like '''+@folio+'''+'' _%'')
		begin
	               SET @fe_folio= '''+@folio+'''+''DEF_''+convert(varchar(50),(SELECT max(convert(smallint,REPLACE(RIGHT(fe_folio, 2), ''_'', '''')))+1  FROM factexp where fe_folio like '''+@folio+'''+''_%'' and fe_folio not like '''+@folio+'''+'' _%''))
		end
		else
		       SET @fe_folio= '''+@folio+'''+''DEF_02''


		 EXEC SP_GETCONSECUTIVO @TIPO=''FE'', @VALUE=@CONSECUTIVO2 OUTPUT


		INSERT INTO FACTEXP(FE_CODIGO, FE_FOLIO, FE_FECHA, TF_CODIGO, TQ_CODIGO, FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, CP_CODIGO, FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA)
		
		
		SELECT     @CONSECUTIVO2, @fe_folio, FE_FECHA, (SELECT TF_CODIGO FROM TFACTURA WHERE TF_NOMBRE=''EXPORTACION DEFINITIVA''), 
                                                 (SELECT TQ_CODIGO FROM TEMBARQUE WHERE TQ_NOMBRE=''TODO TIPO MATERIAL''), FE_TIPO, FE_PINICIAL, FE_PFINAL, FC_CODIGO, TN_CODIGO, FE_NO_SEM, 
		                      FE_DOCUMENTO, FE_DESTINO, AG_MX, AG_US, CL_PROD, DI_PROD, CL_COMP, DI_COMP, CO_COMP, CL_COMPFIN, DI_COMPFIN, CO_COMPFIN, 
		                      CL_EXP, DI_EXP, CL_EXPFIN, DI_EXPFIN, CL_DESTINI, DI_DESTINI, CO_DESTINI, CL_DESTFIN, DI_DESTFIN, CO_DESTFIN, CL_VEND, DI_VEND, 
		                      CL_IMP, DI_IMP, CO_IMP, PU_CARGA, PU_SALIDA, PU_ENTRADA, PU_DESTINO, FE_FEC_ENV, FE_FEC_ARR, FE_NUM_ENV, FE_ENV_INST, 
		                      FE_ORD_COMP, FE_NUM_CTL, FE_NUM_INBON, FE_TIPO_INBON, FE_FEC_INBON, FE_FIRMS, FE_COMENTA, FE_COMENTAUS, US_CODIGO, 
		                      CT_COMPANY1, CA_COMPANY1, CJ_COMPANY1, CT_COMPANY2, CA_COMPANY2, CJ_COMPANY2, FE_TRAC_US1, FE_TRAC_MX1, FE_CONT1_REG, 
		                      FE_CONT1_US, FE_CONT1_SELL, TCA_CONT1, PG_COMPANY1, FE_TRAC_CHO1, FE_LIM1, RU_COMPANY1, FE_TPAGO_FLETE1, 
		                      FE_TPAGO_FLETE2, IT_COMPANY1, MT_COMPANY1, FE_GUIA1, FE_TRAC_US2, FE_TRAC_MX2, 
		                      FE_CONT2_REG, FE_CONT2_US, FE_CONT2_SELL, TCA_CONT2, PG_COMPANY2, FE_TRAC_CHO2, FE_LIM2, RU_COMPANY2, 
		                      IT_COMPANY2, MT_COMPANY2, FE_GUIA2, FE_TOTALB, FE_TIPOCAMBIO, FE_MANIF, FE_MANIF_DATE, 
		                      FE_AWB, FE_INCOTLUGAR1, FE_INCOTLUGAR2, FE_LAGNO, FE_DESCARGADA, FE_FACTAGRU, FE_ESTATUS, FE_CANCELADO, FE_MOSTRARDIV, 
		                      MO_CODIGO, SPI_CODIGO, FE_CON_PEDCR, FE_DESCRIPTION1, FE_DESCRIPTION2, FE_INVOICETYPE, FE_HEADER, FE_FOOTER, FE_COMENTACO, 
		                      ALM_CODIGO, FE_DISCHCONTENEDOR1, PI_CODIGO, PI_RECTIFICA, PI_TRANS, FE_DESCARGABLE, FE_USACONSOLIDADO, FE_SEL, FE_AUXDESC, 
		                      FE_BARCODE, FE_PREVIADESC, FE_DESCSUST, BC_CODIGO, FE_DESCITALICA, FE_FECHADESCARGA, FE_CUENTADET, FE_CONSECUTIVOPED, 
		                      FE_TRANSNOORIG, FE_TRANSNO, FE_GAFETECHOFER, AGT_CODIGO, FE_DESCMANUAL, ETC_CODIGO, ET_CODIGO, FE_NUMVEHICULOS, 
		                      FE_PRIORIDAD, (SELECT CP_CODIGO FROM CLAVEPED WHERE CP_CLAVE = ''A1''), FE_USAPESODESP, FEG_CODIGO, FE_PROCESOSUBMAQ, FE_INICIOCRUCE, FE_FIRMAAVISO, FE_FIRMAELECTAVANZ, 
		                      FE_BARCODEREMESA, BC_REMESA
		FROM         FACTEXP
		WHERE FE_CODIGO='+@FECODIGO+' 

	end


	
	DECLARE CUR_FACTEXPA1 CURSOR FOR
		SELECT     BST_HIJO,  ROUND(CantFaltante / FACTCONV, 6) AS CANTA1
		FROM        VVISTAFALTANTE'+@FECODIGO+'
		WHERE ROUND(CantFaltante / FACTCONV, 6) >0
	OPEN CUR_FACTEXPA1
	
	FETCH NEXT FROM CUR_FACTEXPA1 INTO @BST_HIJO, @CANTA1
	
	WHILE (@@FETCH_STATUS = 0) 
	BEGIN

		SELECT @FED_NOPARTE=FED_NOPARTE, @FED_COS_UNI = FED_COS_UNI, @TI_CODIGO = TI_CODIGO,
			@FED_NOMBRE=FED_NOMBRE, @FED_NAME = FED_NAME, @FED_PES_UNI = FED_PES_UNI, @PA_CODIGO = PA_CODIGO, 
			@MA_GENERICO = MA_GENERICO, @EQ_GEN = EQ_GEN, @AR_EXPMX = AR_EXPMX, @AR_IMPFO = AR_IMPFO, @EQ_IMPFO = EQ_IMPFO,
			@FED_DISCHARGE = FED_DISCHARGE, @FED_TIP_ENS = FED_TIP_ENS,
			@FED_RATEIMPFO = FED_RATEIMPFO, @ME_CODIGO = ME_CODIGO, @ME_GENERICO = ME_GENERICO, @ME_AREXPMX = ME_AREXPMX, 
			@FED_GRA_MP = FED_GRA_MP, @FED_GRA_MO = FED_GRA_MO, @FED_GRA_EMP = FED_GRA_EMP, @FED_GRA_ADD = FED_GRA_ADD, 
			@FED_GRA_GI = FED_GRA_GI, @FED_GRA_GI_MX = FED_GRA_GI_MX, @FED_NG_MP = FED_NG_MP, @FED_NG_EMP = FED_NG_EMP, 
                        @FED_NG_ADD = FED_NG_ADD, @FED_NG_USA = FED_NG_USA, @TCO_CODIGO = TCO_CODIGO, 
			@FED_NAFTA = FED_NAFTA, @FED_DEF_TIP = FED_DEF_TIP, @FED_POR_DEF = FED_POR_DEF, @FED_SECF4 = FED_SECF4
		FROM FACTEXPDET 
		WHERE FE_CODIGO='+@FECODIGO+' AND MA_CODIGO= @BST_HIJO


		INSERT INTO TempFactExpDetH1 (FE_CODIGO, FED_CANT, FED_NOPARTE, MA_CODIGO, FED_COS_UNI, TI_CODIGO,
		FED_NOMBRE, FED_NAME, FED_PES_UNI, PA_CODIGO, MA_GENERICO, EQ_GEN, AR_EXPMX, AR_IMPFO, EQ_IMPFO, FED_DISCHARGE, FED_TIP_ENS,
		FED_RATEIMPFO, ME_CODIGO, ME_GENERICO, ME_AREXPMX, FED_GRA_MP, FED_GRA_MO, FED_GRA_EMP, FED_GRA_ADD, 
		FED_GRA_GI, FED_GRA_GI_MX, FED_NG_MP, FED_NG_EMP, FED_NG_ADD, FED_NG_USA, TCO_CODIGO, FED_NAFTA, FED_DEF_TIP, FED_POR_DEF, FED_SECF4)

		VALUES (@CONSECUTIVO2, @CANTA1, @FED_NOPARTE, @BST_HIJO, @FED_COS_UNI, @TI_CODIGO,
		@FED_NOMBRE, @FED_NAME, @FED_PES_UNI, @PA_CODIGO, @MA_GENERICO, @EQ_GEN, @AR_EXPMX, @AR_IMPFO, @EQ_IMPFO, @FED_DISCHARGE, @FED_TIP_ENS,
		@FED_RATEIMPFO, @ME_CODIGO, @ME_GENERICO, @ME_AREXPMX, @FED_GRA_MP, @FED_GRA_MO, @FED_GRA_EMP, @FED_GRA_ADD, 
		@FED_GRA_GI, @FED_GRA_GI_MX, @FED_NG_MP, @FED_NG_EMP, @FED_NG_ADD, @FED_NG_USA, @TCO_CODIGO, @FED_NAFTA, @FED_DEF_TIP, @FED_POR_DEF, 
		@FED_SECF4)



		FETCH NEXT FROM CUR_FACTEXPA1 INTO @BST_HIJO, @CANTA1
	
	END
	
	CLOSE CUR_FACTEXPA1
	DEALLOCATE CUR_FACTEXPA1')



	-- calculos despues de la insercion
	UPDATE TempFactExpDetH1
	SET FED_NAFTA=dbo.GetNafta (@fe_fecha, TempFactExpDetH1.MA_CODIGO, TempFactExpDetH1.AR_IMPMX, TempFactExpDetH1.PA_CODIGO, TempFactExpDetH1.FED_DEF_TIP, TempFactExpDetH1.FED_TIP_ENS)
	WHERE FE_CODIGO in (select fe_codigo from TempFactExpDetH1)

	UPDATE TempFactExpDetH1
	SET FED_RATEIMPFO=(CASE WHEN FED_NAFTA='S' THEN 0 ELSE dbo.GetAdvalorem(AR_IMPFO, 0, 'G', 0, 0) END)
	WHERE FE_CODIGO in (select fe_codigo from TempFactExpDetH1)


	UPDATE TempFactExpDetH1
	SET FED_COS_TOT= round(isnull(FED_COS_UNI*FED_CANT,0),6),
	FED_PES_NET= round(isnull(FED_CANT* FED_PES_UNI,0),6), 
	FED_PES_NETLB=round(isnull(FED_CANT* FED_PES_UNI * 2.20462442018378,0),6),
	FED_PES_BRU=round(isnull(FED_CANT* FED_PES_UNI,0),6), 
	FED_PES_BRULB=round(isnull(FED_CANT* FED_PES_UNI * 2.20462442018378,0),6),
	FED_PES_UNILB=round(isnull(FED_PES_UNI*2.20462442018378,0),6)
	WHERE FE_CODIGO in (select fe_codigo from TempFactExpDetH1)

	UPDATE TempFactExpDetH1
	SET ME_AREXPMX=isnull((SELECT ME_CODIGO FROM ARANCEL WHERE AR_CODIGO = TempFactExpDetH1.AR_EXPMX),19)
	WHERE FE_CODIGO in (select fe_codigo from TempFactExpDetH1)


	update TempFactExpDetH1	set ar_orig= case when fed_nafta='S' then
		 0 else ( case when isnull((select max(ar_codigo) from bom_arancel where ba_tipocosto='N' and bom_arancel.ma_codigo=TempFactExpDetH1.ma_codigo),0)=0 
		then  isnull((select AR_IMPFOUSA from maestro where maestro.ma_codigo=TempFactExpDetH1.ma_codigo),0)  else isnull((select max(ar_codigo) from bom_arancel where ba_tipocosto='N' and bom_arancel.ma_codigo=TempFactExpDetH1.ma_codigo),0) end) end
	where (ar_orig is null or ar_orig =0) and fed_retrabajo<>'R' and ti_codigo in (select ti_codigo from configuratipo where cft_tipo='P' or cft_tipo='S') and fed_tip_ens<>'C'
	and fed_ng_usa>0 and fe_codigo in (select fe_codigo from TempFactExpDetH1)
	

	update TempFactExpDetH1
	set ar_ng_emp= case when fed_nafta='S' then
	 0 else isnull((select max(ar_codigo) from bom_arancel where ba_tipocosto='3' and bom_arancel.ma_codigo=TempFactExpDetH1.ma_codigo),0) end
	where (ar_ng_emp is null or ar_ng_emp =0) and fed_retrabajo<>'R' and ti_codigo in (select ti_codigo from configuratipo where cft_tipo='P' or cft_tipo='S') and fed_tip_ens<>'C'
	and fed_ng_emp>0 and fe_codigo in (select fe_codigo from TempFactExpDetH1)


	UPDATE dbo.TempFactExpDetH1
	SET     dbo.TempFactExpDetH1.FED_DESTNAFTA= CASE 
	when dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_MX FROM CONFIGURACION) THEN 'M'
	 when dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_USA FROM CONFIGURACION) or dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_CA FROM CONFIGURACION)
	then 'N'  WHEN 	  dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT PA_CODIGO FROM PAIS WHERE SPI_CODIGO IN ( SELECT SPI_CODIGO FROM SPI WHERE SPI_CLAVE='MX-UE')) 
	then 'U' when 	  dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT PA_CODIGO FROM PAIS WHERE SPI_CODIGO IN ( SELECT SPI_CODIGO FROM SPI WHERE SPI_CLAVE='AELC')) 
	then 'A'  else 'F' end
	FROM         dbo.TempFactExpDetH1 INNER JOIN
	                      dbo.FACTEXP ON dbo.TempFactExpDetH1.FE_CODIGO = dbo.FACTEXP.FE_CODIGO LEFT OUTER JOIN
	                      dbo.DIR_CLIENTE ON dbo.FACTEXP.DI_DESTFIN = dbo.DIR_CLIENTE.DI_INDICE
	where  dbo.TempFactExpDetH1.FE_CODIGO in (select fe_codigo from TempFactExpDetH1)



	INSERT INTO FACTEXPDET(FED_INDICED, FE_CODIGO, MA_CODIGO, FED_NOMBRE, FED_NOPARTE, FED_NAME, ME_CODIGO, FED_OBSERVA, FED_CANT, FED_GRA_MP, 
	                      FED_GRA_MO, FED_GRA_EMP, FED_GRA_ADD, FED_GRA_GI, FED_GRA_GI_MX, FED_NG_MP, FED_NG_EMP, FED_NG_ADD, FED_NG_USA, 
	                      FED_COS_UNI, FED_COS_TOT, FED_PES_UNI, FED_PES_NET, FED_PES_BRU, FED_PES_UNILB, FED_PES_NETLB, FED_PES_BRULB, 
	                      FED_SEC_IMP, FED_DEF_TIP, FED_POR_DEF, FED_LOTE, AR_IMPMX, AR_EXPMX, AR_IMPFO, FED_CON_PED, MA_GENERICO, PA_CODIGO, 
	                      LE_CODIGO, LED_INDICED, EX_CODIGO, FED_ORD_COMP, FED_NOORDEN, FED_USO_COMMINV, EQ_GEN, EQ_IMPFO, EQ_EXPMX, TI_CODIGO, 
	                      FED_TENVIO, FED_INBOND, FED_TIPOINBOND, FED_RATEEXPMX, FED_RATEIMPFO, FED_RELEMP, FED_FECHA_STRUCT, FED_DISCHARGE, 
	                      LE_FOLIO, SPI_CODIGO, FED_SALDO, FED_RETRABAJO, ADE_CODIGO, MA_EMPAQUE, FED_CANTEMP, FED_FAC_NUM, FED_FEC_ENV, 
	                      FED_CON_CERTORIG, FED_COS_UNI_CO, FED_GRA_MAT_CO, FED_EMP_CO, FED_NG_MAT_CO, FED_VA_CO, FED_CANTGEN, MO_CODIGO, 
	                      FED_DESCARGADO, FED_PARTTYPE, ME_GENERICO, FED_TIP_ENS, PID_INDICED, MA_NOPARTECL, ME_AREXPMX, FED_NAFTA, FED_DEFTXT1, 
	                      FED_DEFTXT2, FED_DEFNO3, FED_DEFNO4, PID_INDICEDLIGA, PID_INDICEDLIGAR1, TCO_CODIGO, PI_ORIGENKITPADRE, CS_CODIGO, 
	                      SE_CODIGO, FED_RELCAJAS, END_INDICED, EN_CODIGO, FED_SALDOTRANS, FED_USOTRANS, FED_USOSALDO, CL_CODIGO, MA_STRUCT, 
	                      FED_DESTNAFTA, AR_ORIG, AR_NG_EMP, FED_NOPARTEAUX, ETA_CODIGO, FED_NG_MX, FED_NOPARTESTRUCT, FED_GENERA_EMPDET, FED_SECF4)
	
	
	SELECT     FED_INDICED, FE_CODIGO, MA_CODIGO, FED_NOMBRE, FED_NOPARTE, FED_NAME, ME_CODIGO, FED_OBSERVA, FED_CANT, FED_GRA_MP, 
	                      FED_GRA_MO, FED_GRA_EMP, FED_GRA_ADD, FED_GRA_GI, FED_GRA_GI_MX, FED_NG_MP, FED_NG_EMP, FED_NG_ADD, FED_NG_USA, 
	                      FED_COS_UNI, FED_COS_TOT, FED_PES_UNI, FED_PES_NET, FED_PES_BRU, FED_PES_UNILB, FED_PES_NETLB, FED_PES_BRULB, 
	                      FED_SEC_IMP, FED_DEF_TIP, FED_POR_DEF, FED_LOTE, ISNULL(AR_IMPMX,0), ISNULL(AR_EXPMX,AR_IMPMX), ISNULL(AR_IMPFO,0), FED_CON_PED, MA_GENERICO, PA_CODIGO, 
	                      LE_CODIGO, LED_INDICED, EX_CODIGO, FED_ORD_COMP, FED_NOORDEN, FED_USO_COMMINV, EQ_GEN, EQ_IMPFO, EQ_EXPMX, TI_CODIGO, 
	                      FED_TENVIO, FED_INBOND, FED_TIPOINBOND, FED_RATEEXPMX, FED_RATEIMPFO, FED_RELEMP, FED_FECHA_STRUCT, FED_DISCHARGE, 
	                      LE_FOLIO, SPI_CODIGO, FED_SALDO, FED_RETRABAJO, ADE_CODIGO, MA_EMPAQUE, FED_CANTEMP, FED_FAC_NUM, FED_FEC_ENV, 
	                      FED_CON_CERTORIG, FED_COS_UNI_CO, FED_GRA_MAT_CO, FED_EMP_CO, FED_NG_MAT_CO, FED_VA_CO, FED_CANTGEN, MO_CODIGO, 
	                      FED_DESCARGADO, FED_PARTTYPE, ME_GENERICO, FED_TIP_ENS, PID_INDICED, MA_NOPARTECL, ME_AREXPMX, FED_NAFTA, FED_DEFTXT1, 
	                      FED_DEFTXT2, FED_DEFNO3, FED_DEFNO4, PID_INDICEDLIGA, PID_INDICEDLIGAR1, TCO_CODIGO, PI_ORIGENKITPADRE, CS_CODIGO, 
	                      SE_CODIGO, FED_RELCAJAS, END_INDICED, EN_CODIGO, FED_SALDOTRANS, FED_USOTRANS, FED_USOSALDO, CL_CODIGO, MA_STRUCT, 
	                      FED_DESTNAFTA, AR_ORIG, AR_NG_EMP, FED_NOPARTEAUX, ETA_CODIGO, FED_NG_MX, FED_NOPARTESTRUCT, FED_GENERA_EMPDET, FED_SECF4
	FROM         TempFactExpDetH1




		update factexp
		set fe_cuentadet=(select isnull(count(factexpdet.fe_codigo),0) from factexpdet where factexpdet.fe_codigo =factexp.fe_codigo)
		where fe_codigo  in (select fe_codigo from TempFactExpDetH1)




		select @fed_indiced= max(fed_indiced) from factexpdet

		update consecutivo
		set cv_codigo =  isnull(@fed_indiced,0) + 1
		where cv_tipo = 'FED'


		delete from factexp where fe_codigo=@FE_CODIGO

		delete from factexpdet where fe_codigo not in (select fe_codigo from factexp)

	exec sp_droptable 'TempFactExpDetH1'


GO
