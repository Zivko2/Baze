SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO





























CREATE PROCEDURE [dbo].[SP_ACTUALIZAEQGENALL]   as

SET NOCOUNT ON 
DECLARE @ME_KILOGRAMOS int

	select @ME_KILOGRAMOS=ME_KILOGRAMOS from configuracion


		update dbo.MAESTRO
		SET     dbo.MAESTRO.EQ_GEN = 1
		WHERE dbo.MAESTRO.EQ_GEN <> 1




		if exists (SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)
		begin
			UPDATE MAESTRO
			SET EQ_GEN = round(MA_PESO_KG,6)
			WHERE MA_PESO_KG>0 and EQ_GEN <> round(MA_PESO_KG,6) AND MA_GENERICO IN
			(SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


			UPDATE MAESTRO
			SET EQ_GEN = 1
			WHERE MA_PESO_KG=0 and EQ_GEN <> 1
			AND ME_COM not in (SELECT ME_CODIGO1 FROM EQUIVALE WHERE ME_CODIGO2 in (select ME_KILOGRAMOS from configuracion))
			AND MA_GENERICO IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


			UPDATE MAESTRO
			SET EQ_GEN = 1
			WHERE EQ_GEN <> 1 and ME_COM in (select ME_KILOGRAMOS from configuracion)
			AND MA_GENERICO IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


		end

		--DE LOS FISICOS

		update ANEXO24
		SET     ANEXO24.EQ_GENERICOFIS = 1
		FROM MAESTRO INNER JOIN ANEXO24 ON MAESTRO.MA_CODIGO=ANEXO24.MA_CODIGO
		WHERE ANEXO24.EQ_GENERICOFIS <> 1


		if exists (SELECT     dbo.ANEXO24.EQ_GENERICOFIS
			FROM         dbo.ANEXO24 INNER JOIN
			                      dbo.MAESTRO MAESTRO_1 ON dbo.ANEXO24.MA_GENERICOFIS = MAESTRO_1.MA_CODIGO INNER JOIN
			                      dbo.EQUIVALE ON MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2 INNER JOIN
			                      dbo.MAESTRO MAESTRO_2 ON dbo.ANEXO24.MA_CODIGO = MAESTRO_2.MA_CODIGO AND dbo.EQUIVALE.ME_CODIGO1 = MAESTRO_2.ME_COM)
			UPDATE ANEXO24
			SET     ANEXO24.EQ_GENERICOFIS= EQUIVALE.EQ_CANT
			FROM         dbo.ANEXO24 INNER JOIN
			                      dbo.MAESTRO MAESTRO_1 ON dbo.ANEXO24.MA_GENERICOFIS = MAESTRO_1.MA_CODIGO INNER JOIN
			                      dbo.EQUIVALE ON MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2 INNER JOIN
			                      dbo.MAESTRO MAESTRO_2 ON dbo.ANEXO24.MA_CODIGO = MAESTRO_2.MA_CODIGO AND dbo.EQUIVALE.ME_CODIGO1 = MAESTRO_2.ME_COM
			WHERE ANEXO24.EQ_GENERICOFIS<> EQUIVALE.EQ_CANT


		if (SELECT COUNT(MA_CODIGO) FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)>0
		begin
			UPDATE ANEXO24
			SET EQ_GENERICOFIS = round(MA_PESO_KG,6)
			FROM MAESTRO INNER JOIN ANEXO24 ON MAESTRO.MA_CODIGO=ANEXO24.MA_CODIGO
			WHERE MA_PESO_KG>0 and EQ_GENERICOFIS<> round(MA_PESO_KG,6) AND MA_GENERICOFIS IN
			(SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


			UPDATE ANEXO24
			SET EQ_GENERICOFIS = 1
			FROM MAESTRO INNER JOIN ANEXO24 ON MAESTRO.MA_CODIGO=ANEXO24.MA_CODIGO
			WHERE MA_PESO_KG=0 and EQ_GENERICOFIS<> 1
			AND ME_COM not in (SELECT ME_CODIGO1 FROM EQUIVALE WHERE ME_CODIGO2 in (select ME_KILOGRAMOS from configuracion))
			AND MA_GENERICOFIS IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


			UPDATE ANEXO24
			SET EQ_GENERICOFIS= 1
			FROM MAESTRO INNER JOIN ANEXO24 ON MAESTRO.MA_CODIGO=ANEXO24.MA_CODIGO
			WHERE EQ_GENERICOFIS<> 1 and ME_COM in (select ME_KILOGRAMOS from configuracion)
			AND MA_GENERICOFIS IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN='G' AND ME_COM=@ME_KILOGRAMOS)


		end


		begin tran
		UPDATE  BOM_STRUCT
		SET     BOM_STRUCT.ME_CODIGO= MAESTRO.ME_COM
		FROM         BOM_STRUCT INNER JOIN
		                      MAESTRO ON BOM_STRUCT.BST_HIJO = MAESTRO.MA_CODIGO
		WHERE     (BOM_STRUCT.ME_CODIGO = 0) AND MAESTRO.ME_COM<>0
		commit tran

		begin tran
		UPDATE BOM_STRUCT
		SET     BOM_STRUCT.ME_GEN= MAESTRO_1.ME_COM
		FROM         BOM_STRUCT INNER JOIN
		                      MAESTRO ON BOM_STRUCT.BST_HIJO = MAESTRO.MA_CODIGO INNER JOIN
		                      MAESTRO MAESTRO_1 ON MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO AND BOM_STRUCT.ME_GEN <> MAESTRO_1.ME_COM
		commit tran

		--Yolanda Avila
		--2010-12-14
		--Se cambio el orden de los queries ya que debe modificarse primero el maestro y posteriormente el BOM_struct para que asigne los valores correctos
		/*
		begin tran
		UPDATE BOM_STRUCT
		SET     BOM_STRUCT.FACTCONV= MAESTRO.EQ_GEN
		FROM         BOM_STRUCT INNER JOIN
		                     MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = MAESTRO.MA_CODIGO AND BOM_STRUCT.ME_CODIGO = MAESTRO.ME_COM AND 
		                      BOM_STRUCT.FACTCONV <> MAESTRO.EQ_GEN
		commit tran



		if exists (SELECT dbo.MAESTRO.EQ_GEN FROM dbo.MAESTRO INNER JOIN
			                      dbo.MAESTRO MAESTRO_1 ON dbo.MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO INNER JOIN
			                      dbo.EQUIVALE ON dbo.MAESTRO.ME_COM = dbo.EQUIVALE.ME_CODIGO1 AND MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2)
			update dbo.MAESTRO
			SET     dbo.MAESTRO.EQ_GEN= dbo.EQUIVALE.EQ_CANT
			FROM         dbo.MAESTRO INNER JOIN
			                      dbo.MAESTRO MAESTRO_1 ON dbo.MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO INNER JOIN
			                      dbo.EQUIVALE ON dbo.MAESTRO.ME_COM = dbo.EQUIVALE.ME_CODIGO1 AND MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2
			WHERE dbo.MAESTRO.EQ_GEN<> dbo.EQUIVALE.EQ_CANT



		*/


		if exists ( SELECT dbo.MAESTRO.EQ_GEN 
			    FROM dbo.MAESTRO 
			    INNER JOIN dbo.MAESTRO MAESTRO_1 ON dbo.MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO 
			    INNER JOIN dbo.EQUIVALE ON dbo.MAESTRO.ME_COM = dbo.EQUIVALE.ME_CODIGO1 
				  AND MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2)
			update dbo.MAESTRO
			SET dbo.MAESTRO.EQ_GEN= dbo.EQUIVALE.EQ_CANT
			FROM dbo.MAESTRO 
			INNER JOIN dbo.MAESTRO MAESTRO_1 ON dbo.MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO 
			INNER JOIN dbo.EQUIVALE ON dbo.MAESTRO.ME_COM = dbo.EQUIVALE.ME_CODIGO1 
				AND MAESTRO_1.ME_COM = dbo.EQUIVALE.ME_CODIGO2
			WHERE dbo.MAESTRO.EQ_GEN <> dbo.EQUIVALE.EQ_CANT

		begin tran
		UPDATE BOM_STRUCT
		SET BOM_STRUCT.FACTCONV= MAESTRO.EQ_GEN
		FROM BOM_STRUCT 
		INNER JOIN MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = MAESTRO.MA_CODIGO 
			AND BOM_STRUCT.ME_CODIGO = MAESTRO.ME_COM 
			AND BOM_STRUCT.FACTCONV <> MAESTRO.EQ_GEN
		commit tran













GO
