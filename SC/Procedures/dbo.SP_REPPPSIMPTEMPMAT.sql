SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO





























/*Importaciones temporales de materia prima bajo pps*/
CREATE PROCEDURE dbo.SP_REPPPSIMPTEMPMAT ( @DAPCODIGO INT)   as

SET NOCOUNT ON 

DECLARE @TOTIMPTEMP1 decimal(38,6), @TOTIMPTEMP1dlls decimal(38,6)

if exists (select * 	FROM VREPPPSIMPTEMPMAT
	WHERE DAP_CODIGO=@DAPCODIGO)
begin
	DECLARE CUR_DECANUALTIMPTEMP1 CURSOR FOR
	
		SELECT SUM(valor), SUM(PID_CTOT_DLS)
		FROM VREPPPSIMPTEMPMAT
		WHERE DAP_CODIGO=@DAPCODIGO
		GROUP BY DAP_CODIGO 
	
	
	
	OPEN CUR_DECANUALTIMPTEMP1
			
	FETCH NEXT FROM CUR_DECANUALTIMPTEMP1 INTO @TOTIMPTEMP1, @TOTIMPTEMP1dlls
	
	WHILE (@@FETCH_STATUS = 0) 
	BEGIN
	
		if @TOTIMPTEMP1=0 or @TOTIMPTEMP1 is null
		set @TOTIMPTEMP1=@TOTIMPTEMP1dlls
	
	
		UPDATE DECANUALPPS
		SET DAP_IMPTEMPMAT= floor(round(@TOTIMPTEMP1, 0)/1000),  DAP_IMPTEMPMATUSD= floor(round(@TOTIMPTEMP1dlls, 0)/1000)
		WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO
	
	
		FETCH NEXT FROM CUR_DECANUALTIMPTEMP1 INTO @TOTIMPTEMP1, @TOTIMPTEMP1dlls
	
	END
	
	
	CLOSE CUR_DECANUALTIMPTEMP1
	DEALLOCATE CUR_DECANUALTIMPTEMP1
end
else
begin
		UPDATE DECANUALPPS
		SET DAP_IMPTEMPMAT=0,  DAP_IMPTEMPMATUSD= 0
		WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO

end



























GO
