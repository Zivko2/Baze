SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO


/* inserta en la tabla TempBOM_CALCULABASE  los del nivel 1 el bom  para calculo de costos y calculo de aranceles*/
CREATE PROCEDURE [dbo].[SP_FILL_BOMRep] (@BST_PT Int, @bst_entravigor varchar(10), @SPI_CODIGO int, @MENSAJE1 char(1)='N' output)   as

SET NOCOUNT ON 
declare @BST_HIJO int, @BST_INCORPOR decimal(38,6), @BST_DISCH char(1), @TI_CODIGO char(1), @ME_CODIGO int, @Factconv decimal(28,14), 
    @BST_PERINI datetime, @BST_PERFIN datetime, @ME_GEN int, @BST_TRANS char(1), @BST_TIPOCOSTO char(1), 
    @MA_TIP_ENS char(1), @CF_USATIPOADQUISICION char(1), @CF_NIVELES  int, @PA_CODIGO int, @maxbst int,
@bst_perini2 datetime, @BST_CODIGO int, @BST_CODIGOPT int, @bst_tipo char(1), @bm_codigo int



set @MENSAJE1='N'
SELECT     @CF_NIVELES = CF_NIVELES
FROM         dbo.CONFIGURACION



DELETE FROM BOM_REP WHERE BST_PT = @BST_PT


			INSERT INTO BOM_REP (BST_HIJO, BST_INCORPOR, BST_DISCH, TI_CODIGO,  ME_CODIGO, FACTCONV, 
				BST_PERINI, BST_PERFIN, ME_GEN, BST_TRANS, BST_TIPOCOSTO, MA_TIP_ENS, PA_CODIGO, 
				BST_CODIGO, BST_NIVEL, BST_PERTENECE, BST_PT, BST_ENTRAVIGOR, bst_tipo, SPI_CODIGO, SPI_PT)


			SELECT     dbo.BOM_STRUCT.BST_HIJO, SUM(dbo.BOM_STRUCT.BST_INCORPOR) AS BST_INCORPOR, dbo.BOM_STRUCT.BST_DISCH, 
			                      dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, 
			                      dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, 
			                      dbo.BOM_STRUCT.BST_TIP_ENS,
				        dbo.MAESTRO.PA_ORIGEN, max(dbo.BOM_STRUCT.BST_CODIGO), 1, @BST_PT, @BST_PT, @BST_ENTRAVIGOR, 'C', 
				     CASE WHEN dbo.CONFIGURATIPO.CFT_TIPO<>'P' and dbo.CONFIGURATIPO.CFT_TIPO<>'S' THEN 22 ELSE @SPI_CODIGO END, @SPI_CODIGO
			FROM         dbo.BOM_STRUCT LEFT OUTER JOIN
			                      dbo.MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = dbo.MAESTRO.MA_CODIGO LEFT OUTER JOIN
			                      dbo.CONFIGURATIPO ON dbo.MAESTRO.TI_CODIGO = dbo.CONFIGURATIPO.TI_CODIGO
			WHERE (dbo.CONFIGURATIPO.CFT_TIPO<>'P' and dbo.CONFIGURATIPO.CFT_TIPO<>'S') and dbo.BOM_STRUCT.BST_TIP_ENS='C'
			GROUP BY dbo.BOM_STRUCT.BST_HIJO, dbo.BOM_STRUCT.BST_DISCH, dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, 
			                      dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, 
			                      dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, dbo.BOM_STRUCT.BST_TIP_ENS, dbo.BOM_STRUCT.BSU_SUBENSAMBLE, 
			                      dbo.BOM_STRUCT.BST_INCORPOR, dbo.MAESTRO.PA_ORIGEN
			HAVING     (dbo.BOM_STRUCT.BSU_SUBENSAMBLE = @BST_PT) 
			AND dbo.BOM_STRUCT.BST_HIJO IS NOT NULL AND (dbo.BOM_STRUCT.BST_PERINI <=  @BST_ENTRAVIGOR and dbo.BOM_STRUCT.BST_PERFIN>=  @BST_ENTRAVIGOR)
			AND dbo.BOM_STRUCT.BST_INCORPOR >0
			ORDER BY dbo.BOM_STRUCT.BST_HIJO


declare CUR_BOMSTRUCT cursor for

SELECT     dbo.BOM_STRUCT.BST_HIJO, SUM(dbo.BOM_STRUCT.BST_INCORPOR) AS BST_INCORPOR, dbo.BOM_STRUCT.BST_DISCH, 
                      dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, 
                      dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, 
                      dbo.BOM_STRUCT.BST_TIP_ENS,
	       dbo.MAESTRO.PA_ORIGEN, max(dbo.BOM_STRUCT.BST_CODIGO)
FROM         dbo.BOM_STRUCT LEFT OUTER JOIN
                      dbo.MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = dbo.MAESTRO.MA_CODIGO LEFT OUTER JOIN
                      dbo.CONFIGURATIPO ON dbo.MAESTRO.TI_CODIGO = dbo.CONFIGURATIPO.TI_CODIGO
WHERE (dbo.CONFIGURATIPO.CFT_TIPO='P' OR dbo.CONFIGURATIPO.CFT_TIPO='S') AND dbo.BOM_STRUCT.BST_TIP_ENS<>'P'
GROUP BY dbo.BOM_STRUCT.BST_HIJO, dbo.BOM_STRUCT.BST_DISCH, dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, 
                      dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, 
                      dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, dbo.BOM_STRUCT.BST_TIP_ENS, dbo.BOM_STRUCT.BSU_SUBENSAMBLE, 
                      dbo.BOM_STRUCT.BST_INCORPOR, dbo.MAESTRO.PA_ORIGEN
HAVING     (dbo.BOM_STRUCT.BSU_SUBENSAMBLE = @BST_PT) 
AND dbo.BOM_STRUCT.BST_HIJO IS NOT NULL AND (dbo.BOM_STRUCT.BST_PERINI <=  @BST_ENTRAVIGOR and dbo.BOM_STRUCT.BST_PERFIN>=  @BST_ENTRAVIGOR)
AND dbo.BOM_STRUCT.BST_INCORPOR >0
ORDER BY dbo.BOM_STRUCT.BST_HIJO


 OPEN CUR_BOMSTRUCT


	FETCH NEXT FROM CUR_BOMSTRUCT INTO @BST_HIJO, @BST_INCORPOR, @BST_DISCH, @TI_CODIGO, 			
	@ME_CODIGO, @FACTCONV, @BST_PERINI, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO,
	@MA_TIP_ENS, @PA_CODIGO, @BST_CODIGO

  WHILE (@@fetch_status = 0) 

  BEGIN  


	set @bst_tipo='P'

	begin


			insert into BOM_REP(BST_CODIGO, BST_PT,  BST_CODIGOPT, bst_tipo, BST_ENTRAVIGOR, BST_HIJO, BST_INCORPOR, 
			    BST_DISCH, TI_CODIGO, ME_CODIGO, FACTCONV, BST_PERINI, BST_PERFIN, ME_GEN, 
			    BST_TRANS, BST_TIPOCOSTO, MA_TIP_ENS, BST_NIVEL, BST_PERTENECE, 				    
				PA_CODIGO, SPI_CODIGO, SPI_PT)
			values
			(@BST_CODIGO , @BST_PT, @BST_CODIGOPT, @bst_tipo, @BST_ENTRAVIGOR, @BST_HIJO, @BST_INCORPOR, @BST_DISCH, @TI_CODIGO, @ME_CODIGO, @FACTCONV, @BST_PERINI, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO, @MA_TIP_ENS, 1, @BST_PT, @PA_CODIGO, @SPI_CODIGO, @SPI_CODIGO)


			exec  SP_FILL_BOMRep1 @BST_PT, @BST_HIJO, @BST_ENTRAVIGOR, @BST_PERINI, @BST_INCORPOR, @CF_NIVELES, 1, @BST_CODIGOPT, @SPI_CODIGO, @MENSAJE=@MENSAJE1 OUTPUT

			if @MENSAJE1='S'
			begin				
				--print @MENSAJE1
				break
			end
	


	end



	FETCH NEXT FROM CUR_BOMSTRUCT INTO @BST_HIJO, @BST_INCORPOR, @BST_DISCH, @TI_CODIGO, 			
	@ME_CODIGO, @FACTCONV, @BST_PERINI, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO,
	@MA_TIP_ENS, @PA_CODIGO, @BST_CODIGO

END

	CLOSE CUR_BOMSTRUCT
	DEALLOCATE CUR_BOMSTRUCT





UPDATE    BOM_REP
SET     BOM_REP.BST_HIJO = DESVIACION.MA_CODIGONVO
FROM         DESVIACION INNER JOIN
              MAESTRO MAESTRO_1 ON MAESTRO_1.MA_NOPARTE = DESVIACION.MA_NOPARTEORIG INNER JOIN
              BOM_REP ON MAESTRO_1.MA_CODIGO = BOM_REP.BST_HIJO INNER JOIN
              MAESTRO MAESTRO_2 ON BOM_REP.BST_PT = MAESTRO_2.MA_CODIGO AND 
              MAESTRO_2.MA_NOPARTE = DESVIACION.MA_NOPARTEPADRE
WHERE     (DESVIACION.DEV_FECHAINI <= @bst_entravigor) AND (DESVIACION.DEV_FECHAFIN >= @bst_entravigor)
and DESVIACION.DEV_CANTIDAD = 0 and DESVIACION.DEV_HABILITADO='S'
and isnull(DESVIACION.MA_NOPARTEPADRE,'')<>''  and DESVIACION.DEV_TIPOSUST='I'

-- por periodo padre empieza con
UPDATE    BOM_REP
SET     BOM_REP.BST_HIJO = DESVIACION.MA_CODIGONVO
FROM         DESVIACION INNER JOIN
              MAESTRO MAESTRO_1 ON MAESTRO_1.MA_NOPARTE = DESVIACION.MA_NOPARTEORIG INNER JOIN
              BOM_REP ON MAESTRO_1.MA_CODIGO = BOM_REP.BST_HIJO INNER JOIN
              MAESTRO MAESTRO_2 ON BOM_REP.BST_PT = MAESTRO_2.MA_CODIGO AND 
              MAESTRO_2.MA_NOPARTE LIKE DESVIACION.MA_NOPARTEPADRE+'%'
WHERE     (DESVIACION.DEV_FECHAINI <= @bst_entravigor) AND (DESVIACION.DEV_FECHAFIN >= @bst_entravigor)
and DESVIACION.DEV_CANTIDAD = 0 and DESVIACION.DEV_HABILITADO='S'
and isnull(DESVIACION.MA_NOPARTEPADRE,'')<>''  and DESVIACION.DEV_TIPOSUST='P'


-- por periodo hijo empieza con
UPDATE    BOM_REP
SET     BOM_REP.BST_HIJO = DESVIACION.MA_CODIGONVO
FROM         DESVIACION INNER JOIN
              MAESTRO MAESTRO_1 ON MAESTRO_1.MA_NOPARTE LIKE DESVIACION.MA_NOPARTEORIG+'%' INNER JOIN
              BOM_REP ON MAESTRO_1.MA_CODIGO = BOM_REP.BST_HIJO INNER JOIN
              MAESTRO MAESTRO_2 ON BOM_REP.BST_PT = MAESTRO_2.MA_CODIGO AND 
              MAESTRO_2.MA_NOPARTE = DESVIACION.MA_NOPARTEPADRE
WHERE     (DESVIACION.DEV_FECHAINI <= @bst_entravigor) AND (DESVIACION.DEV_FECHAFIN >= @bst_entravigor)
and DESVIACION.DEV_CANTIDAD = 0 and DESVIACION.DEV_HABILITADO='S'
and isnull(DESVIACION.MA_NOPARTEPADRE,'')<>''  and DESVIACION.DEV_TIPOSUST='H'



-- por periodo ambos empieza con
UPDATE    BOM_REP
SET     BOM_REP.BST_HIJO = DESVIACION.MA_CODIGONVO
FROM         DESVIACION INNER JOIN
              MAESTRO MAESTRO_1 ON MAESTRO_1.MA_NOPARTE LIKE DESVIACION.MA_NOPARTEORIG+'%' INNER JOIN
              BOM_REP ON MAESTRO_1.MA_CODIGO = BOM_REP.BST_HIJO INNER JOIN
              MAESTRO MAESTRO_2 ON BOM_REP.BST_PT = MAESTRO_2.MA_CODIGO AND 
              MAESTRO_2.MA_NOPARTE LIKE DESVIACION.MA_NOPARTEPADRE+'%'
WHERE     (DESVIACION.DEV_FECHAINI <= @bst_entravigor) AND (DESVIACION.DEV_FECHAFIN >= @bst_entravigor)
and DESVIACION.DEV_CANTIDAD = 0 and DESVIACION.DEV_HABILITADO='S'
and isnull(DESVIACION.MA_NOPARTEPADRE,'')<>''  and DESVIACION.DEV_TIPOSUST='A'



	exec SP_ACTUALIZATIPOCOSTOBOMREP @spi_codigo, @BST_PT


	UPDATE    BOM_REP
	SET PA_ORIGEN = PA_CODIGO
	WHERE BST_PT = @BST_PT
	
	UPDATE    BOM_REP
	SET PA_ORIGEN =isnull((SELECT min(CERTORIGMPDET.PA_CLASE)
		 FROM  CERTORIGMPDET INNER JOIN CERTORIGMP ON CERTORIGMPDET.CMP_CODIGO = CERTORIGMP.CMP_CODIGO
		 WHERE CERTORIGMP.CMP_TIPO<> 'P' and LEFT(REPLACE(CERTORIGMPDET.CMP_FRACCION,'.',''),6) IN 
					(SELECT LEFT(REPLACE(A1.AR_FRACCION,'.',''),6) FROM ARANCEL A1 WHERE AR_CODIGO=MAESTRO.AR_IMPFO) 
		  AND CERTORIGMP.CMP_ESTATUS='V' AND CERTORIGMPDET.MA_CODIGO  = BOM_REP.BST_HIJO
		  AND  CERTORIGMP.SPI_CODIGO IN (SELECT spi_codigo FROM spi  WHERE spi_clave = 'NAFTA') 
		  AND CERTORIGMP.CMP_IFECHA<=@bst_entravigor AND CERTORIGMP.CMP_FECHATRANS>=@bst_entravigor) ,BOM_REP.PA_ORIGEN)
	FROM  BOM_REP INNER JOIN MAESTRO ON BOM_REP.BST_HIJO=MAESTRO.MA_CODIGO
	WHERE BST_PT = @BST_PT



	UPDATE    BOM_REP
	SET BSR_DEF_TIP = MA_DEF_TIP
	FROM BOM_REP INNER JOIN MAESTRO  ON BOM_REP.BST_HIJO = MAESTRO.MA_CODIGO
	WHERE BST_PT = @BST_PT




	UPDATE    BOM_REP
	SET BSR_DEF_TIP = (CASE WHEN EXISTS(SELECT CERTORIGMPDET.PA_CLASE
		 FROM  CERTORIGMPDET INNER JOIN CERTORIGMP ON CERTORIGMPDET.CMP_CODIGO = CERTORIGMP.CMP_CODIGO
		 WHERE CERTORIGMP.CMP_TIPO<> 'P' and LEFT(REPLACE(CERTORIGMPDET.CMP_FRACCION,'.',''),6) IN 
					(SELECT LEFT(REPLACE(A1.AR_FRACCION,'.',''),6) FROM ARANCEL A1 WHERE AR_CODIGO=MAESTRO.AR_IMPFO) 
		  AND CERTORIGMP.CMP_ESTATUS='V' AND CERTORIGMPDET.MA_CODIGO  = BOM_REP.BST_HIJO
		  AND  CERTORIGMP.SPI_CODIGO IN (SELECT spi_codigo FROM spi  WHERE spi_clave = 'NAFTA') 
		  AND CERTORIGMP.CMP_IFECHA<=@bst_entravigor AND CERTORIGMP.CMP_FECHATRANS>=@bst_entravigor) THEN 'P' ELSE ( CASE WHEN MA_DEF_TIP='P' THEN 'G' ELSE MA_DEF_TIP END) END)
	FROM  BOM_REP INNER JOIN MAESTRO ON BOM_REP.BST_HIJO=MAESTRO.MA_CODIGO
	WHERE BST_PT = @BST_PT


---------------------------
IF exists(select * from sysobjects where name='TempBomRepCostos1')
	  	 drop table TempBomRepCostos1

---06/FEB/2009
	SELECT     dbo.MAESTROCOST.MAC_CODIGO, dbo.MAESTROCOST.TCO_CODIGO, dbo.MAESTROCOST.MA_CODIGO, dbo.MAESTROCOST.MA_GRAV_MP, dbo.MAESTROCOST.MA_GRAV_ADD, 
	                      dbo.MAESTROCOST.MA_GRAV_EMP, dbo.MAESTROCOST.MA_GRAV_GI, dbo.MAESTROCOST.MA_GRAV_GI_MX, dbo.MAESTROCOST.MA_GRAV_MO, 
	                      dbo.MAESTROCOST.MA_NG_MP, dbo.MAESTROCOST.MA_NG_ADD, dbo.MAESTROCOST.MA_NG_EMP, dbo.MAESTROCOST.MA_COSTO, 
	                      dbo.MAESTROCOST.MA_GRAVA_VA, dbo.MAESTROCOST.MA_NG_USA, dbo.MAESTROCOST.MA_NG_MX, dbo.MAESTROCOST.TV_CODIGO, 
	                      isnull(dbo.MAESTRO.MA_NOPARTE, dbo.MAESTROREFER.MA_NOPARTE) as MA_NOPARTE, isnull(dbo.MAESTRO.MA_NOPARTEAUX,dbo.MAESTROREFER.MA_NOPARTEAUX) as MA_NOPARTEAUX, dbo.MAESTROCOST.SPI_CODIGO
	into TempBomRepCostos1
	FROM         dbo.MAESTROREFER LEFT OUTER JOIN
	                      dbo.CONFIGURATIPO CONFIGURATIPO_1 ON dbo.MAESTROREFER.TI_CODIGO = CONFIGURATIPO_1.TI_CODIGO RIGHT OUTER JOIN
	                      dbo.MAESTROCOST ON dbo.MAESTROREFER.MA_CODIGO = dbo.MAESTROCOST.MA_CODIGO LEFT OUTER JOIN
	                      dbo.CONFIGURATIPO RIGHT OUTER JOIN
	                      dbo.MAESTRO ON dbo.CONFIGURATIPO.TI_CODIGO = dbo.MAESTRO.TI_CODIGO ON 
	                      dbo.MAESTROCOST.MA_CODIGO = dbo.MAESTRO.MA_CODIGO
	WHERE     ((((isnull(dbo.CONFIGURATIPO.CFT_TIPO,CONFIGURATIPO_1.CFT_TIPO) <> 'P' AND isnull(dbo.CONFIGURATIPO.CFT_TIPO,CONFIGURATIPO_1.CFT_TIPO) <> 'S') OR dbo.MAESTRO.MA_TIP_ENS = 'C') AND
	dbo.MAESTROCOST.TCO_CODIGO IN (SELECT TCO_COMPRA FROM CONFIGURACION)) OR
	(((isnull(dbo.CONFIGURATIPO.CFT_TIPO,CONFIGURATIPO_1.CFT_TIPO) = 'P' OR isnull(dbo.CONFIGURATIPO.CFT_TIPO,CONFIGURATIPO_1.CFT_TIPO) = 'S') AND dbo.MAESTRO.MA_TIP_ENS<>'C'))
	AND dbo.MAESTROCOST.TCO_CODIGO IN (SELECT TCO_MANUFACTURA FROM CONFIGURACION))
	AND (isnull(dbo.MAESTRO.MA_INV_GEN,'I') = 'I') AND (dbo.MAESTROCOST.MA_PERINI <= convert(varchar(11),@bst_entravigor,101))
	AND (dbo.MAESTROCOST.MA_PERFIN >= convert(varchar(11),@bst_entravigor,101)) 

---------------------------
---Actualizar costos

	UPDATE BOM_REP
	SET 	BSR_GRAV_MP=CT.MA_GRAV_MP,
		BSR_GRAV_ADD=CT.MA_GRAV_ADD,
		BSR_GRAV_EMP=CT.MA_GRAV_EMP,
		BSR_GRAV_GI=CT.MA_GRAV_GI,
		BSR_GRAV_GI_MX=CT.MA_GRAV_GI_MX,
		BSR_GRAV_MO=CT.MA_GRAV_MO,
		BSR_NG_ADD=CT.MA_NG_ADD,
		BSR_NG_EMP=CT.MA_NG_EMP,
		BSR_COSTO=CT.MA_COSTO
	FROM BOM_REP INNER JOIN  (SELECT  TempBomRepCostos1.MA_CODIGO, MA_GRAV_MP, MA_GRAV_ADD, MA_GRAV_EMP, MA_GRAV_GI, 
			      MA_GRAV_GI_MX, MA_GRAV_MO, MA_NG_MP, 
	                      	     MA_NG_ADD, MA_NG_EMP, MA_COSTO, MA_NG_USA, MA_NG_MX, SPI_CODIGO
				FROM  TempBomRepCostos1 
				INNER JOIN  (SELECT MAX(MC2.MAC_CODIGO) AS MAC_CODIGO, MC2.MA_CODIGO
	                        FROM  TempBomRepCostos1 MC2 GROUP BY MC2.MA_CODIGO) MC2 
	ON MC2.MA_CODIGO=TempBomRepCostos1.MA_CODIGO AND MC2.MAC_CODIGO=TempBomRepCostos1.MAC_CODIGO
	WHERE SPI_CODIGO=@SPI_CODIGO) CT ON BOM_REP.BST_HIJO=CT.MA_CODIGO
	WHERE BST_PT=@BST_PT
	----------------------------

	---Elimina la tabla temporal 
	IF exists(select * from sysobjects where name='TempBomRepCostos1')
	  	 drop table TempBomRepCostos1

GO
