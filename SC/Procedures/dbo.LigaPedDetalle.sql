SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[LigaPedDetalle] (@picodigo int)   as

declare @CCP_TIPO varchar(5), @CCP_TIPO2 varchar(5), @cp_rectifica int, @PICF_SAAIDETDIVPO varchar(5), @cp_clave varchar(2), @cp_claveOriginal varchar(2)


	SELECT @CCP_TIPO=CCP_TIPO FROM CONFIGURACLAVEPED WHERE CP_CODIGO
	IN (SELECT CP_CODIGO FROM PEDIMP WHERE PI_CODIGO=@picodigo)

	SELECT @PICF_SAAIDETDIVPO=PICF_SAAIDETDIVPO  FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo

	select @cp_rectifica=cp_rectifica from pedimp where pi_codigo=@picodigo

	select @cp_clave = cp_clave from pedimp left outer join claveped on pedimp.cp_codigo = claveped.cp_codigo
	where pi_codigo=@picodigo


	select @ccp_tipo2=ccp_tipo from configuraclaveped where cp_codigo=@cp_rectifica

	select @cp_claveOriginal = cp_clave from pedimp left outer join claveped on pedimp.cp_codigo = claveped.cp_codigo
	where pi_codigo in (select pi_rectifica from pedimp where pi_codigo = @picodigo)


	IF @CCP_TIPO<>'CN' OR ((select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo )<>'S' AND @CCP_TIPO='CN')
	IF (SELECT PI_MOVIMIENTO FROM PEDIMP WHERE PI_CODIGO=@picodigo)='S' or @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4','F5','P1') --Se agrego que valide los cambios de regimen para que entre con facturas de exportacion.
	begin
		IF (SELECT PICF_PEDIMPSINAGRUP FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'--  no se hace ninguna agrupacion
		begin
			-- En el campo PID_CODIGOFACT se guarda temporalmente el fid_indiced
				if @ccp_tipo<>'RE'
				begin
	
					UPDATE FACTEXPDET
					SET     FACTEXPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
	 				FROM         FACTEXPDET INNER JOIN
		  	                            PEDIMPDET ON FACTEXPDET.FED_INDICED = PEDIMPDET.PID_CODIGOFACT 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
	
					UPDATE PEDIMPDET 
					SET     PEDIMPDET.PID_CODIGOFACT =FACTEXPDET.FE_CODIGO
	 				FROM         FACTEXPDET INNER JOIN
		  	                            PEDIMPDET ON FACTEXPDET.PID_INDICEDLIGA = PEDIMPDET.PID_INDICED 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
				end
				else
				begin
	
					UPDATE FACTEXPDET
					SET     FACTEXPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
	 				FROM         FACTEXPDET INNER JOIN
		  	                            PEDIMPDET ON FACTEXPDET.FED_INDICED = PEDIMPDET.PID_CODIGOFACT 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
	
					UPDATE PEDIMPDET 
					SET     PEDIMPDET.PID_CODIGOFACT =FACTEXPDET.FE_CODIGO
	 				FROM         FACTEXPDET INNER JOIN
		  	                            PEDIMPDET ON FACTEXPDET.PID_INDICEDLIGAR1 = PEDIMPDET.PID_INDICED 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
				end
		end
		else
		begin
		
			if (select cf_pagocontribucion from configuracion)='J'
			begin
			
				IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
				begin
					if @PICF_SAAIDETDIVPO='S'
					begin
						if @ccp_tipo<>'RE'
						begin
							--se agrego para cuando sea Cambio de Regimen 26-Ene-11 Manuel G.
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1') 
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP			
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)

							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP			
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'D' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN =
								 (case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									 (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) end)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'D' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
									(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
			                                                                           (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END)end)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
	
					end
					else
					begin
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE  ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'D' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE  ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN =
									(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									 (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'D' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
									(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
			                                                                           (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
	
					end
				end
				else -- else de CF_SAAIDETDIVFACT
				begin
					if @PICF_SAAIDETDIVPO='S'
					begin
	
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin	
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=			
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN =
									(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									 (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin	
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
					end
					else
					begin
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=			
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN =
									(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									 (case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4','F5','P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
	
					end
				end
			end
			else -- hace el pago en ct
			begin
				IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
				begin
					if @PICF_SAAIDETDIVPO='S'
					begin
	
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
	
					end
					else
					begin
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
						else
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
							else
							begin	
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.FE_CODIGO, 0) = ISNULL(PEDIMPDET.PID_CODIGOFACT, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
							end
						end
	
	
	
					end
				end
				else-- else de CF_SAAIDETDIVFACT
				begin
					if @PICF_SAAIDETDIVPO='S'
					begin
	
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET FACTEXPDET.PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      	PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO	
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233) 
								--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo							end
							else
							begin	
								UPDATE FACTEXPDET
								SET FACTEXPDET.PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      	PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=			
								PEDIMPDET.PID_DEF_TIP LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO	
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233) 
								--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
			
							--PRINT 'SI ENTRA A LA RELACION ----------------------------------------------------------------------'
						end
						else
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
	      					    		--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
							else
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								AND isnull(FACTEXPDET.FED_ORD_COMP,'')= PEDIMPDET.PID_ORD_COMP
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
	      					    		--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
						end
					end
					else
					begin
						if @ccp_tipo<>'RE'
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET FACTEXPDET.PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN
						                      	PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo 
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO	
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
								--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
							else
							begin
								if (select CF_PEDDESPKG from configuracion) = 'S'
									begin
										UPDATE FACTEXPDET
										SET FACTEXPDET.PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
										FROM         FACTEXPDET INNER JOIN
						                      			PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
										AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
										--estas lineas no se comparan ya que por la configuracion se convierte a KG y la unidad y grupo generico  no coinciden
										--AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
										--AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
										AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
										AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
										AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
										INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
										AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=			
										PEDIMPDET.PID_DEF_TIP LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
										INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
										(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
											(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
										WHERE PEDIMPDET.PI_CODIGO=@picodigo 
										AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO	
										AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
										--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
										and pedimpdet.pid_codigofact = factexp.fe_codigo
									end
								else
									begin
										UPDATE FACTEXPDET
										SET FACTEXPDET.PID_INDICEDLIGA= PEDIMPDET.PID_INDICED
										FROM         FACTEXPDET INNER JOIN
						                      			PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
										AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
										AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
										AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
										AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
										AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
										AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
										INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_CODIGO AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
										AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=			
										PEDIMPDET.PID_DEF_TIP LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
										INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
										(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
											(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
										WHERE PEDIMPDET.PI_CODIGO=@picodigo 
										AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO	
										AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
										--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
										and pedimpdet.pid_codigofact = factexp.fe_codigo
									end
							end
							--PRINT 'SI ENTRA A LA RELACION ----------------------------------------------------------------------'
						end
						else
						begin
							if @cp_clave in ('F4', 'F5', 'P1') or @cp_claveOriginal in ('F4', 'F5', 'P1')
							begin
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
								--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
							else
							begin	
								UPDATE FACTEXPDET
								SET PID_INDICEDLIGAR1= PEDIMPDET.PID_INDICED
								FROM         FACTEXPDET INNER JOIN	
						                      PEDIMPDET ON FACTEXPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTEXPDET.FED_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTEXPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTEXPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTEXPDET.AR_EXPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTEXPDET.FED_RATEIMPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTEXPDET.SE_CODIGO, 0) = ISNULL(PEDIMPDET.SE_CODIGO, 0) 
								INNER JOIN FACTEXP ON PEDIMPDET.PI_CODIGO = FACTEXP.PI_RECTIFICA AND FACTEXPDET.FE_CODIGO = FACTEXP.FE_CODIGO
								AND (CASE WHEN FACTEXP.TQ_CODIGO IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO = 'D') THEN 'S' ELSE 'N' END)=
								PEDIMPDET.PID_DEF_TIP
								LEFT OUTER JOIN DIR_CLIENTE ON FACTEXP.DI_DESTINI = DIR_CLIENTE.DI_INDICE 
								INNER JOIN DIR_CLIENTE DIR_CLIENTE_1 ON FACTEXP.DI_DESTFIN = DIR_CLIENTE_1.DI_INDICE AND PEDIMPDET.PA_ORIGEN = 
								(case when @ccp_tipo='CN' AND (select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo)='S' then FACTEXPDET.PA_CODIGO ELSE
									(case when dbo.FACTEXP.FE_TIPO ='V' THEN (select max(pa_codigo) from pais where pa_corto='MX') ELSE (case when dbo.FACTEXP.TN_CODIGO in (select tn_codigo from tenvio where tn_descrip='inbond') and DIR_CLIENTE_1.PA_CODIGO in (select max(pa_codigo) from pais where pa_corto='MX') then (select max(pa_codigo) from pais where pa_corto='USA') else DIR_CLIENTE_1.PA_CODIGO end) END) END)
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND (CASE WHEN FED_DEF_TIP<>'P' OR FE_TIPO<>'V' THEN 0 ELSE FACTEXPDET.SPI_CODIGO END)=PEDIMPDET.SPI_CODIGO
								AND isnull(PEDIMPDET.PA_PROCEDE,233) = isnull(DIR_CLIENTE.PA_CODIGO,233)
								--Se agrego condicion de codigos de facturas Manuel G. 12-Sep-2010
								and pedimpdet.pid_codigofact = factexp.fe_codigo
							end
						end
					end
				end
			end
		end
	end
	else -- entradas
	begin
		IF (SELECT PICF_PEDIMPSINAGRUP FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'--  no se hace ninguna agrupacion
		begin
			-- En el campo PID_CODIGOFACT se guarda temporalmente el fid_indiced
				if @ccp_tipo<>'RE'
				begin
	
					UPDATE FACTIMPDET
					SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
	 				FROM         FACTIMPDET INNER JOIN
		  	                            PEDIMPDET ON FACTIMPDET.FID_INDICED = PEDIMPDET.PID_CODIGOFACT 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
	
					UPDATE PEDIMPDET 
					SET     PEDIMPDET.PID_CODIGOFACT =FACTIMPDET.FI_CODIGO
	 				FROM         FACTIMPDET INNER JOIN
		  	                            PEDIMPDET ON FACTIMPDET.PID_INDICEDLIGA = PEDIMPDET.PID_INDICED 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
				end
				else
				begin
					UPDATE FACTIMPDET
					SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
	 				FROM         FACTIMPDET INNER JOIN
		  	                            PEDIMPDET ON FACTIMPDET.FID_INDICED = PEDIMPDET.PID_CODIGOFACT 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
	
					UPDATE PEDIMPDET 
					SET     PEDIMPDET.PID_CODIGOFACT =FACTIMPDET.FI_CODIGO
	 				FROM         FACTIMPDET INNER JOIN
		  	                            PEDIMPDET ON FACTIMPDET.PID_INDICEDLIGAR1 = PEDIMPDET.PID_INDICED 			
					WHERE PEDIMPDET.PI_CODIGO=@picodigo 
	
	
				end
		end
		else
		begin
	
			if (SELECT PICF_SAAIDETDIVPO  FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
			begin
					-- activo fijo, la diferencia es que agrupa por desc. en espanol
					if @ccp_tipo in ('IA', 'IM') or ((select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo) ='S' and @ccp_tipo in ('VT', 'IV', 'EV', 'IE'))
					or (SELECT COUNT(*) FROM FACTIMP INNER JOIN TEMBARQUE ON FACTIMP.TQ_CODIGO = TEMBARQUE.TQ_CODIGO
					     WHERE TEMBARQUE.TQ_NOMBRE LIKE '%CASO ESPECIAL%' AND (FACTIMP.PI_CODIGO = @picodigo or FACTIMP.PI_RECTIFICA = @picodigo))>0
	
					begin
			
			
							IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
							begin
								begin tran			
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
				 				FROM         FACTIMPDET INNER JOIN
					  	                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G') 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
								AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
				
				
				
			
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 	
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
								AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)			
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
				
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
										AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
				
				
							end				
							else
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE 
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
				--				AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI, 0),6,1)
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')		
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
								AND PEDIMPDET.PID_IMPRIMIR ='S' 
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
				
								commit tran
				
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE 
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
				--				AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI*@PI_TIP_CAM, 0),6,1)
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')		
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
								AND PEDIMPDET.PID_IMPRIMIR ='S' 
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and FACTIMP.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
				
				
				
							end
				
				
			
					end
				else
				begin
			
						if @ccp_tipo<>'RE'		
						begin
					
					
								IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
								begin
									begin  tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
					--				AND isnull(FACTIMPDET.FID_NOPARTEAUX,'')=isnull(PEDIMPDET.PID_NOPARTEAUX,'')
									AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
									AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
											else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo
										AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
								end
								else
								begin
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
					--				AND isnull(FACTIMPDET.FID_NOPARTEAUX,'')=isnull(PEDIMPDET.PID_NOPARTEAUX,'')
					 				AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
											else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo
										AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
								end
						end
						else	-- else del <>RE
						begin
				
							-- rectificacion de un pedimento de activo fijo
							if (@ccp_tipo='RE' and @ccp_tipo2 in ('IA', 'IM')) or
							((select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo) ='S' and @ccp_tipo2 in ('VT', 'IV', 'EV', 'IE'))
		
							or (SELECT COUNT(*) FROM FACTIMP INNER JOIN TEMBARQUE ON FACTIMP.TQ_CODIGO = TEMBARQUE.TQ_CODIGO
							     WHERE TEMBARQUE.TQ_NOMBRE LIKE '%CASO ESPECIAL%' AND (FACTIMP.PI_CODIGO = @picodigo or FACTIMP.PI_RECTIFICA = @picodigo))>0
		
							--if exists(select cp_codigo from pedimp where pi_codigo in
							--(select pi_rectifica from pedimp where pi_codigo=@picodigo) and cp_codigo in (select cp_codigo from configuraclaveped where ccp_tipo in ('IA', 'IM')))
							begin		
								IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
								begin
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 				
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
			--						AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI, 0),6,1)
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
				 					AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
			 		 				AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
											else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN
							                            FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
			
			
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 				
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
			--						AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI*@PI_TIP_CAM, 0),6,1)
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
				 					AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
			 		 				AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN
							                            FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran		
					
					
								end
								else
								begin
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
			--						AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI, 0),6,1)
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G') 
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
									AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
											else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)
									commit tran
			
			
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
			--						AND ROUND(ISNULL(FACTIMPDET.FID_COS_UNI, 0),6,1) = ROUND(ISNULL(PEDIMPDET.PID_COS_UNI*@PI_TIP_CAM, 0),6,1)
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
									AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE		
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
			
			
			
			
			
								end
				
				
							end
							else
							begin
					
								IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
								begin
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 		
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
									AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
									AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
								end
								else
								begin
									begin tran
									UPDATE FACTIMPDET
									SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
									FROM         FACTIMPDET INNER JOIN
							                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
									AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
									AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
									AND ISNULL(FACTIMPDET.FID_ORD_COMP, 0) = ISNULL(PEDIMPDET.PID_ORD_COMP, 0) 
									AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
									AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
									AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
									AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
									--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
									AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
									AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
									AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
									AND PEDIMPDET.PID_IMPRIMIR ='S'
									AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
									INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
									WHERE PEDIMPDET.PI_CODIGO=@picodigo
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
									commit tran
								end
							end
						end
				end
	
	
	
	
			end
			else  ------------------------------------------------------------------------------------------------------------------------- con sin PO
			begin
	
				-- activo fijo, la diferencia es que agrupa por desc. en espaol
				if @ccp_tipo in ('IA', 'IM') or ((select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo) ='S' and @ccp_tipo in ('VT', 'IV', 'EV', 'IE'))
				or (SELECT COUNT(*) FROM FACTIMP INNER JOIN TEMBARQUE ON FACTIMP.TQ_CODIGO = TEMBARQUE.TQ_CODIGO
				     WHERE TEMBARQUE.TQ_NOMBRE LIKE '%CASO ESPECIAL%' AND (FACTIMP.PI_CODIGO = @picodigo or FACTIMP.PI_RECTIFICA = @picodigo))>0
	
				begin
		
		
						IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
						begin
							begin tran		
							UPDATE FACTIMPDET
							SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
			 				FROM         FACTIMPDET INNER JOIN
				  	                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
							AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
							AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
							AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
							AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
							AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
							AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
							AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
							AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
							AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
							AND PEDIMPDET.PID_IMPRIMIR ='S'
							INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
							WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
							commit tran
			
			
			
			
			 
			
							begin tran
							UPDATE FACTIMPDET
							SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
							FROM         FACTIMPDET INNER JOIN
					                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
							AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
							AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
							AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
							AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
							AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
							AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 		
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
							AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
							AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
							AND PEDIMPDET.PID_IMPRIMIR ='S'
							AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)		
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
			
							INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
							WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
							commit tran
			
			
						end		
						else
						begin
							begin tran
							UPDATE FACTIMPDET
							SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
							FROM         FACTIMPDET INNER JOIN
					                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
							AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
							AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE 
							INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
							WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
							AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
							AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
							AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
							AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G') 		
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
							AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
							AND PEDIMPDET.PID_IMPRIMIR ='S' 
							AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
								else 'S' end)= PEDIMPDET.PID_DESCARGABLE
							AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
			
							commit tran
			
							begin tran
							UPDATE FACTIMPDET
							SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
							FROM         FACTIMPDET INNER JOIN
					                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
							AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
							AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE 
							AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
							AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
							AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
							AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')		
							AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
							AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
							AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
							AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
							AND PEDIMPDET.PID_IMPRIMIR ='S' 
							AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
							INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
							WHERE PEDIMPDET.PI_CODIGO=@picodigo and FACTIMP.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
							commit tran
			
			
			
						end
			
			
		
				end
			else
			begin
		
					if @ccp_tipo<>'RE'	
					begin
				
				
							IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
							begin
								begin  tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
								AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
							end
							else
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGA =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 			
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')		
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)			
				 				AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_CODIGO AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
									AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
							end
					end
					else	-- else del <>RE
					begin
			
						-- rectificacion de un pedimento de activo fijo
						if (@ccp_tipo='RE' and @ccp_tipo2 in ('IA', 'IM')) or
						((select PI_DESP_EQUIPO from pedimp where pi_codigo=@picodigo) ='S' and @ccp_tipo2 in ('VT', 'IV', 'EV', 'IE'))
						or (SELECT COUNT(*) FROM FACTIMP INNER JOIN TEMBARQUE ON FACTIMP.TQ_CODIGO = TEMBARQUE.TQ_CODIGO
						     WHERE TEMBARQUE.TQ_NOMBRE LIKE '%CASO ESPECIAL%' AND (FACTIMP.PI_CODIGO = @picodigo or FACTIMP.PI_RECTIFICA = @picodigo))>0
		
						--if exists(select cp_codigo from pedimp where pi_codigo in
						--(select pi_rectifica from pedimp where pi_codigo=@picodigo) and cp_codigo in (select cp_codigo from configuraclaveped where ccp_tipo in ('IA', 'IM')))
						begin	
							IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
			 					AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
		 		 				AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN
						                            FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
		
		
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                            PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
			 					AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
		 		 				AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN
						                            FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran	
			
			
							end
							else
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
										else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo not IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)
								commit tran
		
		
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND FACTIMPDET.FID_NOMBRE = PEDIMPDET.PID_NOMBRE
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE	
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo and factimp.mo_codigo IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154)
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
		
		
		
		
		
							end
			
			
						end
						else
						begin
				
							IF (SELECT PICF_SAAIDETDIVFACT FROM PEDIMPSAAICONFIG WHERE PI_CODIGO=@picodigo)='S'
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G') 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
								AND isnull(PEDIMPDET.PID_CODIGOFACT, 0) = isnull(FACTIMPDET.FI_CODIGO, 0)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
							end
							else
							begin
								begin tran
								UPDATE FACTIMPDET
								SET     FACTIMPDET.PID_INDICEDLIGAR1 =PEDIMPDET.PID_INDICED
								FROM         FACTIMPDET INNER JOIN
						                      PEDIMPDET ON FACTIMPDET.MA_CODIGO = PEDIMPDET.MA_CODIGO 
								AND FACTIMPDET.FID_NOPARTE = PEDIMPDET.PID_NOPARTE 
								AND  ISNULL(FACTIMPDET.ME_CODIGO, 0) = ISNULL(PEDIMPDET.ME_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.MA_GENERICO, 0) = ISNULL(PEDIMPDET.MA_GENERICO, 0) 
								AND ISNULL(FACTIMPDET.AR_IMPMX, 0) = ISNULL(PEDIMPDET.AR_IMPMX, 0) 
								AND ISNULL(FACTIMPDET.FID_RATEEXPFO, - 1) = ISNULL(PEDIMPDET.PID_RATEEXPFO, - 1) 
								AND ISNULL(FACTIMPDET.FID_SEC_IMP, 0) = ISNULL(PEDIMPDET.PID_SEC_IMP, 0) 
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 'G' ELSE FACTIMPDET.FID_DEF_TIP END, 'G') = ISNULL(PEDIMPDET.PID_DEF_TIP, 'G')
								AND ISNULL(CASE WHEN FACTIMPDET.FID_DEF_TIP = 'E' THEN 0 ELSE FACTIMPDET.FID_POR_DEF END,-1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 
								--AND ISNULL(FACTIMPDET.FID_POR_DEF, - 1) = ISNULL(PEDIMPDET.PID_POR_DEF, - 1) 			
								AND ISNULL(FACTIMPDET.PA_CODIGO, 0) = ISNULL(PEDIMPDET.PA_ORIGEN, 0) 
								AND ISNULL(FACTIMPDET.SPI_CODIGO, 0) = ISNULL(PEDIMPDET.SPI_CODIGO, 0) 
								AND ISNULL(FACTIMPDET.CS_CODIGO, 8) = isnull(PEDIMPDET.CS_CODIGO ,8)
								AND PEDIMPDET.PID_IMPRIMIR ='S'
								AND (case when FID_PADREKITINSERT='N' then (case when isnull(FACTIMPDET.CS_CODIGO,8)=2 then 'N' else 'S' end)
									else 'S' end)= PEDIMPDET.PID_DESCARGABLE
								INNER JOIN FACTIMP ON PEDIMPDET.PI_CODIGO = FACTIMP.PI_RECTIFICA AND FACTIMPDET.FI_CODIGO = FACTIMP.FI_CODIGO
								WHERE PEDIMPDET.PI_CODIGO=@picodigo
								AND PEDIMPDET.PA_PROCEDE = isnull((SELECT DIR_CLIENTE.PA_CODIGO FROM DIR_CLIENTE WHERE DI_INDICE=FACTIMP.DI_PROVEE),233)			
								commit tran
							end
						end
					end
				end
			end
	
	
		end

	end


	exec sp_ligacorrecta @picodigo

GO
