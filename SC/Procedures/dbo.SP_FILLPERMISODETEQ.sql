SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO































CREATE PROCEDURE [dbo].[SP_FILLPERMISODETEQ] @pecodigo INT    as

SET NOCOUNT ON 
DECLARE @PED_INDICED INT, @PED_REGISTROTIPO SMALLINT, @MA_GENERICO INT , @MA_NOPARTE varchar(30),
  @PED_NOMBRE VARCHAR(150), @TI_CODIGO INT, @ME_COM INT , @AR_EXPMX INT , @PED_ID_SUBORD INT , @VALUE INT, @CONSECUTIVO INT


DELETE FROM PERMISODET WHERE PE_CODIGO=@pecodigo AND PED_REGISTROTIPO=4

DECLARE CUR_PERMISO CURSOR FOR
	SELECT 4 AS PED_REGISTROTIPO, CPE_CODIGO, CPE_CORTO, CPE_DESC, 
	    CATEGPERMISO.TI_CODIGO, ME_CODIGO, AR_CODIGO, 0 AS PED_ID_SUBORD
	FROM CATEGPERMISO LEFT OUTER JOIN CONFIGURATIPO ON CATEGPERMISO.TI_CODIGO = CONFIGURATIPO.TI_CODIGO
	WHERE (CONFIGURATIPO.CFT_TIPO = ('Q')) AND (CATEGPERMISO.IDE_CODIGO IS NULL OR  CATEGPERMISO.IDE_CODIGO IN 
			(SELECT IDE_CODIGO FROM IDENTIFICA WHERE IDE_CLAVE='MQ' OR IDE_CLAVE='PX'))
		AND CPE_CODIGO IN (SELECT CPE_CODIGO FROM MAESTROCATEG)
OPEN CUR_PERMISO
FETCH NEXT FROM CUR_PERMISO INTO @PED_REGISTROTIPO, @MA_GENERICO, @MA_NOPARTE,
 @PED_NOMBRE, @TI_CODIGO, @ME_COM, @AR_EXPMX, @PED_ID_SUBORD

SELECT @CONSECUTIVO=ISNULL(MAX(PED_CONSECUTIVO),0) FROM PERMISODET -- WHERE PE_CODIGO=@pecodigo AND PED_REGISTROTIPO=4

SET @CONSECUTIVO=@CONSECUTIVO+1



WHILE (@@FETCH_STATUS = 0)
BEGIN
	EXEC  SP_GETCONSECUTIVO 'PED', @VALUE = @PED_INDICED OUTPUT

		INSERT INTO PERMISODET(PED_INDICED, PE_CODIGO, PED_REGISTROTIPO, MA_GENERICO, MA_NOPARTE,
					PED_NOMBRE, TI_CODIGO, ME_COM, AR_IMPMX, PED_ID_SUBORD, PED_CONSECUTIVO)
	VALUES
		(@PED_INDICED, @PECODIGO, @PED_REGISTROTIPO, @MA_GENERICO, @MA_NOPARTE, @PED_NOMBRE,
                   @TI_CODIGO, @ME_COM, @AR_EXPMX, @PED_ID_SUBORD, @CONSECUTIVO)

	FETCH NEXT FROM CUR_PERMISO INTO @PED_REGISTROTIPO, @MA_GENERICO, @MA_NOPARTE , @PED_NOMBRE, 
					@TI_CODIGO, @ME_COM, @AR_EXPMX , @PED_ID_SUBORD

END



CLOSE CUR_PERMISO
DEALLOCATE CUR_PERMISO


select @Ped_indiced= max(ped_indiced) from permisodet

	update consecutivo
	set cv_codigo =  isnull(@ped_indiced,0) + 1
	where cv_tipo = 'PED'



























GO
