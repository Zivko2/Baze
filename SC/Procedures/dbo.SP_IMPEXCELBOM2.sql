SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_IMPEXCELBOM2]   as

SET NOCOUNT ON 

DELETE FROM IMPORTLOG WHERE IML_CBFORMA=-18
if (select count(*) from IMPORTLOG)=0
DBCC CHECKIDENT (IMPORTLOG, RESEED, 0) WITH NO_INFOMSGS

	delete from IMPEXCELBOM2 where NOPARTE=''
	INSERT INTO IMPORTLOG (IML_MENSAJE, IML_CBFORMA) 
	SELECT 'NO SE PUEDE IMPORTAR NO. DE PARTE : '+NOPARTEPADRE 
	+' PORQUE NO
		SE ENCUENTRA EN EL CATALOGO MAESTRO O ESTA ACTIVO', -18
	FROM IMPEXCELBOM2
	WHERE NOPARTEPADRE NOT IN
	(SELECT MA_NOPARTE FROM MAESTRO WHERE MA_INV_GEN = 'I' 
	                                             AND MA_EST_MAT = 'A') 

	INSERT INTO IMPORTLOG (IML_MENSAJE, IML_CBFORMA) 
	SELECT 'NO SE PUEDE IMPORTAR NO. DE PARTE : '+NOPARTE +' PORQUE NO
		SE ENCUENTRA EN EL CATALOGO MAESTRO O ESTA ACTIVO', -18
	FROM IMPEXCELBOM2
	WHERE NOPARTE NOT IN
	(SELECT MA_NOPARTE FROM MAESTRO WHERE MA_INV_GEN = 'I' 
	                                             AND MA_EST_MAT = 'A') 
/* se ejecutan los procedimientos para llenar la estructura */
	INSERT INTO dbo.BOM_STRUCT (BSU_SUBENSAMBLE, BST_HIJO, BST_INCORPOR, BST_DISCH, ME_CODIGO, FACTCONV, BST_PERINI, BST_PERFIN, 
	                      ME_GEN, BST_TRANS, BSU_NOPARTE, BST_NOPARTE, BSU_NOPARTEAUX, 
	                      BST_NOPARTEAUX, BST_TIP_ENS)
	
	SELECT     MAESTRO_2.MA_CODIGO, dbo.MAESTRO.MA_CODIGO, isnull(dbo.IMPEXCELBOM2.CANTIDAD,1), dbo.MAESTRO.MA_DISCHARGE, dbo.MAESTRO.ME_COM, 
	                      dbo.MAESTRO.EQ_GEN, ISNULL(dbo.IMPEXCELBOM2.FECHAINI,'01/01/1990'), ISNULL(dbo.IMPEXCELBOM2.FECHAFIN,'01/01/9999'), MAESTRO_1.ME_COM, 'N', 
	                      MAESTRO_2.MA_NOPARTE, dbo.MAESTRO.MA_NOPARTE, MAESTRO_2.MA_NOPARTEAUX, dbo.MAESTRO.MA_NOPARTEAUX, dbo.MAESTRO.MA_TIP_ENS
	FROM         dbo.IMPEXCELBOM2 INNER JOIN
                      dbo.MAESTRO ON dbo.IMPEXCELBOM2.NOPARTE = dbo.MAESTRO.MA_NOPARTE INNER JOIN
                      dbo.MAESTRO MAESTRO_2 ON dbo.IMPEXCELBOM2.NOPARTEPADRE = MAESTRO_2.MA_NOPARTE LEFT OUTER JOIN
                      dbo.MAESTRO MAESTRO_1 ON dbo.MAESTRO.MA_GENERICO = MAESTRO_1.MA_CODIGO
	 where dbo.MAESTRO.MA_CODIGO not in
		(select bst_hijo from bom_struct where bsu_subensamble=MAESTRO_2.MA_CODIGO
		and bst_perini=dbo.IMPEXCELBOM2.FECHAINI and bst_perfin=dbo.IMPEXCELBOM2.FECHAFIN)
	ORDER BY ORDEN
GO
