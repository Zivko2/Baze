SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO




























-- este procedimiento sirve para revisar el calculo de costos de los productos en base a su bom
CREATE PROCEDURE [dbo].[SP_REVISIONCOSTOS]   as



EXEC SP_ACTUALIZATIPOCOSTOBOMALL


exec sp_droptable 'TempBOMSUBCOSTO1'
/*-------*/

	SELECT BSU_SUBENSAMBLE, 
	sum(round(isnull(MA_GRAV_MP,0),6)+round(isnull(MA_GRAV_EMP,0),6)+round(isnull(MA_GRAV_ADD,0),6)*BOM_STRUCT.BST_INCORPOR) AS FORANEO,
	sum(round(isnull(MA_NG_MP,0),6)+round(isnull(MA_NG_EMP,0),6)+round(isnull(MA_NG_ADD,0),6)*BOM_STRUCT.BST_INCORPOR) AS ORIGINARIO
	INTO dbo.TempBOMSUBCOSTO1
	FROM         BOM_STRUCT INNER JOIN MAESTRO ON BOM_STRUCT.BST_HIJO=MAESTRO.MA_CODIGO INNER JOIN
	             VMAESTROCOST ON BOM_STRUCT.BST_HIJO = VMAESTROCOST.MA_CODIGO
	WHERE     VMAESTROCOST.SPI_CODIGO = 22 AND BST_PERINI <=GETDATE() AND BST_PERFIN >=GETDATE()
	AND (MAESTRO.TI_CODIGO=14 or MAESTRO.TI_CODIGO=16) AND BSU_SUBENSAMBLE IN
		(SELECT MA_CODIGO FROM MAESTRO WHERE MA_TIP_ENS ='F')
	GROUP BY BSU_SUBENSAMBLE


	if not exists (select * from sysobjects where name='TempBOMSUBCOSTO1')
		SELECT BSU_SUBENSAMBLE, 
		SUM(round(isnull(MA_COSTO,0),6)*BOM_STRUCT.BST_INCORPOR) AS FORANEO,
		0 AS ORIGINARIO
		INTO dbo.TempBOMSUBCOSTO1
		FROM BOM_STRUCT INNER JOIN MAESTRO ON BOM_STRUCT.BST_HIJO=MAESTRO.MA_CODIGO INNER JOIN
		      VMAESTROCOST ON BOM_STRUCT.BST_HIJO = VMAESTROCOST.MA_CODIGO
		WHERE VMAESTROCOST.SPI_CODIGO = 22 AND BST_PERINI <=GETDATE() AND BST_PERFIN >=GETDATE()
		--AND (BOM_STRUCT.TI_CODIGO<>14 AND BOM_STRUCT.TI_CODIGO<>16)
		AND (MAESTRO.BST_TIPOCOSTO='E' or MAESTRO.BST_TIPOCOSTO='A' or MAESTRO.BST_TIPOCOSTO='B')
		 AND BOM_STRUCT.BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_TIP_ENS ='F')
		GROUP BY BSU_SUBENSAMBLE
	ELSE
		INSERT INTO TempBOMSUBCOSTO1(BSU_SUBENSAMBLE, FORANEO, ORIGINARIO)
		SELECT BSU_SUBENSAMBLE, 
		sum(round(isnull(MA_COSTO,0),6)*BOM_STRUCT.BST_INCORPOR)  AS FORANEO,
		0 AS ORIGINARIO
		FROM BOM_STRUCT INNER JOIN MAESTRO ON BOM_STRUCT.BST_HIJO=MAESTRO.MA_CODIGO INNER JOIN
		      VMAESTROCOST ON BOM_STRUCT.BST_HIJO = VMAESTROCOST.MA_CODIGO
		WHERE VMAESTROCOST.SPI_CODIGO = 22 AND BST_PERINI <=GETDATE() AND BST_PERFIN >=GETDATE()
		--AND  (BOM_STRUCT.TI_CODIGO<>14 AND BOM_STRUCT.TI_CODIGO<>16 
		AND (MAESTRO.BST_TIPOCOSTO='E' or MAESTRO.BST_TIPOCOSTO='A' or MAESTRO.BST_TIPOCOSTO='B')
		 AND BOM_STRUCT.BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_TIP_ENS ='F')
		GROUP BY BSU_SUBENSAMBLE

	

	if not exists (select * from sysobjects where name='TempBOMSUBCOSTO1')
		SELECT BSU_SUBENSAMBLE, 
		0 AS FORANEO,
		sum(round(isnull(MA_COSTO,0),6)*BOM_STRUCT.BST_INCORPOR) AS ORIGINARIO
		INTO dbo.TempBOMSUBCOSTO1
		FROM BOM_STRUCT INNER JOIN MAESTRO ON BOM_STRUCT.BST_HIJO=MAESTRO.MA_CODIGO INNER JOIN
		      VMAESTROCOST ON BOM_STRUCT.BST_HIJO = VMAESTROCOST.MA_CODIGO
		WHERE     VMAESTROCOST.SPI_CODIGO = 22 AND BST_PERINI <=GETDATE() AND BST_PERFIN >=GETDATE()
		--AND (BOM_STRUCT.TI_CODIGO<>14 AND BOM_STRUCT.TI_CODIGO<>16)
		AND (MAESTRO.BST_TIPOCOSTO='C' or MAESTRO.BST_TIPOCOSTO='D' or MAESTRO.BST_TIPOCOSTO='F'or MAESTRO.BST_TIPOCOSTO='P' or MAESTRO.BST_TIPOCOSTO='N')
		 AND BOM_STRUCT.BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_TIP_ENS ='F')
		GROUP BY BSU_SUBENSAMBLE
	ELSE
		INSERT INTO TempBOMSUBCOSTO1(BSU_SUBENSAMBLE, FORANEO, ORIGINARIO)
		SELECT BSU_SUBENSAMBLE, 
		0 AS FORANEO,
		sum(round(isnull(MA_COSTO,0),6)*BOM_STRUCT.BST_INCORPOR) AS ORIGINARIO
		FROM BOM_STRUCT INNER JOIN MAESTRO ON BOM_STRUCT.BST_HIJO=MAESTRO.MA_CODIGO INNER JOIN
		      VMAESTROCOST ON BOM_STRUCT.BST_HIJO = VMAESTROCOST.MA_CODIGO
		WHERE     VMAESTROCOST.SPI_CODIGO = 22 AND BST_PERINI <=GETDATE() AND BST_PERFIN >=GETDATE()
		--AND (BOM_STRUCT.TI_CODIGO<>14 AND BOM_STRUCT.TI_CODIGO<>16)
		AND (MAESTRO.BST_TIPOCOSTO='C' or MAESTRO.BST_TIPOCOSTO='D' or MAESTRO.BST_TIPOCOSTO='F'or MAESTRO.BST_TIPOCOSTO='P' or MAESTRO.BST_TIPOCOSTO='N')
		 AND BOM_STRUCT.BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM MAESTRO WHERE MA_TIP_ENS ='F')
		GROUP BY BSU_SUBENSAMBLE	
	


exec sp_droptable 'TempBOMSUBCOSTO'





IF (SELECT CF_USACOSTNODUTNAFTA FROM CONFIGURACION)='S' 
begin
	SELECT     BSU_SUBENSAMBLE, SUM(FORANEO)+SUM(ORIGINARIO) AS FORANEO, 0 AS ORIGINARIO
	INTO dbo.TempBOMSUBCOSTO
	FROM         TempBOMSUBCOSTO1
	WHERE BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM NAFTA INNER JOIN SPI ON NAFTA.SPI_CODIGO = SPI.SPI_CODIGO
	                            WHERE SPI.SPI_CLAVE = 'NAFTA' and NFT_CALIFICO='S' AND NAFTA.NFT_PERINI <= getdate() AND 
	                                                   NAFTA.NFT_PERFIN >= getdate())
	GROUP BY BSU_SUBENSAMBLE


	if not exists (select * from sysobjects where name='TempBOMSUBCOSTO')
		SELECT     BSU_SUBENSAMBLE, SUM(FORANEO) AS FORANEO, SUM(ORIGINARIO) AS ORIGINARIO
		INTO dbo.TempBOMSUBCOSTO
		FROM         TempBOMSUBCOSTO1
		WHERE BSU_SUBENSAMBLE NOT IN (SELECT MA_CODIGO FROM NAFTA INNER JOIN SPI ON NAFTA.SPI_CODIGO = SPI.SPI_CODIGO
		                            WHERE SPI.SPI_CLAVE = 'NAFTA' and NFT_CALIFICO='S' AND NAFTA.NFT_PERINI <= getdate() AND 
		                                                   NAFTA.NFT_PERFIN >= getdate())
		GROUP BY BSU_SUBENSAMBLE
	ELSE
		INSERT INTO TempBOMSUBCOSTO(BSU_SUBENSAMBLE, FORANEO, ORIGINARIO)
		SELECT     BSU_SUBENSAMBLE, SUM(FORANEO) AS FORANEO, SUM(ORIGINARIO) AS ORIGINARIO
		FROM         TempBOMSUBCOSTO1
		WHERE BSU_SUBENSAMBLE NOT IN (SELECT MA_CODIGO FROM NAFTA INNER JOIN SPI ON NAFTA.SPI_CODIGO = SPI.SPI_CODIGO
		                            WHERE SPI.SPI_CLAVE = 'NAFTA' and NFT_CALIFICO='S' AND NAFTA.NFT_PERINI <= getdate() AND 
		                                                   NAFTA.NFT_PERFIN >= getdate())
		GROUP BY BSU_SUBENSAMBLE


end
else
begin
	SELECT     BSU_SUBENSAMBLE, SUM(FORANEO) AS FORANEO, SUM(ORIGINARIO) AS ORIGINARIO
	INTO dbo.TempBOMSUBCOSTO
	FROM         TempBOMSUBCOSTO1
	WHERE BSU_SUBENSAMBLE IN (SELECT MA_CODIGO FROM NAFTA INNER JOIN SPI ON NAFTA.SPI_CODIGO = SPI.SPI_CODIGO
	                            WHERE SPI.SPI_CLAVE = 'NAFTA' and NFT_CALIFICO='S' AND NAFTA.NFT_PERINI <= getdate() AND 
	                                                   NAFTA.NFT_PERFIN >= getdate())
	GROUP BY BSU_SUBENSAMBLE

end


exec sp_droptable 'TempBOMSUBCOSTO1'
exec sp_droptable 'TempRevisionCostos'


SELECT     TempBOMSUBCOSTO.BSU_SUBENSAMBLE, 
round(TempBOMSUBCOSTO.FORANEO,6) AS FORANEO,(round(VMAESTROCOST.MA_GRAV_MP + VMAESTROCOST.MA_GRAV_EMP + VMAESTROCOST.MA_GRAV_ADD,6)) AS SUMFORANEO,
round(TempBOMSUBCOSTO.ORIGINARIO,6) AS ORIGINARIO,(round(VMAESTROCOST.MA_NG_MP + VMAESTROCOST.MA_NG_EMP + VMAESTROCOST.MA_NG_ADD,6)) AS SUMORIGINARIO
INTO dbo.TempRevisionCostos
FROM         TempBOMSUBCOSTO INNER JOIN
                      VMAESTROCOST ON TempBOMSUBCOSTO.BSU_SUBENSAMBLE = VMAESTROCOST.MA_CODIGO


exec sp_droptable 'TempIncorrectos'

SELECT     FORANEO - SUMFORANEO as DIFFORANEO, ORIGINARIO - SUMORIGINARIO AS FIDORIGINARIO, (select ma_noparte from maestro where ma_codigo=BSU_SUBENSAMBLE) as BSU_NOPARTE, BSU_SUBENSAMBLE
into dbo.TempIncorrectos
FROM         TempRevisionCostos
WHERE     (FORANEO - SUMFORANEO > 1 OR
                      FORANEO - SUMFORANEO < - 1) OR
                      (ORIGINARIO - SUMORIGINARIO > 1 OR
                      ORIGINARIO - SUMORIGINARIO < - 1)

exec sp_droptable 'TempRevisionCostos'



























GO
