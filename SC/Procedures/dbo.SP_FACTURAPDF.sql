SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO



























CREATE PROCEDURE [dbo].[SP_FACTURAPDF] (@CODIGOFACT INT, @MOVIMIENTO CHAR(1))   as




if @MOVIMIENTO='E'
begin
	if not exists (select * from FACTURAPDF417 where FACB_CODIGOFACT= @CODIGOFACT and FACB_MOVIMIENTO=@MOVIMIENTO)
	begin
		INSERT INTO FACTURAPDF417(FACB_CODIGOFACT, FACB_MOVIMIENTO, FACB_TEXTO)
		
		SELECT    FI_CODIGO, 'E',  ISNULL(LEFT(CLIENTE.CL_CODEHTC,10), '') +REPLICATE(' ',10-LEN(ISNULL(LEFT(CLIENTE.CL_CODEHTC,10), ''))) +
		 ISNULL(LEFT(CLIENTE_1.CL_CODEHTC,10), '')+REPLICATE(' ',10-LEN(ISNULL(LEFT(CLIENTE_1.CL_CODEHTC,10), ''))) + ISNULL(LEFT(FACTIMP.FI_FOLIO,10),'')+REPLICATE(' ',10-LEN(ISNULL(LEFT(FACTIMP.FI_FOLIO,10), '')))+ISNULL(LEFT( FACTIMP.FI_TRAC_MX,15),'')+REPLICATE(' ',15-LEN(ISNULL(LEFT(FACTIMP.FI_TRAC_MX,15), '')))+
		                      dbo.FormatoFecha(FACTIMP.FI_FECHA, '1', 'N', 'S', '')+ CONVERT(VARCHAR(5),GETDATE(),108)
		FROM         FACTIMP LEFT OUTER JOIN
		                      CLIENTE CLIENTE_1 ON FACTIMP.CL_IMP = CLIENTE_1.CL_CODIGO LEFT OUTER JOIN
		                      CLIENTE ON FACTIMP.PR_CODIGO = CLIENTE.CL_CODIGO
		WHERE FI_CODIGO=@CODIGOFACT	
	end
end


if @MOVIMIENTO='S'
begin
	if not exists (select * from FACTURAPDF417 where FACB_CODIGOFACT= @CODIGOFACT and FACB_MOVIMIENTO=@MOVIMIENTO)
	begin
		INSERT INTO FACTURAPDF417(FACB_CODIGOFACT, FACB_MOVIMIENTO, FACB_TEXTO)
		
		SELECT    FE_CODIGO, 'S',  ISNULL(LEFT(CLIENTE_1.CL_CODEHTC,10), '')+REPLICATE(' ',10-LEN(ISNULL(LEFT(CLIENTE_1.CL_CODEHTC,10), ''))) +
			ISNULL(LEFT(CLIENTE.CL_CODEHTC,10), '') +REPLICATE(' ',10-LEN(ISNULL(LEFT(CLIENTE.CL_CODEHTC,10), '')))+ ISNULL(LEFT(FACTEXP.FE_FOLIO,10),'')+REPLICATE(' ',10-LEN(ISNULL(LEFT(FACTEXP.FE_FOLIO,10), '')))+ISNULL(LEFT( FACTEXP.FE_TRAC_MX1,15),'')+REPLICATE(' ',15-LEN(ISNULL(LEFT(FACTEXP.FE_TRAC_MX1,15), '')))+
		                      dbo.FormatoFecha(FACTEXP.FE_FECHA, '1', 'N', 'S', '')+ CONVERT(VARCHAR(5),GETDATE(),108)
		FROM         FACTEXP LEFT OUTER JOIN
		                      CLIENTE CLIENTE_1 ON FACTEXP.CL_PROD = CLIENTE_1.CL_CODIGO LEFT OUTER JOIN
		                      CLIENTE ON FACTEXP.CL_IMP = CLIENTE.CL_CODIGO
		WHERE FE_CODIGO=@CODIGOFACT	
	end
end


























GO
