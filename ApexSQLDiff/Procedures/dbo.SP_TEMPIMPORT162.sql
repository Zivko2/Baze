SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TEMPIMPORT162] AS
DECLARE @Col_4 varchar(8000),@FACTEXP#FE_FOLIO varchar(8000),@FACTEXPDET#FED_CANT float,@FACTEXPDET#FED_COS_TOT float,@FACTEXPDET#FED_PES_NET float,@FACTEXPDET#FED_PES_BRU float,@FACTEXPDET#EQ_GEN float,@FACTEXP#FE_TIPO char,@FACTEXP#TQ_CODIGO smallint,@FACTEXP#TF_CODIGO smallint,@FACTEXPDET#FED_NOPARTEAUX varchar(8000),@FACTEXPDET#FED_LOTE varchar(8000),@FACTEXPDET#FED_NOORDEN varchar(8000),@FACTEXPDET#FED_NOPARTE varchar(8000),@Cod_3 varchar(8000)
DECLARE @ACTUALIZA bit,@ANEXA bit,@CONSECUTIVO int,@CONSDET int,@CONSANEX int,@CONSCONT int
DECLARE @CAMPOSMASTER varchar(255),@temp_str varchar(20)
SELECT @ACTUALIZA=0
SELECT @ANEXA=1
DELETE FROM REGISTROSIMPORTADOS
-- Variables para campos de caratula
           DECLARE @FACTEXP#FE_DESCRIPTION1 varchar(8000)
           DECLARE @FACTEXP#FE_HEADER varchar(8000)
           DECLARE @FACTEXP#FE_FOOTER varchar(8000)
           DECLARE @FACTEXP#FE_FECHA datetime
           DECLARE @FACTEXP#AG_MX int
           DECLARE @FACTEXP#AG_US int
           DECLARE @FACTEXP#CL_PROD int
           DECLARE @FACTEXP#DI_PROD int
           DECLARE @FACTEXP#CL_COMP int
           DECLARE @FACTEXP#DI_COMP int
           DECLARE @FACTEXP#CL_COMPFIN int
           DECLARE @FACTEXP#DI_COMPFIN int
           DECLARE @FACTEXP#CL_EXP int
           DECLARE @FACTEXP#DI_EXP int
           DECLARE @FACTEXP#CL_EXPFIN int
           DECLARE @FACTEXP#DI_EXPFIN int
           DECLARE @FACTEXP#CL_DESTINI int
           DECLARE @FACTEXP#DI_DESTINI int
           DECLARE @FACTEXP#CL_DESTFIN int
           DECLARE @FACTEXP#DI_DESTFIN int
           DECLARE @FACTEXP#CL_VEND int
           DECLARE @FACTEXP#DI_VEND int
           DECLARE @FACTEXP#CL_IMP int
           DECLARE @FACTEXP#DI_IMP int
           DECLARE @FACTEXP#PU_CARGA int
           DECLARE @FACTEXP#PU_SALIDA int
           DECLARE @FACTEXP#PU_ENTRADA int
           DECLARE @FACTEXP#PU_DESTINO int
           DECLARE @FACTEXP#CT_COMPANY1 int
           DECLARE @FACTEXP#CT_COMPANY2 int
           DECLARE @FACTEXP#IT_COMPANY1 smallint
           DECLARE @FACTEXP#MT_COMPANY1 smallint
           DECLARE @FACTEXP#IT_COMPANY2 smallint
           DECLARE @FACTEXP#MT_COMPANY2 smallint
           DECLARE @FACTEXP#FE_TIPOCAMBIO decimal(38,14)
           DECLARE @FACTEXP#MO_CODIGO int
           DECLARE @FACTEXP#FE_PINICIAL datetime
           DECLARE @FACTEXP#FE_PFINAL datetime
           DECLARE @FACTEXP#AGT_CODIGO int
-- Variables para campos de detalle
           DECLARE @FACTEXPDET#FED_PARTTYPE char
           DECLARE @FACTEXPDET#SE_CODIGO smallint
           DECLARE @FACTEXPDET#FED_FECHA_STRUCT datetime
           DECLARE @FACTEXPDET#FED_RETRABAJO char
           DECLARE @FACTEXPDET#TI_CODIGO smallint
           DECLARE @FACTEXPDET#TCO_CODIGO smallint
           DECLARE @FACTEXPDET#SPI_CODIGO smallint
           DECLARE @FACTEXPDET#PA_CODIGO int
           DECLARE @FACTEXPDET#ME_CODIGO int
           DECLARE @FACTEXPDET#ME_AREXPMX int
           DECLARE @FACTEXPDET#MA_GENERICO int
           DECLARE @FACTEXPDET#MA_CODIGO int
           DECLARE @FACTEXPDET#FED_TIP_ENS char
           DECLARE @FACTEXPDET#FED_SEC_IMP smallint
           DECLARE @FACTEXPDET#AR_EXPMX int
           DECLARE @FACTEXPDET#FED_POR_DEF decimal(38,14)
           DECLARE @FACTEXPDET#FED_PES_UNILB decimal(38,14)
           DECLARE @FACTEXPDET#FED_PES_UNI decimal(38,14)
           DECLARE @FACTEXPDET#FED_NOMBRE varchar(8000)
           DECLARE @FACTEXPDET#FED_NG_USA decimal(38,14)
           DECLARE @FACTEXPDET#FED_NG_MP decimal(38,14)
           DECLARE @FACTEXPDET#FED_NG_EMP decimal(38,14)
           DECLARE @FACTEXPDET#FED_NG_ADD decimal(38,14)
           DECLARE @FACTEXPDET#FED_NAME varchar(8000)
           DECLARE @FACTEXPDET#FED_NAFTA char
           DECLARE @FACTEXPDET#FED_GRA_MP decimal(38,14)
           DECLARE @FACTEXPDET#FED_GRA_MO decimal(38,14)
           DECLARE @FACTEXPDET#FED_GRA_GI_MX decimal(38,14)
           DECLARE @FACTEXPDET#FED_GRA_GI decimal(38,14)
           DECLARE @FACTEXPDET#FED_GRA_EMP decimal(38,14)
           DECLARE @FACTEXPDET#FED_GRA_ADD decimal(38,14)
           DECLARE @FACTEXPDET#FED_DISCHARGE char
           DECLARE @FACTEXPDET#FED_DEF_TIP char
           DECLARE @FACTEXPDET#FED_COS_UNI decimal(38,14)
           DECLARE @FACTEXPDET#EQ_IMPFO decimal(38,14)
           DECLARE @FACTEXPDET#EQ_EXPMX decimal(38,14)
           DECLARE @FACTEXPDET#CS_CODIGO smallint
           DECLARE @FACTEXPDET#CL_CODIGO int
           DECLARE @FACTEXPDET#AR_IMPMX int
           DECLARE @FACTEXPDET#AR_IMPFO int
           DECLARE @FACTEXPDET#AR_ORIG int
           DECLARE @FACTEXPDET#AR_NG_EMP int
           DECLARE @FACTEXPDET#FED_RATEIMPFO decimal(38,14)
           DECLARE @FACTEXPDET#ME_GENERICO int
DECLARE CUR_TEMPIMPORT162 CURSOR FOR
SELECT MAX(Col_4),MAX(Cod_3),FACTEXP0#FE_FOLIO,FACTEXP0#FE_TIPO,MAX(FACTEXP0#TQ_CODIGO),MAX(FACTEXP0#TF_CODIGO) FROM TEMPIMPORT162 WHERE FACTEXP0#FE_FOLIO NOT IN (select factexp.fe_folio from factexp WHERE factexp.fe_estatus in ('A', 'C', 'P', 'L', 'S') or fe_iniciocruce='S') GROUP BY FACTEXP0#FE_FOLIO,FACTEXP0#FE_TIPO
OPEN CUR_TEMPIMPORT162
FETCH NEXT FROM CUR_TEMPIMPORT162 INTO @Col_4 ,@Cod_3 ,@FACTEXP#FE_FOLIO ,@FACTEXP#FE_TIPO ,@FACTEXP#TQ_CODIGO ,@FACTEXP#TF_CODIGO 
WHILE (@@FETCH_STATUS = 0)
BEGIN
   IF NOT EXISTS(SELECT FE_CODIGO FROM FACTEXP WHERE FE_FOLIO=@FACTEXP#FE_FOLIO AND FE_TIPO=@FACTEXP#FE_TIPO AND TQ_CODIGO=@FACTEXP#TQ_CODIGO)
  IF @ANEXA=1
  BEGIN
           SELECT @FACTEXP#FE_DESCRIPTION1=(SELECT CONVERT(VARCHAR(30),CL_DESC_GRAL) FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#FE_DESCRIPTION1 IS NULL
                SELECT @FACTEXP#FE_DESCRIPTION1=''
           SELECT @FACTEXP#FE_HEADER=(SELECT CONVERT(VARCHAR(150),FE_HEADER) FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#FE_HEADER IS NULL
                SELECT @FACTEXP#FE_HEADER=''
           SELECT @FACTEXP#FE_FOOTER=(SELECT CONVERT(VARCHAR(150),FE_FOOTER) FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#FE_FOOTER IS NULL
                SELECT @FACTEXP#FE_FOOTER=''
           SELECT @FACTEXP#FE_FECHA=(convert(varchar(10),getdate(),101))
            IF @FACTEXP#FE_FECHA IS NULL
                SELECT @FACTEXP#FE_FECHA=''
           SELECT @FACTEXP#AG_MX=(SELECT AG_MEX FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#AG_MX IS NULL
                SELECT @FACTEXP#AG_MX=0
           SELECT @FACTEXP#AG_US=(SELECT AG_USA FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#AG_US IS NULL
                SELECT @FACTEXP#AG_US=0
           SELECT @FACTEXP#CL_PROD=(SELECT CL_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_PROD IS NULL
                SELECT @FACTEXP#CL_PROD=1
           SELECT @FACTEXP#DI_PROD=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_PROD IS NULL
                SELECT @FACTEXP#DI_PROD=0
           SELECT @FACTEXP#CL_COMP=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_COMP IS NULL
                SELECT @FACTEXP#CL_COMP=0
           SELECT @FACTEXP#DI_COMP=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_COMP IS NULL
                SELECT @FACTEXP#DI_COMP=0
           SELECT @FACTEXP#CL_COMPFIN=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_COMPFIN IS NULL
                SELECT @FACTEXP#CL_COMPFIN=0
           SELECT @FACTEXP#DI_COMPFIN=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_COMPFIN IS NULL
                SELECT @FACTEXP#DI_COMPFIN=0
           SELECT @FACTEXP#CL_EXP=(SELECT CL_TRAFICO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_EXP IS NULL
                SELECT @FACTEXP#CL_EXP=0
           SELECT @FACTEXP#DI_EXP=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_TRAFICO FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_EXP IS NULL
                SELECT @FACTEXP#DI_EXP=0
           SELECT @FACTEXP#CL_EXPFIN=(SELECT CL_TRAFICO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_EXPFIN IS NULL
                SELECT @FACTEXP#CL_EXPFIN=0
           SELECT @FACTEXP#DI_EXPFIN=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_TRAFICO FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_EXPFIN IS NULL
                SELECT @FACTEXP#DI_EXPFIN=0
           SELECT @FACTEXP#CL_DESTINI=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_DESTINI IS NULL
                SELECT @FACTEXP#CL_DESTINI=0
           SELECT @FACTEXP#DI_DESTINI=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_DESTINI IS NULL
                SELECT @FACTEXP#DI_DESTINI=0
           SELECT @FACTEXP#CL_DESTFIN=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_DESTFIN IS NULL
                SELECT @FACTEXP#CL_DESTFIN=0
           SELECT @FACTEXP#DI_DESTFIN=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_DESTFIN IS NULL
                SELECT @FACTEXP#DI_DESTFIN=0
           SELECT @FACTEXP#CL_VEND=(SELECT CL_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_VEND IS NULL
                SELECT @FACTEXP#CL_VEND=1
           SELECT @FACTEXP#DI_VEND=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO IN (SELECT CL_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#DI_VEND IS NULL
                SELECT @FACTEXP#DI_VEND=0
           SELECT @FACTEXP#CL_IMP=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CL_IMP IS NULL
                SELECT @FACTEXP#CL_IMP=0
           SELECT @FACTEXP#DI_IMP=(SELECT DI_INDICE FROM DIR_CLIENTE WHERE DI_FISCAL='S' AND CL_CODIGO=@FACTEXP#CL_IMP)
            IF @FACTEXP#DI_IMP IS NULL
                SELECT @FACTEXP#DI_IMP=0
           SELECT @FACTEXP#PU_CARGA=(SELECT PU_CARGAS FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#PU_CARGA IS NULL
                SELECT @FACTEXP#PU_CARGA=0
           SELECT @FACTEXP#PU_SALIDA=(SELECT PU_SALIDAS FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#PU_SALIDA IS NULL
                SELECT @FACTEXP#PU_SALIDA=0
           SELECT @FACTEXP#PU_ENTRADA=(SELECT PU_ENTRADAS FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#PU_ENTRADA IS NULL
                SELECT @FACTEXP#PU_ENTRADA=0
           SELECT @FACTEXP#PU_DESTINO=(SELECT PU_DESTINOS FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#PU_DESTINO IS NULL
                SELECT @FACTEXP#PU_DESTINO=0
           SELECT @FACTEXP#CT_COMPANY1=(SELECT CT_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CT_COMPANY1 IS NULL
                SELECT @FACTEXP#CT_COMPANY1=0
           SELECT @FACTEXP#CT_COMPANY2=(SELECT CT_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#CT_COMPANY2 IS NULL
                SELECT @FACTEXP#CT_COMPANY2=0
           SELECT @FACTEXP#IT_COMPANY1=(SELECT IT_SALIDA FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#IT_COMPANY1 IS NULL
                SELECT @FACTEXP#IT_COMPANY1=0
           SELECT @FACTEXP#MT_COMPANY1=(SELECT MT_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#MT_COMPANY1 IS NULL
                SELECT @FACTEXP#MT_COMPANY1=0
           SELECT @FACTEXP#IT_COMPANY2=(SELECT IT_SALIDA FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#IT_COMPANY2 IS NULL
                SELECT @FACTEXP#IT_COMPANY2=0
           SELECT @FACTEXP#MT_COMPANY2=(SELECT MT_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#MT_COMPANY2 IS NULL
                SELECT @FACTEXP#MT_COMPANY2=0
           SELECT @FACTEXP#FE_TIPOCAMBIO=(SELECT TC_CANT FROM TCAMBIO WHERE TC_FECHA=@FACTEXP#FE_FECHA)
            IF @FACTEXP#FE_TIPOCAMBIO IS NULL
                SELECT @FACTEXP#FE_TIPOCAMBIO=1
           SELECT @FACTEXP#MO_CODIGO=(SELECT MO_CODIGO FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXP#MO_CODIGO IS NULL
                SELECT @FACTEXP#MO_CODIGO=0
           SELECT @FACTEXP#FE_PINICIAL=(convert(varchar(10),getdate(),101))
            IF @FACTEXP#FE_PINICIAL IS NULL
                SELECT @FACTEXP#FE_PINICIAL=''
           SELECT @FACTEXP#FE_PFINAL=(convert(varchar(10),getdate(),101))
            IF @FACTEXP#FE_PFINAL IS NULL
                SELECT @FACTEXP#FE_PFINAL=''
           SELECT @FACTEXP#AGT_CODIGO=(SELECT AGT_CODIGO FROM AGENCIAPATENTE WHERE AGT_DEFAULT='S' AND AG_CODIGO IN (SELECT AG_MEX FROM CLIENTE WHERE CL_EMPRESA='S'))
            IF @FACTEXP#AGT_CODIGO IS NULL
                SELECT @FACTEXP#AGT_CODIGO=0
          EXEC SP_GETCONSECUTIVO @TIPO='FE',@VALUE=@CONSECUTIVO OUTPUT
          INSERT INTO FACTEXP (FE_CODIGO,FE_FOLIO ,FE_TIPO ,TQ_CODIGO ,TF_CODIGO ,FE_DESCRIPTION1 ,FE_HEADER ,FE_FOOTER ,FE_FECHA ,AG_MX ,AG_US ,CL_PROD ,DI_PROD ,CL_COMP ,DI_COMP ,CL_COMPFIN ,DI_COMPFIN ,CL_EXP ,DI_EXP ,CL_EXPFIN ,DI_EXPFIN ,CL_DESTINI ,DI_DESTINI ,CL_DESTFIN ,DI_DESTFIN ,CL_VEND ,DI_VEND ,CL_IMP ,DI_IMP ,PU_CARGA ,PU_SALIDA ,PU_ENTRADA ,PU_DESTINO ,CT_COMPANY1 ,CT_COMPANY2 ,IT_COMPANY1 ,MT_COMPANY1 ,IT_COMPANY2 ,MT_COMPANY2 ,FE_TIPOCAMBIO ,MO_CODIGO ,FE_PINICIAL ,FE_PFINAL ,AGT_CODIGO ) VALUES (@CONSECUTIVO,@FACTEXP#FE_FOLIO ,@FACTEXP#FE_TIPO ,@FACTEXP#TQ_CODIGO ,@FACTEXP#TF_CODIGO ,@FACTEXP#FE_DESCRIPTION1,@FACTEXP#FE_HEADER,@FACTEXP#FE_FOOTER,@FACTEXP#FE_FECHA,@FACTEXP#AG_MX,@FACTEXP#AG_US,@FACTEXP#CL_PROD,@FACTEXP#DI_PROD,@FACTEXP#CL_COMP,@FACTEXP#DI_COMP,@FACTEXP#CL_COMPFIN,@FACTEXP#DI_COMPFIN,@FACTEXP#CL_EXP,@FACTEXP#DI_EXP,@FACTEXP#CL_EXPFIN,@FACTEXP#DI_EXPFIN,@FACTEXP#CL_DESTINI,@FACTEXP#DI_DESTINI,@FACTEXP#CL_DESTFIN,@FACTEXP#DI_DESTFIN,@FACTEXP#CL_VEND,@FACTEXP#DI_VEND,@FACTEXP#CL_IMP,@FACTEXP#DI_IMP,@FACTEXP#PU_CARGA,@FACTEXP#PU_SALIDA,@FACTEXP#PU_ENTRADA,@FACTEXP#PU_DESTINO,@FACTEXP#CT_COMPANY1,@FACTEXP#CT_COMPANY2,@FACTEXP#IT_COMPANY1,@FACTEXP#MT_COMPANY1,@FACTEXP#IT_COMPANY2,@FACTEXP#MT_COMPANY2,@FACTEXP#FE_TIPOCAMBIO,@FACTEXP#MO_CODIGO,@FACTEXP#FE_PINICIAL,@FACTEXP#FE_PFINAL,@FACTEXP#AGT_CODIGO)
               INSERT INTO REGISTROSIMPORTADOS (RI_REGISTRO,RI_TIPO,RI_CBFORMA) VALUES                                               ('FE_FOLIO = '+CONVERT(varchar(100),@FACTEXP#FE_FOLIO)+', '+'FE_FECHA = '+CONVERT(varchar(100),@FACTEXP#FE_FECHA),'I',20) 
 if exists (select * from sysobjects where name='sysusrlog62')                 insert into sysusrlog62 (user_id, mov_id, referencia, frmtag, fechahora) values                                                        (7, 1 ,'FE_FOLIO = '+CONVERT(varchar(100),@FACTEXP#FE_FOLIO)+', '+'FE_FECHA = '+CONVERT(varchar(100),@FACTEXP#FE_FECHA),62, getdate()) 
        DECLARE CUR_TEMPIMPORT162DET CURSOR FOR
        SELECT MAX(Col_4),MAX(Cod_3),SUM(FACTEXPDET0#FED_CANT),SUM(FACTEXPDET0#FED_COS_TOT),SUM(FACTEXPDET0#FED_PES_NET),SUM(FACTEXPDET0#FED_PES_BRU),FACTEXPDET0#EQ_GEN,FACTEXPDET0#FED_NOPARTEAUX,FACTEXPDET0#FED_LOTE,FACTEXPDET0#FED_NOORDEN,FACTEXPDET0#FED_NOPARTE FROM TEMPIMPORT162  WHERE FACTEXP0#FE_FOLIO=@FACTEXP#FE_FOLIO AND FACTEXP0#FE_TIPO=@FACTEXP#FE_TIPO AND FACTEXP0#TQ_CODIGO=@FACTEXP#TQ_CODIGO GROUP BY FACTEXPDET0#EQ_GEN,FACTEXPDET0#FED_NOPARTEAUX,FACTEXPDET0#FED_LOTE,FACTEXPDET0#FED_NOORDEN,FACTEXPDET0#FED_NOPARTE
        OPEN CUR_TEMPIMPORT162DET
                      FETCH NEXT FROM CUR_TEMPIMPORT162DET INTO @Col_4 ,@Cod_3 ,@FACTEXPDET#FED_CANT ,@FACTEXPDET#FED_COS_TOT ,@FACTEXPDET#FED_PES_NET ,@FACTEXPDET#FED_PES_BRU ,@FACTEXPDET#EQ_GEN ,@FACTEXPDET#FED_NOPARTEAUX ,@FACTEXPDET#FED_LOTE ,@FACTEXPDET#FED_NOORDEN ,@FACTEXPDET#FED_NOPARTE 
        WHILE (@@FETCH_STATUS = 0)
        BEGIN
           SELECT @FACTEXPDET#FED_PARTTYPE=(SELECT  'FED_PARTTYPE'=CASE WHEN CONFIGURATIPO.CFT_TIPO IN ('P','S') THEN 'A'  ELSE 'C' END FROM MAESTRO LEFT OUTER JOIN CONFIGURATIPO ON MAESTRO.TI_CODIGO = CONFIGURATIPO.TI_CODIGO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_PARTTYPE IS NULL
                SELECT @FACTEXPDET#FED_PARTTYPE=''
           SELECT @FACTEXPDET#SE_CODIGO=(SELECT isnull(SE_codigo,0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#SE_CODIGO IS NULL
                SELECT @FACTEXPDET#SE_CODIGO=0
           SELECT @FACTEXPDET#FED_FECHA_STRUCT=(SELECT convert(varchar(11),getdate(),101))
            IF @FACTEXPDET#FED_FECHA_STRUCT IS NULL
                SELECT @FACTEXPDET#FED_FECHA_STRUCT=''
           SELECT @FACTEXPDET#FED_RETRABAJO=(SELECT 'FED_RETRABAJO'=CASE WHEN @FACTEXP#TQ_CODIGO in (select tq_codigo from tembarque where tq_nombre = 'PRODUCTO TERMINADO (CASO ESPECIAL)') THEN 'D' ELSE 'N' END)
            IF @FACTEXPDET#FED_RETRABAJO IS NULL
                SELECT @FACTEXPDET#FED_RETRABAJO='N'
           SELECT @FACTEXPDET#TI_CODIGO=ISNULL((SELECT isnull(TI_CODIGO,0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),14)
            IF @FACTEXPDET#TI_CODIGO IS NULL
                SELECT @FACTEXPDET#TI_CODIGO=10
           SELECT @FACTEXPDET#TCO_CODIGO=ISNULL((SELECT 'TCO_CODIGO'=CASE WHEN MAESTRO.MA_TIP_ENS='A' AND (SELECT CF_TCOCOMPRAIMP FROM CONFIGURACION)='S' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT TCO_MANUFACTURA FROM CONFIGURACION) ELSE (SELECT TCO_COMPRA FROM CONFIGURACION) END) ELSE (CASE WHEN @FACTEXP#TQ_CODIGO=8 THEN (CASE WHEN (SELECT MAX(MAC_CODIGO) FROM MAESTROCOST WHERE MA_PERINI<=@FACTEXP#FE_FECHA AND MA_PERFIN>=@FACTEXP#FE_FECHA AND MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO AND TCO_CODIGO=(SELECT TCO_DESPERDICIO FROM CONFIGURACION))>0 THEN (SELECT TCO_DESPERDICIO FROM CONFIGURACION) ELSE (SELECT TCO_COMPRA FROM CONFIGURACION) END) ELSE (CASE WHEN MAESTRO.MA_TIP_ENS='F' THEN (SELECT TCO_MANUFACTURA FROM CONFIGURACION) ELSE (SELECT TCO_COMPRA FROM CONFIGURACION) END)  END) END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),1)
            IF @FACTEXPDET#TCO_CODIGO IS NULL
                SELECT @FACTEXPDET#TCO_CODIGO=0
           SELECT @FACTEXPDET#SPI_CODIGO=(SELECT isnull(SPI_CODIGO,0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#SPI_CODIGO IS NULL
                SELECT @FACTEXPDET#SPI_CODIGO=0
           SELECT @FACTEXPDET#PA_CODIGO=ISNULL((SELECT 'PA_CODIGO'=CASE WHEN MAESTRO.MA_TIP_ENS='A' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.PA_ORIGENFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE PA_ORIGEN END) ELSE PA_ORIGEN END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),154)
            IF @FACTEXPDET#PA_CODIGO IS NULL
                SELECT @FACTEXPDET#PA_CODIGO=0
           SELECT @FACTEXPDET#ME_CODIGO=ISNULL((SELECT isnull(ME_COM,19) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),19)
            IF @FACTEXPDET#ME_CODIGO IS NULL
                SELECT @FACTEXPDET#ME_CODIGO=0
           SELECT @FACTEXPDET#ME_AREXPMX=(SELECT isnull(ME_CODIGO,0) FROM ARANCEL WHERE AR_CODIGO=(SELECT AR_EXPMX FROM MAESTRO WHERE MA_INV_GEN='I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX))
            IF @FACTEXPDET#ME_AREXPMX IS NULL
                SELECT @FACTEXPDET#ME_AREXPMX=0
           SELECT @FACTEXPDET#MA_GENERICO=(SELECT 'MA_GENERICO'=CASE WHEN MAESTRO.MA_TIP_ENS='A' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.MA_GENERICOFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE MA_GENERICO END) ELSE MA_GENERICO END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#MA_GENERICO IS NULL
                SELECT @FACTEXPDET#MA_GENERICO=0
           SELECT @FACTEXPDET#MA_CODIGO=ISNULL((SELECT MA_CODIGO FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),0)
            IF @FACTEXPDET#MA_CODIGO IS NULL
                SELECT @FACTEXPDET#MA_CODIGO=0
           SELECT @FACTEXPDET#FED_TIP_ENS=ISNULL((SELECT 'MA_TIP_ENS'=CASE WHEN MA_TIP_ENS='A' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN 'F' ELSE 'C' END) ELSE MA_TIP_ENS END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),'F')
            IF @FACTEXPDET#FED_TIP_ENS IS NULL
                SELECT @FACTEXPDET#FED_TIP_ENS=''
           SELECT @FACTEXPDET#FED_SEC_IMP=(SELECT isnull(MA_SEC_IMP,0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_SEC_IMP IS NULL
                SELECT @FACTEXPDET#FED_SEC_IMP=0
           SELECT @FACTEXPDET#AR_EXPMX=(SELECT 'AR_EXPMX'=CASE WHEN MAESTRO.MA_TIP_ENS='A' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.AR_EXPMXFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE AR_EXPMX END) ELSE (CASE WHEN @FACTEXP#TQ_CODIGO=8 THEN AR_DESPMX ELSE AR_EXPMX END) END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#AR_EXPMX IS NULL
                SELECT @FACTEXPDET#AR_EXPMX=0
           SELECT @FACTEXPDET#FED_POR_DEF=(SELECT dbo.GetAdvalorem(MAESTRO.AR_IMPMX, MAESTRO.PA_ORIGEN, MAESTRO.MA_DEF_TIP, MAESTRO.MA_SEC_IMP, MAESTRO.SPI_CODIGO) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_POR_DEF IS NULL
                SELECT @FACTEXPDET#FED_POR_DEF=0
           SELECT @FACTEXPDET#FED_PES_UNILB=(SELECT MA_PESO_LB FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_PES_UNILB IS NULL
                SELECT @FACTEXPDET#FED_PES_UNILB=0
           SELECT @FACTEXPDET#FED_PES_UNI=(SELECT MA_PESO_KG FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_PES_UNI IS NULL
                SELECT @FACTEXPDET#FED_PES_UNI=0
           SELECT @FACTEXPDET#FED_NOMBRE=ISNULL((SELECT 'FED_NOMBRE'=CASE WHEN MAESTRO.MA_TIP_ENS='A' AND (SELECT CF_TCOCOMPRAIMP FROM CONFIGURACION)='S' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.MA_NOMBREFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE MA_NOMBRE END) ELSE (CASE WHEN @FACTEXP#TQ_CODIGO=8 THEN ISNULL(MA_NOMBREDESP,MA_NOMBRE) ELSE MA_NOMBRE END) END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),'TEMP')
            IF @FACTEXPDET#FED_NOMBRE IS NULL
                SELECT @FACTEXPDET#FED_NOMBRE=''
           SELECT @FACTEXPDET#FED_NG_USA=(SELECT MA_NG_USA FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_NG_USA IS NULL
                SELECT @FACTEXPDET#FED_NG_USA=0
           SELECT @FACTEXPDET#FED_NG_MP=(SELECT MA_NG_MP FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_NG_MP IS NULL
                SELECT @FACTEXPDET#FED_NG_MP=0
           SELECT @FACTEXPDET#FED_NG_EMP=(SELECT MA_NG_EMP FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_NG_EMP IS NULL
                SELECT @FACTEXPDET#FED_NG_EMP=0
           SELECT @FACTEXPDET#FED_NG_ADD=(SELECT MA_NG_ADD FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN(SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_NG_ADD IS NULL
                SELECT @FACTEXPDET#FED_NG_ADD=0
           SELECT @FACTEXPDET#FED_NAME=ISNULL((SELECT 'FED_NAME'=CASE WHEN MAESTRO.MA_TIP_ENS='A' AND (SELECT CF_TCOCOMPRAIMP FROM CONFIGURACION)='S' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.MA_NAMEFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE MA_NAME END) ELSE (CASE WHEN @FACTEXP#TQ_CODIGO=8 THEN ISNULL(MA_NAMEDESP,MA_NAME) ELSE MA_NAME END) END FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX),'TEMP')
            IF @FACTEXPDET#FED_NAME IS NULL
                SELECT @FACTEXPDET#FED_NAME=''
           SELECT @FACTEXPDET#FED_NAFTA=(SELECT dbo.GetNafta(@FACTEXP#FE_FECHA, Maestro.ma_codigo, @FACTEXPDET#AR_EXPMX, @FACTEXPDET#PA_CODIGO, Maestro.ma_def_tip, @FACTEXPDET#FED_TIP_ENS) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_NAFTA IS NULL
                SELECT @FACTEXPDET#FED_NAFTA='N'
           SELECT @FACTEXPDET#FED_GRA_MP=(SELECT MA_GRAV_MP FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_MP IS NULL
                SELECT @FACTEXPDET#FED_GRA_MP=0
           SELECT @FACTEXPDET#FED_GRA_MO=(SELECT MA_GRAV_MO FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_MO IS NULL
                SELECT @FACTEXPDET#FED_GRA_MO=0
           SELECT @FACTEXPDET#FED_GRA_GI_MX=(SELECT MA_GRAV_GI_MX FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_GI_MX IS NULL
                SELECT @FACTEXPDET#FED_GRA_GI_MX=0
           SELECT @FACTEXPDET#FED_GRA_GI=(SELECT MA_GRAV_GI FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_GI IS NULL
                SELECT @FACTEXPDET#FED_GRA_GI=0
           SELECT @FACTEXPDET#FED_GRA_EMP=(SELECT MA_GRAV_EMP FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_EMP IS NULL
                SELECT @FACTEXPDET#FED_GRA_EMP=0
           SELECT @FACTEXPDET#FED_GRA_ADD=(SELECT MA_GRAV_ADD FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND  MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_GRA_ADD IS NULL
                SELECT @FACTEXPDET#FED_GRA_ADD=0
           SELECT @FACTEXPDET#FED_DISCHARGE=(SELECT MA_DISCHARGE FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_DISCHARGE IS NULL
                SELECT @FACTEXPDET#FED_DISCHARGE='S'
           SELECT @FACTEXPDET#FED_DEF_TIP=(SELECT isnull(MA_DEF_TIP,'G')  FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_DEF_TIP IS NULL
                SELECT @FACTEXPDET#FED_DEF_TIP=''
           SELECT @FACTEXPDET#FED_COS_UNI=(SELECT MA_COSTO FROM MAESTROCOST INNER JOIN MAESTRO ON MAESTROCOST.MA_CODIGO=MAESTRO.MA_CODIGO WHERE MAESTROCOST.MA_PERINI <=GETDATE() AND MAESTROCOST.MA_PERFIN >=GETDATE() AND MAESTROCOST.SPI_CODIGO IN (SELECT PAIS.SPI_CODIGO FROM DIR_CLIENTE INNER JOIN PAIS ON DIR_CLIENTE.PA_CODIGO = PAIS.PA_CODIGO INNER JOIN FACTEXP ON DIR_CLIENTE.DI_INDICE=FACTEXP.DI_DESTFIN WHERE FACTEXP.FE_CODIGO=@CONSECUTIVO) AND MA_INV_GEN='I' AND MAESTRO.MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MAESTRO.MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX AND MAESTROCOST.TCO_CODIGO=@FACTEXPDET#TCO_CODIGO)
            IF @FACTEXPDET#FED_COS_UNI IS NULL
                SELECT @FACTEXPDET#FED_COS_UNI=0
           SELECT @FACTEXPDET#EQ_IMPFO=(SELECT isnull(EQ_IMPFO,1) FROM MAESTRO WHERE MA_INV_GEN='I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#EQ_IMPFO IS NULL
                SELECT @FACTEXPDET#EQ_IMPFO=1
           SELECT @FACTEXPDET#EQ_EXPMX=(SELECT isnull(EQ_EXPMX,1) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#EQ_EXPMX IS NULL
                SELECT @FACTEXPDET#EQ_EXPMX=1
           SELECT @FACTEXPDET#CS_CODIGO=(SELECT CS_CODIGO FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#CS_CODIGO IS NULL
                SELECT @FACTEXPDET#CS_CODIGO=8
           SELECT @FACTEXPDET#CL_CODIGO=(SELECT CL_MATRIZ FROM CLIENTE WHERE CL_EMPRESA='S')
            IF @FACTEXPDET#CL_CODIGO IS NULL
                SELECT @FACTEXPDET#CL_CODIGO=0
           SELECT @FACTEXPDET#AR_IMPMX=(SELECT isnull(AR_IMPMX,0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#AR_IMPMX IS NULL
                SELECT @FACTEXPDET#AR_IMPMX=0
           SELECT @FACTEXPDET#AR_IMPFO=(SELECT 'AR_IMPFO'=CASE WHEN @FACTEXP#TQ_CODIGO=8 THEN MAESTRO.AR_DESP ELSE (CASE WHEN MAESTRO.MA_TIP_ENS='A' THEN (CASE WHEN @FACTEXP#TQ_CODIGO<>16 THEN (SELECT ANEXO24.AR_IMPFOFIS FROM ANEXO24 WHERE ANEXO24.MA_CODIGO=MAESTRO.MA_CODIGO) ELSE AR_IMPFO END) ELSE (CASE WHEN @FACTEXPDET#FED_NAFTA='S' AND isnull((dbo.Get9801(@FACTEXP#FE_FECHA, MAESTRO.MA_CODIGO, @FACTEXPDET#AR_EXPMX, @FACTEXPDET#PA_CODIGO, MAESTRO.MA_DEF_TIP)),'N')='S' AND CONFIGURATIPO.CFT_TIPO NOT IN ('P','S') THEN MAESTRO.AR_IMPFOUSA ELSE MAESTRO.AR_IMPFO END) END) END FROM MAESTRO LEFT OUTER JOIN CONFIGURATIPO ON MAESTRO.TI_CODIGO = CONFIGURATIPO.TI_CODIGO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#AR_IMPFO IS NULL
                SELECT @FACTEXPDET#AR_IMPFO=0
           SELECT @FACTEXPDET#AR_ORIG=(SELECT case when @FACTEXPDET#FED_NAFTA='S' or CONFIGURATIPO.CFT_TIPO NOT IN ('P','S') or @FACTEXPDET#FED_NG_USA=0 then 0 else ( case when isnull((select max(ar_codigo)  from bom_arancel where ba_tipocosto='N' and bom_arancel.ma_codigo=maestro.ma_codigo),0)=0 then  isnull(AR_IMPFOUSA,0)  else isnull((select max(ar_codigo) from bom_arancel where ba_tipocosto='N' and bom_arancel.ma_codigo=maestro.ma_codigo),0) end) end FROM MAESTRO LEFT OUTER JOIN CONFIGURATIPO ON MAESTRO.TI_CODIGO = CONFIGURATIPO.TI_CODIGO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#AR_ORIG IS NULL
                SELECT @FACTEXPDET#AR_ORIG=0
           SELECT @FACTEXPDET#AR_NG_EMP=(SELECT case when @FACTEXPDET#FED_NAFTA='S' or @FACTEXPDET#FED_NG_EMP=0 then 0 else isnull((select max(ar_codigo) from bom_arancel where ba_tipocosto='3' and bom_arancel.ma_codigo=maestro.ma_codigo),0) end FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#AR_NG_EMP IS NULL
                SELECT @FACTEXPDET#AR_NG_EMP=0
           SELECT @FACTEXPDET#FED_RATEIMPFO=(SELECT dbo.GetAdvalorem(@FACTEXPDET#AR_IMPFO, @FACTEXPDET#PA_CODIGO, (CASE WHEN @FACTEXPDET#FED_NAFTA='S' THEN 'P' ELSE 'G' END), 0, 0) FROM MAESTRO WHERE MA_INV_GEN = 'I' AND MA_NOPARTE=@FACTEXPDET#FED_NOPARTE AND MA_NOPARTEAUX=@FACTEXPDET#FED_NOPARTEAUX)
            IF @FACTEXPDET#FED_RATEIMPFO IS NULL
                SELECT @FACTEXPDET#FED_RATEIMPFO=0
           SELECT @FACTEXPDET#ME_GENERICO=(SELECT isnull(ME_COM,0) FROM MAESTRO WHERE MA_CODIGO=@FACTEXPDET#MA_GENERICO)
            IF @FACTEXPDET#ME_GENERICO IS NULL
                SELECT @FACTEXPDET#ME_GENERICO=0
          EXEC SP_GETCONSECUTIVO @TIPO='FED',@VALUE=@CONSDET OUTPUT
                INSERT INTO FACTEXPDET (FED_INDICED,FE_CODIGO,FED_CANT ,FED_COS_TOT ,FED_PES_NET ,FED_PES_BRU ,EQ_GEN ,FED_NOPARTEAUX ,FED_LOTE ,FED_NOORDEN ,FED_NOPARTE ,FED_PARTTYPE ,SE_CODIGO ,FED_FECHA_STRUCT ,FED_RETRABAJO ,TI_CODIGO ,TCO_CODIGO ,SPI_CODIGO ,PA_CODIGO ,ME_CODIGO ,ME_AREXPMX ,MA_GENERICO ,MA_CODIGO ,FED_TIP_ENS ,FED_SEC_IMP ,AR_EXPMX ,FED_POR_DEF ,FED_PES_UNILB ,FED_PES_UNI ,FED_NOMBRE ,FED_NG_USA ,FED_NG_MP ,FED_NG_EMP ,FED_NG_ADD ,FED_NAME ,FED_NAFTA ,FED_GRA_MP ,FED_GRA_MO ,FED_GRA_GI_MX ,FED_GRA_GI ,FED_GRA_EMP ,FED_GRA_ADD ,FED_DISCHARGE ,FED_DEF_TIP ,FED_COS_UNI ,EQ_IMPFO ,EQ_EXPMX ,CS_CODIGO ,CL_CODIGO ,AR_IMPMX ,AR_IMPFO ,AR_ORIG ,AR_NG_EMP ,FED_RATEIMPFO ,ME_GENERICO ) VALUES (@CONSDET,@CONSECUTIVO,@FACTEXPDET#FED_CANT ,@FACTEXPDET#FED_COS_TOT ,@FACTEXPDET#FED_PES_NET ,@FACTEXPDET#FED_PES_BRU ,@FACTEXPDET#EQ_GEN ,@FACTEXPDET#FED_NOPARTEAUX ,@FACTEXPDET#FED_LOTE ,@FACTEXPDET#FED_NOORDEN ,@FACTEXPDET#FED_NOPARTE ,@FACTEXPDET#FED_PARTTYPE,@FACTEXPDET#SE_CODIGO,@FACTEXPDET#FED_FECHA_STRUCT,@FACTEXPDET#FED_RETRABAJO,@FACTEXPDET#TI_CODIGO,@FACTEXPDET#TCO_CODIGO,@FACTEXPDET#SPI_CODIGO,@FACTEXPDET#PA_CODIGO,@FACTEXPDET#ME_CODIGO,@FACTEXPDET#ME_AREXPMX,@FACTEXPDET#MA_GENERICO,@FACTEXPDET#MA_CODIGO,@FACTEXPDET#FED_TIP_ENS,@FACTEXPDET#FED_SEC_IMP,@FACTEXPDET#AR_EXPMX,@FACTEXPDET#FED_POR_DEF,@FACTEXPDET#FED_PES_UNILB,@FACTEXPDET#FED_PES_UNI,@FACTEXPDET#FED_NOMBRE,@FACTEXPDET#FED_NG_USA,@FACTEXPDET#FED_NG_MP,@FACTEXPDET#FED_NG_EMP,@FACTEXPDET#FED_NG_ADD,@FACTEXPDET#FED_NAME,@FACTEXPDET#FED_NAFTA,@FACTEXPDET#FED_GRA_MP,@FACTEXPDET#FED_GRA_MO,@FACTEXPDET#FED_GRA_GI_MX,@FACTEXPDET#FED_GRA_GI,@FACTEXPDET#FED_GRA_EMP,@FACTEXPDET#FED_GRA_ADD,@FACTEXPDET#FED_DISCHARGE,@FACTEXPDET#FED_DEF_TIP,@FACTEXPDET#FED_COS_UNI,@FACTEXPDET#EQ_IMPFO,@FACTEXPDET#EQ_EXPMX,@FACTEXPDET#CS_CODIGO,@FACTEXPDET#CL_CODIGO,@FACTEXPDET#AR_IMPMX,@FACTEXPDET#AR_IMPFO,@FACTEXPDET#AR_ORIG,@FACTEXPDET#AR_NG_EMP,@FACTEXPDET#FED_RATEIMPFO,@FACTEXPDET#ME_GENERICO)
              update FACTEXPDET set FED_COS_TOT = ( (dbo.StrToFloat(SUBSTRING(@Col_4,1,5)+'.'+SUBSTRING(@Col_4,6,2)))*FACTEXPDET.FED_COS_UNI )
              from FACTEXPDET
              left outer join FACTEXP on  
             FACTEXP.FE_CODIGO = FACTEXPDET.FE_CODIGO
              where FACTEXPDET.FED_INDICED = @CONSDET
              update FACTEXPDET set FED_PES_NET = ( (dbo.StrToFloat(SUBSTRING(@Col_4,1,5)+'.'+SUBSTRING(@Col_4,6,2)))*FACTEXPDET.FED_PES_UNI )
              from FACTEXPDET
              left outer join FACTEXP on  
             FACTEXP.FE_CODIGO = FACTEXPDET.FE_CODIGO
              where FACTEXPDET.FED_INDICED = @CONSDET
              update FACTEXPDET set FED_PES_BRU = ( (dbo.StrToFloat(SUBSTRING(@Col_4,1,5)+'.'+SUBSTRING(@Col_4,6,2)))*FACTEXPDET.FED_PES_UNI )
              from FACTEXPDET
              left outer join FACTEXP on  
             FACTEXP.FE_CODIGO = FACTEXPDET.FE_CODIGO
              where FACTEXPDET.FED_INDICED = @CONSDET
                      FETCH NEXT FROM CUR_TEMPIMPORT162DET INTO @Col_4 ,@Cod_3 ,@FACTEXPDET#FED_CANT ,@FACTEXPDET#FED_COS_TOT ,@FACTEXPDET#FED_PES_NET ,@FACTEXPDET#FED_PES_BRU ,@FACTEXPDET#EQ_GEN ,@FACTEXPDET#FED_NOPARTEAUX ,@FACTEXPDET#FED_LOTE ,@FACTEXPDET#FED_NOORDEN ,@FACTEXPDET#FED_NOPARTE 
        END
        CLOSE CUR_TEMPIMPORT162DET
        DEALLOCATE CUR_TEMPIMPORT162DET
  END
  FETCH NEXT FROM CUR_TEMPIMPORT162 INTO @Col_4 ,@Cod_3 ,@FACTEXP#FE_FOLIO ,@FACTEXP#FE_TIPO ,@FACTEXP#TQ_CODIGO ,@FACTEXP#TF_CODIGO 
END
CLOSE CUR_TEMPIMPORT162
DEALLOCATE CUR_TEMPIMPORT162
GO
