SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO







































CREATE PROCEDURE dbo.SP_REPPPSIMPDEFACTFIJ ( @DAPCODIGO INT)   as

SET NOCOUNT ON 

DECLARE @IMPDEFINITIVAS decimal(38,6), @IMPDEFINITIVASdlls decimal(38,6)


if exists (select * FROM VREPPPSIMPDEFACTFIJ WHERE DAP_CODIGO = @DAPCODIGO)
begin
DECLARE CUR_DECANUALPPSTIMPDEFACTFIJ CURSOR FOR

SELECT     SUM(VALOR), SUM(DLLS)
FROM         VREPPPSIMPDEFACTFIJ
WHERE     DAP_CODIGO = @DAPCODIGO
GROUP BY DAP_CODIGO
OPEN CUR_DECANUALPPSTIMPDEFACTFIJ
		
FETCH NEXT FROM CUR_DECANUALPPSTIMPDEFACTFIJ INTO @IMPDEFINITIVAS, @IMPDEFINITIVASdlls

WHILE (@@FETCH_STATUS = 0) 
BEGIN


	UPDATE DECANUALPPS
	SET DAP_IMPDEFINITIVASACTFIJ= floor(round(@IMPDEFINITIVAS, 0)/1000), DAP_IMPDEFINITIVASACTFIJUSD= floor(round(@IMPDEFINITIVASdlls, 0)/1000)
	WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO

	FETCH NEXT FROM CUR_DECANUALPPSTIMPDEFACTFIJ INTO @IMPDEFINITIVAS, @IMPDEFINITIVASdlls

END


CLOSE CUR_DECANUALPPSTIMPDEFACTFIJ
DEALLOCATE CUR_DECANUALPPSTIMPDEFACTFIJ
end
else
begin
	UPDATE DECANUALPPS
	SET DAP_IMPDEFINITIVASACTFIJ=0, DAP_IMPDEFINITIVASACTFIJUSD=0
	WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO

end






































GO
