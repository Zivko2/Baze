SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_PEDIMPITN] (@PI_CODIGO int)   as

declare @PI_TIP_CAM decimal(38,6)

	select @PI_TIP_CAM=PI_TIP_CAM from pedimp where pi_codigo=@PI_CODIGO

INSERT INTO PEDIMPITN (PI_CODIGO, ITN_TEXTO, ITN_TIPO)
SELECT    @PI_CODIGO, REPLACE(FI_NUM_INBON, '/', ''), 'B'
FROM         FACTIMP
WHERE     (TN_CODIGO = 1) AND (PI_CODIGO = @PI_CODIGO OR PI_RECTIFICA = @PI_CODIGO)
AND REPLACE(FI_NUM_INBON, '/', '') IS NOT NULL



--OPCION 4

INSERT INTO PEDIMPITN (PI_CODIGO, ITN_TEXTO, ITN_TIPO)
SELECT     @PI_CODIGO, CLIENTE.CL_EIN + '-' + CLIENTE_1.CL_EIN, 'O'
FROM         FACTIMP INNER JOIN
                      CLIENTE ON FACTIMP.PR_CODIGO = CLIENTE.CL_CODIGO INNER JOIN
                      CLIENTE CLIENTE_1 ON FACTIMP.CL_DESTINT = CLIENTE_1.CL_CODIGO
WHERE     (FACTIMP.TN_CODIGO = 11) AND (FACTIMP.PI_CODIGO = @PI_CODIGO OR FACTIMP.PI_RECTIFICA = @PI_CODIGO)
AND (CLIENTE.CL_EIN + CLIENTE_1.CL_EIN) IS NOT NULL


-- ITN
INSERT INTO PEDIMPITN (PI_CODIGO, ITN_TEXTO, ITN_TIPO)
SELECT     @PI_CODIGO, REPLACE(FI_ITN, '/', ''), 'I'
FROM         FACTIMP
WHERE     (TN_CODIGO = 10) AND (PI_CODIGO = @PI_CODIGO OR PI_RECTIFICA = @PI_CODIGO)
AND REPLACE(FI_ITN, '/', '') IS NOT NULL


--<=2500
INSERT INTO PEDIMPITN (PI_CODIGO, ITN_TEXTO, ITN_TIPO)
SELECT     @PI_CODIGO, round(SUM(dbo.FACTIMPDET.FID_COS_TOT)*@PI_TIP_CAM,0), 'M'
FROM         dbo.FACTIMP INNER JOIN
                      dbo.FACTIMPDET ON dbo.FACTIMP.FI_CODIGO = dbo.FACTIMPDET.FI_CODIGO
WHERE     (dbo.FACTIMP.TN_CODIGO = 12) AND (dbo.FACTIMP.PI_CODIGO = @PI_CODIGO OR dbo.FACTIMP.PI_RECTIFICA = @PI_CODIGO)



























GO
