SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE procedure dbo.SP_CALCULAR_EMPAQUE_ADICIONAL (@PRO_CODIGO INT)   as

SET NOCOUNT ON 

INSERT INTO PRODUCCIONEMPAQUEADICIONAL(PRO_CODIGO,MA_CODIGO,MA_NOPARTE,PROAD_CANTIDAD,MA_GENERICO,EQ_GEN,ME_CODIGO)
SELECT     @PRO_CODIGO, dbo.MAESTROEMPAQUEADICIONAL.MA_EMPAQUE,  (SELECT MA_NOPARTE FROM MAESTRO WHERE MA_CODIGO=dbo.MAESTROEMPAQUEADICIONAL.MA_EMPAQUE), SUM(ISNULL(dbo.PRODUCDET.PROD_CANT, 0) 
                      * ISNULL(dbo.MAESTROEMPAQUEADICIONAL.FEAD_CANTIDAD, 0)) AS cantidad, dbo.MAESTRO.MA_GENERICO, dbo.MAESTRO.EQ_GEN, 
                      dbo.PRODUCDET.ME_CODIGO
FROM         dbo.MAESTRO RIGHT OUTER JOIN
                      dbo.MAESTROEMPAQUEADICIONAL ON dbo.MAESTRO.MA_CODIGO = dbo.MAESTROEMPAQUEADICIONAL.MA_EMPAQUE RIGHT OUTER JOIN
                      dbo.PRODUCDET ON dbo.MAESTROEMPAQUEADICIONAL.MA_CODIGO = dbo.PRODUCDET.MA_CODIGO
WHERE     (dbo.PRODUCDET.PRO_CODIGO = @PRO_CODIGO) AND
	     dbo.MAESTROEMPAQUEADICIONAL.MA_EMPAQUE NOT IN (SELECT MA_CODIGO FROM PRODUCCIONEMPAQUEADICIONAL WHERE PRO_CODIGO=@PRO_CODIGO)
GROUP BY dbo.MAESTROEMPAQUEADICIONAL.MA_EMPAQUE, dbo.PRODUCDET.ME_CODIGO, dbo.MAESTRO.MA_GENERICO, 
                      dbo.MAESTRO.EQ_GEN
HAVING      (SUM(ISNULL(dbo.PRODUCDET.PROD_CANT, 0) * ISNULL(dbo.MAESTROEMPAQUEADICIONAL.FEAD_CANTIDAD, 0)) > 0)


GO
