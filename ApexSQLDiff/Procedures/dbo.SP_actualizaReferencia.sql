SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[SP_actualizaReferencia] (@fi_codigo int)   as

declare @ma_generico int, @AR_IMPMX INT, @FID_SEC_IMP INT, @MA_CODIGO INT, @FECHA DATETIME, @PR_CODIGO INT

	SELECT @FECHA=FI_FECHA, @PR_CODIGO=PR_CODIGO FROM FACTIMP WHERE FI_CODIGO=@fi_codigo

DECLARE cur_reglaoctava CURSOR FOR
	SELECT     CPE_CODIGO
	FROM         FACTIMPDET INNER JOIN FACTIMPPERM ON FACTIMPDET.FID_INDICED = FACTIMPPERM.FID_INDICED
	WHERE FID_DEF_TIP='R' AND FACTIMPDET.FI_CODIGO=@fi_codigo
	GROUP BY CPE_CODIGO
open cur_reglaoctava
	FETCH NEXT FROM cur_reglaoctava INTO @ma_generico

	WHILE (@@FETCH_STATUS = 0) 
	BEGIN
		UPDATE FACTIMPDET
		SET FID_REFTASA= (SELECT     MIN(PERMISO.PE_PERMISO) FROM         PERMISODET RIGHT OUTER JOIN
			                      PERMISO ON PERMISODET.PE_CODIGO = PERMISO.PE_CODIGO LEFT OUTER JOIN
			                      IDENTIFICA ON PERMISO.IDE_CODIGO = IDENTIFICA.IDE_CODIGO
					WHERE     (dbo.IDENTIFICA.IDE_CLAVE = 'C1') AND (dbo.PERMISODET.MA_GENERICO = @ma_generico)
				        and PERMISO.PE_PERMISO IS NOT NULL)

		WHERE MA_GENERICO=@ma_generico
		AND FID_DEF_TIP='R' AND FI_CODIGO=@fi_codigo



	FETCH NEXT FROM cur_reglaoctava INTO @ma_generico

END

CLOSE cur_reglaoctava
DEALLOCATE cur_reglaoctava


-- PPS
	UPDATE FACTIMPDET
	SET FID_REFTASA= (SELECT MIN(CONVERT(varchar(5), dbo.PERMISO.PE_ANIO) + '-' + dbo.PERMISO.PE_PERMISO) 
			         FROM dbo.PERMISODET RIGHT OUTER JOIN
		                      dbo.PERMISO ON dbo.PERMISODET.PE_CODIGO = dbo.PERMISO.PE_CODIGO LEFT OUTER JOIN
			         dbo.IDENTIFICA ON dbo.PERMISO.IDE_CODIGO = dbo.IDENTIFICA.IDE_CODIGO
				         WHERE     (dbo.PERMISODET.SE_CODIGO = FACTIMPDET.FID_SEC_IMP) AND (dbo.PERMISODET.AR_IMPMX = FACTIMPDET.AR_IMPMX) AND (dbo.IDENTIFICA.IDE_CLAVE = 'PS')
			         HAVING MIN(CONVERT(varchar(5), dbo.PERMISO.PE_ANIO) + '-' + dbo.PERMISO.PE_PERMISO) IS NOT NULL)
	WHERE FID_DEF_TIP='S' AND FI_CODIGO=@fi_codigo




	
	IF (SELECT CF_USAPROVEECERTORIG FROM CONFIGURACION)='S'
	BEGIN
	
		
		UPDATE FACTIMPDET
		SET FID_REFTASA= (SELECT     MIN(dbo.CERTORIGMP.CMP_FOLIO) as Certificado
					FROM         dbo.CERTORIGMP LEFT OUTER JOIN
					                      dbo.CERTORIGMPDET ON dbo.CERTORIGMP.CMP_CODIGO = dbo.CERTORIGMPDET.CMP_CODIGO
					WHERE     (dbo.CERTORIGMP.CMP_VFECHA >= @FECHA) AND 
					          (dbo.CERTORIGMP.CMP_IFECHA <= @FECHA) AND (dbo.CERTORIGMP.PR_CODIGO = @PR_CODIGO) AND
					          (dbo.CERTORIGMPDET.MA_CODIGO = FACTIMPDET.MA_CODIGO)
					AND dbo.CERTORIGMP.CMP_FOLIO IS NOT NULL)
		WHERE FID_DEF_TIP='P' AND FI_CODIGO=@fi_codigo
	
	
		UPDATE FACTIMPDET
		SET FID_FECHAREFTASA= (SELECT   CMP_IFECHA
				  FROM CERTORIGMP 
				  WHERE CMP_FOLIO =FID_REFTASA)
		WHERE FID_DEF_TIP='P' AND FI_CODIGO=@fi_codigo
	
	END
	ELSE
	BEGIN
		UPDATE FACTIMPDET
		SET FID_REFTASA= (SELECT     MIN(dbo.CERTORIGMP.CMP_FOLIO) as Certificado
					FROM         dbo.CERTORIGMP LEFT OUTER JOIN
					                      dbo.CERTORIGMPDET ON dbo.CERTORIGMP.CMP_CODIGO = dbo.CERTORIGMPDET.CMP_CODIGO
					WHERE     (dbo.CERTORIGMP.CMP_VFECHA >= @FECHA) AND 
					          (dbo.CERTORIGMP.CMP_IFECHA <= @FECHA)  AND
					          (dbo.CERTORIGMPDET.MA_CODIGO = FACTIMPDET.MA_CODIGO)
					AND dbo.CERTORIGMP.CMP_FOLIO IS NOT NULL)
		WHERE FID_DEF_TIP='P' AND FI_CODIGO=@fi_codigo
	
	
		UPDATE FACTIMPDET
		SET FID_FECHAREFTASA= (SELECT   CMP_IFECHA
				  FROM CERTORIGMP 
				  WHERE CMP_FOLIO =FID_REFTASA)
		WHERE FID_DEF_TIP='P' AND FI_CODIGO=@fi_codigo
	
	END


GO
