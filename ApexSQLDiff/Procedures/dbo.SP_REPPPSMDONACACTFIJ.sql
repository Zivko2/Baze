SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

















































CREATE PROCEDURE dbo.SP_REPPPSMDONACACTFIJ ( @DAPCODIGO INT)   as

SET NOCOUNT ON 

DECLARE @MERCADONAC decimal(38,6), @MERCADONACdlls decimal(38,6)


if exists (select * 	FROM VREPPPSMDONACACTFIJ WHERE DAP_CODIGO=@DAPCODIGO)
begin
	DECLARE CUR_DECANUALPPSTMDONACACTFIJ CURSOR FOR
	
		SELECT SUM(VALOR), SUM(PID_CTOT_DLS)
		FROM VREPPPSMDONACACTFIJ
		WHERE DAP_CODIGO=@DAPCODIGO
		GROUP BY DAP_CODIGO 
	
	OPEN CUR_DECANUALPPSTMDONACACTFIJ
			
	FETCH NEXT FROM CUR_DECANUALPPSTMDONACACTFIJ INTO @MERCADONAC, @MERCADONACdlls
	
	WHILE (@@FETCH_STATUS = 0) 
	BEGIN
	
	
		UPDATE DECANUALPPS
		SET DAP_MERCADONACACTFIJ= floor(round(@MERCADONAC, 0)/1000),  DAP_MERCADONACACTFIJUSD= floor(round(@MERCADONACdlls, 0)/1000)
		WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO
	
		FETCH NEXT FROM CUR_DECANUALPPSTMDONACACTFIJ INTO @MERCADONAC, @MERCADONACdlls
	
	END
	
	
	CLOSE CUR_DECANUALPPSTMDONACACTFIJ
	DEALLOCATE CUR_DECANUALPPSTMDONACACTFIJ
end
else
begin
	UPDATE DECANUALPPS
	SET DAP_MERCADONACACTFIJ=0,  DAP_MERCADONACACTFIJUSD= 0
	WHERE DECANUALPPS.DAP_CODIGO = @DAPCODIGO

end
















































GO
