SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO



























CREATE PROCEDURE [dbo].[SP_IMPORTMPTYCOJUA] (@TABLA VARCHAR(150), @USER INT)  as

			DELETE FROM REGISTROSIMPORTADOS WHERE RI_CBFORMA=28 AND RI_USERID = @USER


exec('          UPDATE MAESTRO SET MA_ULTIMAMODIF=GETDATE() 
		  WHERE MA_NOPARTE IN 
			(SELECT MAESTRO'+@USER+'#MA_NOPARTE
			FROM TEMPIMPORT141_'+@USER+' 
			GROUP BY MAESTRO'+@USER+'#MA_NOPARTE)')



exec('                  UPDATE MAESTRO 
		  SET MA_TIP_ENS=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_TIP_ENS, 
			MA_NOPARTE=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE, 
			TI_CODIGO=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#TI_CODIGO, 
			MA_NAME=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NAME, 
			MA_NOMBRE=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOMBRE, 
			PA_ORIGEN=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#PA_ORIGEN, 
			PA_PROCEDE=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#PA_PROCEDE, 
			AR_IMPMX=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#AR_IMPMX, 
			AR_EXPMX=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#AR_EXPMX, 
			AR_IMPFOUSA=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#AR_IMPFOUSA, 
			AR_EXPFO=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#AR_EXPFO, 
			AR_IMPFO=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#AR_IMPFO, 
			MA_DEF_TIP=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_DEF_TIP, 
			MA_SEC_IMP=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_SEC_IMP, 
			MA_PESO_LB=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_PESO_LB,
			MA_PESO_KG=TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_PESO_KG
 		  FROM MAESTRO INNER JOIN
		                      TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE
		  WHERE (MAESTRO.MA_INV_GEN = ''I'')')


   	        exec SP_CREATABLALOG 41
   	        
exec('	        insert into sysusrlog41 (user_id, mov_id, referencia, frmtag, fechahora) 
 	        SELECT     @USER, 2, ''Actualizacion de mp Info. (No. Parte: ''+MAESTRO.MA_NOPARTE+'')'', 41, getdate()
		  FROM MAESTRO INNER JOIN
	                      TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE
	        WHERE (MAESTRO.MA_INV_GEN = ''I'')')



		-- REGISTROS ACTUALIZADOS
exec('                INSERT INTO REGISTROSIMPORTADOS (RI_REGISTRO,RI_TIPO,RI_CBFORMA, RI_USERID) 
		SELECT ''MA_NOPARTE = ''+CONVERT(varchar(100),MAESTRO'+@USER+'#MA_NOPARTE)+'', MA_INV_GEN = I, MA_NOPARTEAUX = ''+CONVERT(varchar(100),MAESTRO'+@USER+'#MA_NOPARTEAUX),''A'',28,'+@USER+
		' FROM MAESTRO INNER JOIN
		                    TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE
		WHERE (MAESTRO.MA_INV_GEN = ''I'')')


		-- REGISTROS ANEXADOS
exec('                INSERT INTO REGISTROSIMPORTADOS (RI_REGISTRO,RI_TIPO,RI_CBFORMA. RI_USERID) 
		SELECT ''MA_NOPARTE = ''+CONVERT(varchar(100),MAESTRO'+@USER+'#MA_NOPARTE)+'', MA_INV_GEN = I, MA_NOPARTEAUX = ''+CONVERT(varchar(100),MAESTRO'+@USER+'#MA_NOPARTEAUX),''I'',28,'+@USER+
		' FROM TEMPIMPORT141_'+@USER+'
		WHERE MAESTRO'+@USER+'#MA_NOPARTE NOT IN (SELECT MA_NOPARTE FROM MAESTRO WHERE MA_INV_GEN=''I'')')


		exec Sp_GeneraTablaTemp 'MAESTRO'




exec('	       INSERT INTO TempImportMAESTRO (SPI_CODIGO ,MA_INV_GEN ,MA_NOPARTEAUX ,MA_TIP_ENS ,MA_NOPARTE ,TI_CODIGO,
				MA_NAME ,MA_NOMBRE ,ME_COM ,PA_ORIGEN ,PA_PROCEDE ,MA_GENERICO ,AR_IMPMX ,AR_EXPMX ,AR_IMPFOUSA ,
				AR_EXPFO ,AR_IMPFO ,MA_DEF_TIP ,MA_SEC_IMP ,MA_PESO_LB ) 
		SELECT 22, MAESTRO'+@USER+'#MA_INV_GEN, MAESTRO'+@USER+'#MA_NOPARTEAUX, MAESTRO'+@USER+'#MA_TIP_ENS,
			MAESTRO'+@USER+'#MA_NOPARTE,MAESTRO'+@USER+'#TI_CODIGO, MAESTRO'+@USER+'#MA_NAME, MAESTRO'+@USER+'#MA_NOMBRE, MAESTRO'+@USER+'#ME_COM, MAESTRO'+@USER+'#PA_ORIGEN,
			MAESTRO'+@USER+'#PA_PROCEDE,(select MA_CODIGO from maestro where ma_inv_gen=''g'' and ma_noparte=''rev''), MAESTRO'+@USER+'#AR_IMPMX, MAESTRO'+@USER+'#AR_EXPMX, MAESTRO'+@USER+'#AR_IMPFOUSA,
			MAESTRO'+@USER+'#AR_EXPFO, MAESTRO'+@USER+'#AR_IMPFO, MAESTRO'+@USER+'#MA_DEF_TIP, MAESTRO'+@USER+'#MA_SEC_IMP, MAESTRO'+@USER+'#MA_PESO_LB
		FROM TEMPIMPORT141_'+@USER+'
		WHERE MAESTRO'+@USER+'#MA_NOPARTE NOT IN (SELECT MA_NOPARTE FROM MAESTRO WHERE MA_INV_GEN=''I'')')


		INSERT INTO MAESTRO(MA_CODIGO, SPI_CODIGO ,MA_INV_GEN ,MA_NOPARTEAUX ,MA_TIP_ENS ,MA_NOPARTE ,TI_CODIGO,
				MA_NAME ,MA_NOMBRE ,ME_COM ,PA_ORIGEN ,PA_PROCEDE ,MA_GENERICO ,AR_IMPMX ,AR_EXPMX ,AR_IMPFOUSA ,
				AR_EXPFO ,AR_IMPFO ,MA_DEF_TIP ,MA_SEC_IMP ,MA_PESO_LB, MA_ULTIMAMODIF)

		SELECT MA_CODIGO, SPI_CODIGO ,MA_INV_GEN ,MA_NOPARTEAUX ,MA_TIP_ENS ,MA_NOPARTE ,TI_CODIGO,
				MA_NAME ,MA_NOMBRE ,ME_COM ,PA_ORIGEN ,PA_PROCEDE ,MA_GENERICO ,AR_IMPMX ,AR_EXPMX ,AR_IMPFOUSA ,				AR_EXPFO ,AR_IMPFO ,MA_DEF_TIP ,MA_SEC_IMP ,MA_PESO_LB, GETDATE()
		FROM TempImportMAESTRO


		declare @maximo int

		select @maximo= max(MA_CODIGO) from MAESTRO

		if exists(select * from maestrorefer) and (select isnull(max(ma_codigo),0) from maestrorefer)>@maximo
		select @maximo= isnull(max(MA_CODIGO),0) from MAESTROREFER


		update consecutivo
		set cv_codigo =  @maximo+1
		where cv_tipo = 'MA'


		/* ============ MARESTRODEF ===========*/

		exec Sp_GeneraTablaTemp 'MAESTRODEF'

exec('		UPDATE MAESTRODEF
		SET  MA_DEFTXT1= isnull(TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFTXT1,''''), 
		     MA_DEFTXT2=isnull(TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFTXT2,''''), 
                     MA_DEFTXT3=isnull(TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFTXT3,''''), 
		     MA_DEFBOL1=TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFBOL1, 
		     MA_DEFBOL2=TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFBOL2, 
                     MA_DEFDATE1=TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFDATE1, 
		     MA_DEFDATE2=TEMPIMPORT141_'+@USER+'.MAESTRODEF'+@USER+'#MA_DEFDATE2
		FROM         TEMPIMPORT141_'+@USER+' INNER JOIN
		                      MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE INNER JOIN
		                      MAESTRODEF ON MAESTRO.MA_CODIGO = MAESTRODEF.MA_CODIGO')



exec('		insert into TempImportMAESTRODEF (MA_CODIGO,MA_DEFTXT1 ,MA_DEFTXT2 ,MA_DEFTXT3 ,MA_DEFBOL1 ,MA_DEFBOL2 ,MA_DEFDATE1 ,MA_DEFDATE2 )
		SELECT MAESTRO.MA_CODIGO, isnull(MAESTRODEF'+@USER+'#MA_DEFTXT1,''''), isnull(MAESTRODEF'+@USER+'#MA_DEFTXT2,''''), isnull(MAESTRODEF'+@USER+'#MA_DEFTXT3,''''), MAESTRODEF'+@USER+'#MA_DEFBOL1 ,MAESTRODEF'+@USER+'#MA_DEFBOL2, MAESTRODEF'+@USER+'#MA_DEFDATE1 ,MAESTRODEF'+@USER+'#MA_DEFDATE2 
		FROM TEMPIMPORT141_'+@USER+' INNER JOIN
		     MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE
		WHERE MAESTRO.MA_CODIGO NOT IN (SELECT MA_CODIGO FROM MAESTRODEF)')

		INSERT INTO MAESTRODEF(MAD_CODIGO, MA_CODIGO,MA_DEFTXT1 ,MA_DEFTXT2 ,MA_DEFTXT3 ,MA_DEFBOL1 ,MA_DEFBOL2 ,MA_DEFDATE1 ,MA_DEFDATE2)
		SELECT MAD_CODIGO, MA_CODIGO,MA_DEFTXT1 ,MA_DEFTXT2 ,MA_DEFTXT3 ,MA_DEFBOL1 ,MA_DEFBOL2 ,MA_DEFDATE1 ,MA_DEFDATE2
		FROM TempImportMAESTRODEF



		update consecutivo
		set cv_codigo =  isnull((select max(MAD_CODIGO) from MAESTRODEF),0) + 1
		where cv_tipo = 'MAD'




		/* ============ MARESTROCATEG ===========*/

/*		DELETE FROM MAESTROCATEG WHERE MA_CODIGO IN
		(SELECT MAESTRO.MA_CODIGO
		FROM TEMPIMPORT141_'+@USER+' INNER JOIN
		     MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE
		WHERE MAESTROCATEG'+@USER+'#CPE_CODIGO IS NOT NULL
		GROUP BY MAESTRO.MA_CODIGO)


		INSERT INTO MAESTROCATEG (MA_CODIGO,CPE_CODIGO )
		SELECT MAESTRO.MA_CODIGO, MAESTROCATEG'+@USER+'#CPE_CODIGO
		FROM TEMPIMPORT141_'+@USER+' INNER JOIN
		     MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE
		WHERE CONVERT(VARCHAR(150),MAESTRO.MA_CODIGO)+'-'+CONVERT(VARCHAR(150),MAESTROCATEG'+@USER+'#CPE_CODIGO)
		NOT IN (SELECT CONVERT(VARCHAR(150),MA_CODIGO)+'-'+CONVERT(VARCHAR(150),CPE_CODIGO) FROM MAESTROCATEG)

*/
		/* ============ MARESTROCOST ===========*/

/* para que guarde historial, ahorita se importa y solo queda un costo


                  UPDATE MAESTROCOST 
		  SET MAESTROCOST.MA_PERFIN =convert(varchar(11),getdate()-1,101) 
		  FROM MAESTRO INNER JOIN MAESTROCOST ON MAESTRO.MA_CODIGO = MAESTROCOST.MA_CODIGO 	  	
                  WHERE MAESTRO.MA_NOPARTE IN (SELECT T1.MAESTRO'+@USER+'#MA_NOPARTE FROM TEMPIMPORT141_'+@USER+' T1 GROUP BY T1.MAESTRO'+@USER+'#MA_NOPARTE)
			AND MAESTROCOST.MAC_CODIGO in (SELECT MAESTROCOST.MAC_CODIGO
						FROM TEMPIMPORT141_'+@USER+' INNER JOIN
						                      MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE INNER JOIN
						                      MAESTROCOST ON MAESTRO.MA_CODIGO = MAESTROCOST.MA_CODIGO AND 
						                      TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#TCO_CODIGO = MAESTROCOST.TCO_CODIGO AND 
						                      MAESTROCOST.SPI_CODIGO = 22
						GROUP BY MAESTROCOST.MAC_CODIGO)


		UPDATE MAESTROCOST
		SET     MAESTROCOST.MA_COSTO= TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_COSTO
		FROM         MAESTRO INNER JOIN
		                      MAESTROCOST ON MAESTRO.MA_CODIGO = MAESTROCOST.MA_CODIGO INNER JOIN
		                      TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE AND 
		                      MAESTROCOST.TCO_CODIGO = TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#TCO_CODIGO AND 
		                      MAESTROCOST.MA_PERINI = TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_PERINI AND 
		                      MAESTROCOST.SPI_CODIGO = 22 AND 
		                      MAESTROCOST.MA_COSTO <> TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_COSTO


                   INSERT INTO MAESTROCOST (MA_CODIGO,SPI_CODIGO ,TCO_CODIGO ,MA_PERINI ,MA_COSTO ) 
		   SELECT MAESTRO.MA_CODIGO, 22, MAESTROCOST'+@USER+'#TCO_CODIGO, MAESTROCOST'+@USER+'#MA_PERINI, MAX(MAESTROCOST'+@USER+'#MA_COSTO)
		   FROM TEMPIMPORT141_'+@USER+' INNER JOIN
		        MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE
		   WHERE convert(varchar(150),MAESTRO.MA_CODIGO)+ convert(varchar(150),22)+convert(varchar(150),MAESTROCOST'+@USER+'#TCO_CODIGO)+convert(varchar(150),MAESTROCOST'+@USER+'#MA_PERINI) not in
			(select convert(varchar(150),maestrocost.MA_CODIGO)+ convert(varchar(150),maestrocost.SPI_CODIGO)+convert(varchar(150),maestrocost.TCO_CODIGO)+convert(varchar(150),maestrocost.MA_PERINI) 
			from maestrocost where maestrocost.ma_codigo=MAESTRO.MA_CODIGO)
		   GROUP BY MAESTRO.MA_CODIGO, MAESTROCOST'+@USER+'#TCO_CODIGO, MAESTROCOST'+@USER+'#MA_PERINI

*/
  	        exec SP_CREATABLALOG 41
  	        
exec('	    insert into sysusrlog41 (user_id, mov_id, referencia, frmtag, fechahora) 
		SELECT     @USER, 2, ''Act. Imp. Datos, No. Parte: ''+MAESTRO.MA_NOPARTE+'', Costo Unitario: ''+convert(varchar(50),MAESTROCOST.MA_COSTO), 41, getdate()
		FROM         MAESTRO INNER JOIN
		                      MAESTROCOST ON MAESTRO.MA_CODIGO = MAESTROCOST.MA_CODIGO INNER JOIN
		                      TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE AND 
		                      MAESTROCOST.TCO_CODIGO = TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#TCO_CODIGO AND 
		                      MAESTROCOST.SPI_CODIGO = 22 AND 
		                      MAESTROCOST.MA_COSTO <> TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_COSTO')


exec('		UPDATE MAESTROCOST
		SET     MAESTROCOST.MA_COSTO= TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_COSTO
		FROM         MAESTRO INNER JOIN
		                      MAESTROCOST ON MAESTRO.MA_CODIGO = MAESTROCOST.MA_CODIGO INNER JOIN
		                      TEMPIMPORT141_'+@USER+' ON MAESTRO.MA_NOPARTE = TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE AND 
		                      MAESTROCOST.TCO_CODIGO = TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#TCO_CODIGO AND 
		                      MAESTROCOST.SPI_CODIGO = 22 AND 
		                      MAESTROCOST.MA_COSTO <> TEMPIMPORT141_'+@USER+'.MAESTROCOST'+@USER+'#MA_COSTO')



exec('    INSERT INTO MAESTROCOST (MA_CODIGO,SPI_CODIGO ,TCO_CODIGO ,MA_PERINI ,MA_COSTO ) 
		   SELECT MAESTRO.MA_CODIGO, 22, MAESTROCOST'+@USER+'#TCO_CODIGO, MIN(MAESTROCOST'+@USER+'#MA_PERINI), MAX(MAESTROCOST'+@USER+'#MA_COSTO)
		   FROM TEMPIMPORT141_'+@USER+' INNER JOIN
		        MAESTRO ON TEMPIMPORT141_'+@USER+'.MAESTRO'+@USER+'#MA_NOPARTE = MAESTRO.MA_NOPARTE
		   WHERE convert(varchar(150),MAESTRO.MA_CODIGO)+ convert(varchar(150),22)+convert(varchar(150),MAESTROCOST'+@USER+'#TCO_CODIGO) not in
			(select convert(varchar(150),maestrocost.MA_CODIGO)+ convert(varchar(150),maestrocost.SPI_CODIGO)+convert(varchar(150),maestrocost.TCO_CODIGO)
			from maestrocost where maestrocost.ma_codigo=MAESTRO.MA_CODIGO)
		   GROUP BY MAESTRO.MA_CODIGO, MAESTROCOST'+@USER+'#TCO_CODIGO')


UPDATE MAESTRO
SET     MAESTRO.MA_NOMBRE= MAESTRO_1.MA_NOMBRE
FROM         MAESTRO INNER JOIN
                      MAESTRO MAESTRO_1 ON MAESTRO.MA_NAME = MAESTRO_1.MA_NAME AND MAESTRO.AR_IMPMX = MAESTRO_1.AR_IMPMX
WHERE     (MAESTRO.MA_NOMBRE LIKE '%SIN PERMISO%') AND (NOT (MAESTRO_1.MA_NOMBRE LIKE '%SIN PERMISO%') AND 
                      MAESTRO_1.MA_NOMBRE <> '')





GO
