SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO



CREATE procedure [dbo].InformacionBaseParaCalcularPagoArt303 (@PICODIGO int)   as

--Paso #1
if not exists (SELECT name FROM dbo.sysobjects WHERE dbo.sysobjects.name = 'KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303')
begin
	--drop table KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303
	--select * from KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303
	select top 0 *,cast(null as int) as PedExp_codigo
	into KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303
	from kardespedPPS
	------where kap_codigo = (select max(kap_codigo) from kardespedPPS)
	

	--if not exists (SELECT dbo.syscolumns.name FROM dbo.syscolumns INNER JOIN dbo.sysobjects ON dbo.syscolumns.id = dbo.sysobjects.id
	--WHERE (dbo.sysobjects.name = 'KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303') AND (dbo.syscolumns.name = 'PedExp_codigo'))
	--begin
        --	ALTER TABLE [KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303] ADD [PedExp_codigo] [int] NULL 
	--end 
	
	------truncate table KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303
	
end 
else
begin
	delete from KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303 where PedExp_codigo =@PICODIGO --04699 
end

if not exists (SELECT name FROM dbo.sysobjects WHERE dbo.sysobjects.name = 'KARDESPED_InformacionBaseParaCalcularPagoArt303')
begin
	--drop table KARDESPED_InformacionBaseParaCalcularPagoArt303
	--select * from KARDESPED_InformacionBaseParaCalcularPagoArt303
	select top 0 *,cast(null as int) as PedExp_codigo
	into KARDESPED_InformacionBaseParaCalcularPagoArt303
	from kardesped
	------where kap_codigo = (select max(kap_codigo) from kardesped)
	
	--if not exists (SELECT dbo.syscolumns.name FROM dbo.syscolumns INNER JOIN dbo.sysobjects ON dbo.syscolumns.id = dbo.sysobjects.id
	--WHERE (dbo.sysobjects.name = 'KARDESPED_InformacionBaseParaCalcularPagoArt303') AND (dbo.syscolumns.name = 'PedExp_codigo'))
	--begin
	--        ALTER TABLE [KARDESPED_InformacionBaseParaCalcularPagoArt303] ADD [PedExp_codigo] [int] NULL 
	--end
	
	------truncate table KARDESPED_InformacionBaseParaCalcularPagoArt303
	
end
else
begin
	delete from KARDESPED_InformacionBaseParaCalcularPagoArt303 where PedExp_codigo =@PICODIGO --04699 
end

 
if not exists (SELECT name FROM dbo.sysobjects WHERE dbo.sysobjects.name = 'PEDIMPDETB_InformacionBaseParaCalcularPagoArt303')
begin
	--drop table PEDIMPDETB_InformacionBaseParaCalcularPagoArt303
	select top 0 *
	into PEDIMPDETB_InformacionBaseParaCalcularPagoArt303
	from PEDIMPDETB
	------where pib_indiceb = (select max(pib_indiceb) from pedimpdetB)
	

	------truncate table PEDIMPDETB_InformacionBaseParaCalcularPagoArt303
		
end
else
begin
	delete from PEDIMPDETB_InformacionBaseParaCalcularPagoArt303 where pi_codigo =@PICODIGO --04699 
end


if not exists (SELECT name FROM dbo.sysobjects WHERE dbo.sysobjects.name = 'FACTEXPDET_InformacionBaseParaCalcularPagoArt303')
begin
	--drop table FACTEXPDET_InformacionBaseParaCalcularPagoArt303
	select top 0 *, cast(null as int) as PedExp_codigo
	into FACTEXPDET_InformacionBaseParaCalcularPagoArt303
	from FACTEXPDET

	------truncate table FACTEXPDET_InformacionBaseParaCalcularPagoArt303
		
end
else
begin
	delete from FACTEXPDET_InformacionBaseParaCalcularPagoArt303 where PedExp_codigo =@PICODIGO --04699 
end



if not exists (SELECT name FROM dbo.sysobjects WHERE dbo.sysobjects.name = 'PEDEXPDET_InformacionBaseParaCalcularPagoArt303')
begin
	--drop table PEDEXPDET_InformacionBaseParaCalcularPagoArt303
	select top 0 *
	into PEDEXPDET_InformacionBaseParaCalcularPagoArt303
	from PEDIMPDET

	------truncate table PEDEXPDET_InformacionBaseParaCalcularPagoArt303
		
end
else
begin
	delete from PEDEXPDET_InformacionBaseParaCalcularPagoArt303 where pi_codigo =@PICODIGO --04699 
end

 
--Paso #2
insert into KARDESPEDPPS_InformacionBaseParaCalcularPagoArt303 (KAP_CODIGO,KAP_TASAFINAL,KAP_DEF_TIP,KAP_SECIMP,SPI_CODIGO,KAP_COSTOUNITACT,KAP_FT_ACT,KAP_PEDIMENTO,KAP_FECHAPED,KAP_TIP_CAM,KAP_SALDOAFECTADO, PedExp_codigo)
SELECT  KARDESPEDPPS.KAP_CODIGO,isnull(KARDESPEDPPS.KAP_TASAFINAL,-1),KARDESPEDPPS.KAP_DEF_TIP,KARDESPEDPPS.KAP_SECIMP,KARDESPEDPPS.SPI_CODIGO,KARDESPEDPPS.KAP_COSTOUNITACT,
	KARDESPEDPPS.KAP_FT_ACT,KARDESPEDPPS.KAP_PEDIMENTO,KARDESPEDPPS.KAP_FECHAPED,isnull(KARDESPEDPPS.KAP_TIP_CAM,1),isnull(KARDESPEDPPS.KAP_SALDOAFECTADO,'N'),@PICODIGO --04699
FROM KARDESPEDPPS 
RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
LEFT OUTER JOIN PEDIMP 
RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
	ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGA 
LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_CODIGO = PEDEXP.PI_CODIGO
WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) AND (PEDEXP.PI_ESTATUS <> 'R')
AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
and not(KARDESPEDPPS.kap_codigo is null)
AND FACTEXP.PI_CODIGO=@PICODIGO--04699 
UNION
SELECT  KARDESPEDPPS.KAP_CODIGO,isnull(KARDESPEDPPS.KAP_TASAFINAL,-1),KARDESPEDPPS.KAP_DEF_TIP,KARDESPEDPPS.KAP_SECIMP,KARDESPEDPPS.SPI_CODIGO,KARDESPEDPPS.KAP_COSTOUNITACT,
	KARDESPEDPPS.KAP_FT_ACT,KARDESPEDPPS.KAP_PEDIMENTO,KARDESPEDPPS.KAP_FECHAPED,isnull(KARDESPEDPPS.KAP_TIP_CAM,1),isnull(KARDESPEDPPS.KAP_SALDOAFECTADO,'N'),@PICODIGO --04699
FROM KARDESPEDPPS 
RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
LEFT OUTER JOIN PEDIMP 
RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
	ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGAR1 
LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_RECTIFICA = PEDEXP.PI_CODIGO                   
WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) 
AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
and not(KARDESPEDPPS.kap_codigo is null)
AND FACTEXP.PI_RECTIFICA=@PICODIGO--04699



--Paso #3
insert into KARDESPED_InformacionBaseParaCalcularPagoArt303 (KAP_CODIGO,KAP_FACTRANS,KAP_INDICED_FACT,KAP_INDICED_PED,MA_HIJO,KAP_ESTATUS,KAP_CANTDESC,
		KAP_CantTotADescargar,KAP_Saldo_FED,KAP_PADRESUST,KAP_CONTESTATUS,KAP_Tipo_Desc,KAP_FisComp,KAP_PadreMain, PedExp_codigo)
SELECT KARDESPED.KAP_CODIGO, KARDESPED.KAP_FACTRANS, KARDESPED.KAP_INDICED_FACT, KARDESPED.KAP_INDICED_PED, KARDESPED.MA_HIJO, KARDESPED.KAP_ESTATUS, KARDESPED.KAP_CANTDESC,
		KARDESPED.KAP_CantTotADescargar, KARDESPED.KAP_Saldo_FED, KARDESPED.KAP_PADRESUST, KARDESPED.KAP_CONTESTATUS, KARDESPED.KAP_Tipo_Desc,
		KARDESPED.KAP_FisComp, KARDESPED.KAP_PadreMain,@PICODIGO/*04699*/ as PedExp_codigo
FROM KARDESPEDPPS 
RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
LEFT OUTER JOIN PEDIMP 
RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
	ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGA 
LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_CODIGO = PEDEXP.PI_CODIGO
WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) AND (PEDEXP.PI_ESTATUS <> 'R')
AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
and not(KARDESPED.kap_codigo is null)
AND FACTEXP.PI_CODIGO=@PICODIGO--04699

UNION
SELECT KARDESPED.KAP_CODIGO, KARDESPED.KAP_FACTRANS, KARDESPED.KAP_INDICED_FACT, KARDESPED.KAP_INDICED_PED, KARDESPED.MA_HIJO, KARDESPED.KAP_ESTATUS, KARDESPED.KAP_CANTDESC,
		KARDESPED.KAP_CantTotADescargar, KARDESPED.KAP_Saldo_FED, KARDESPED.KAP_PADRESUST, KARDESPED.KAP_CONTESTATUS, KARDESPED.KAP_Tipo_Desc,
		KARDESPED.KAP_FisComp, KARDESPED.KAP_PadreMain,@PICODIGO /*04699*/ as PedExp_codigo
FROM KARDESPEDPPS 
RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
LEFT OUTER JOIN PEDIMP 
RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
	ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGAR1 
LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_RECTIFICA = PEDEXP.PI_CODIGO                   
WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) 
AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
and not(KARDESPED.kap_codigo is null)
AND FACTEXP.PI_RECTIFICA=@PICODIGO --04699


--Paso #4
set identity_insert PEDIMPDETB_InformacionBaseParaCalcularPagoArt303 on
insert into PEDIMPDETB_InformacionBaseParaCalcularPagoArt303 (PIB_INDICEB,PI_CODIGO,PIB_COS_UNIGEN,PIB_COS_UNIGRA,PIB_COS_UNIVA,
		PIB_CANT,PIB_CAN_AR,PIB_CAN_GEN,PIB_VAL_FAC,
		PIB_VAL_ADU,PIB_VAL_US,PIB_ESTADO,AR_IMPMX,PIB_POR_DEF,ME_ARIMPMX,MA_GENERICO,ME_GENERICO,PA_ORIGEN,PA_PROCEDE,
		ES_ORIGEN,ES_DESTINO,ES_COMPRADOR,ES_VENDEDOR,PIB_SECUENCIA,AR_EXPFO,PIB_RATEEXPFO,EQ_EXPFO,PIB_VALORMCIANOORIG,
		PIB_ADVMNIMPUSA,PIB_ADVMNIMPMEX,PIB_ADVUSDIMPMEX,PIB_EXCENCION,PIB_IMPORTECONTRSINRECARGOS,PIB_IMPORTECONTR,
		PIB_IMPORTECONTRUSD,PIB_IMPORTERECARGOS,PIB_DESTNAFTA,PIB_NOMBRE,PIB_PAGACONTRIB,PIB_DEF_TIP,PIB_SEC_IMP,
		SPI_CODIGO,PIB_CODIGOFACT,PIB_OBSERVA,PIB_VAL_RET,PIB_GENERA_EMPDET,PIB_SERVICIO)
select  PIB_INDICEB,PI_CODIGO,PIB_COS_UNIGEN,PIB_COS_UNIGRA,PIB_COS_UNIVA,PIB_CANT,PIB_CAN_AR,PIB_CAN_GEN,PIB_VAL_FAC,
	PIB_VAL_ADU,PIB_VAL_US,PIB_ESTADO,AR_IMPMX,PIB_POR_DEF,ME_ARIMPMX,MA_GENERICO,ME_GENERICO,PA_ORIGEN,PA_PROCEDE,
	ES_ORIGEN,ES_DESTINO,ES_COMPRADOR,ES_VENDEDOR,PIB_SECUENCIA,AR_EXPFO,PIB_RATEEXPFO,EQ_EXPFO,PIB_VALORMCIANOORIG,
	PIB_ADVMNIMPUSA,PIB_ADVMNIMPMEX,PIB_ADVUSDIMPMEX,PIB_EXCENCION,PIB_IMPORTECONTRSINRECARGOS,PIB_IMPORTECONTR,
	PIB_IMPORTECONTRUSD,PIB_IMPORTERECARGOS,PIB_DESTNAFTA,PIB_NOMBRE,PIB_PAGACONTRIB,PIB_DEF_TIP,PIB_SEC_IMP,
	SPI_CODIGO,PIB_CODIGOFACT,PIB_OBSERVA,PIB_VAL_RET,PIB_GENERA_EMPDET,PIB_SERVICIO
from pedimpdetb 
where pib_indiceb in (
	SELECT  PEDEXPDET.pib_indiceb
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGA 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_CODIGO = PEDEXP.PI_CODIGO
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) AND (PEDEXP.PI_ESTATUS <> 'R')
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
	AND FACTEXP.PI_CODIGO=@PICODIGO --04699
	UNION
	SELECT PEDEXPDET.pib_indiceb
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGAR1 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_RECTIFICA = PEDEXP.PI_CODIGO                   
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) 
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')

	AND FACTEXP.PI_RECTIFICA=@PICODIGO /*04699*/ )
set identity_insert PEDIMPDETB_InformacionBaseParaCalcularPagoArt303 off


--Paso #5
insert into factexpdet_InformacionBaseParaCalcularPagoArt303 (FED_INDICED,FE_CODIGO,MA_CODIGO,FED_NOMBRE,FED_NOPARTE,FED_NAME,ME_CODIGO,FED_OBSERVA,FED_CANT,FED_GRA_MP,FED_GRA_MO,FED_GRA_EMP,FED_GRA_ADD,
	FED_GRA_GI,FED_GRA_GI_MX,FED_NG_MP,FED_NG_EMP,FED_NG_ADD,FED_NG_USA,FED_COS_UNI,FED_COS_TOT,FED_PES_UNI,FED_PES_NET,FED_PES_BRU,FED_PES_UNILB,
	FED_PES_NETLB,FED_PES_BRULB,FED_SEC_IMP,FED_DEF_TIP,FED_POR_DEF,FED_LOTE,AR_IMPMX,AR_EXPMX,AR_IMPFO,FED_CON_PED,MA_GENERICO,PA_CODIGO,
	LE_CODIGO,LED_INDICED,EX_CODIGO,FED_ORD_COMP,FED_NOORDEN,FED_USO_COMMINV,EQ_GEN,EQ_IMPFO,EQ_EXPMX,TI_CODIGO,FED_TENVIO,FED_INBOND,FED_TIPOINBOND,
	FED_RATEEXPMX,FED_RATEIMPFO,FED_RELEMP,FED_FECHA_STRUCT,FED_DISCHARGE,LE_FOLIO,SPI_CODIGO,FED_SALDO,FED_RETRABAJO,ADE_CODIGO,MA_EMPAQUE,
	FED_CANTEMP,FED_FAC_NUM,FED_FEC_ENV,FED_CON_CERTORIG,FED_COS_UNI_CO,FED_GRA_MAT_CO,FED_EMP_CO,FED_NG_MAT_CO,FED_VA_CO,FED_CANTGEN,
	MO_CODIGO,FED_DESCARGADO,FED_PARTTYPE,ME_GENERICO,FED_TIP_ENS,PID_INDICED,MA_NOPARTECL,ME_AREXPMX,FED_NAFTA,FED_DEFTXT1,FED_DEFTXT2,FED_DEFNO3,
	FED_DEFNO4,PID_INDICEDLIGA,PID_INDICEDLIGAR1,TCO_CODIGO,PI_ORIGENKITPADRE,CS_CODIGO,SE_CODIGO,FED_RELCAJAS,END_INDICED,EN_CODIGO,FED_SALDOTRANS,
	FED_USOTRANS,FED_USOSALDO,CL_CODIGO,MA_STRUCT,FED_DESTNAFTA,AR_ORIG,AR_NG_EMP,FED_NOPARTEAUX,ETA_CODIGO,FED_NOPARTESTRUCT,FED_NG_MX,FED_GENERA_EMPDET,
	FED_GRAVA_VA,FED_PARTIDA,FED_SECF4,FED_PRECIO_UNI,FED_PRECIO_TOT,FED_PIDSECUENCIA,FED_FOLIO_CERT,FED_POR_CERT, PedExp_codigo )
select FED_INDICED,FE_CODIGO,MA_CODIGO,FED_NOMBRE,FED_NOPARTE,FED_NAME,ME_CODIGO,FED_OBSERVA,FED_CANT,FED_GRA_MP,FED_GRA_MO,FED_GRA_EMP,FED_GRA_ADD,
	FED_GRA_GI,FED_GRA_GI_MX,FED_NG_MP,FED_NG_EMP,FED_NG_ADD,FED_NG_USA,FED_COS_UNI,FED_COS_TOT,FED_PES_UNI,FED_PES_NET,FED_PES_BRU,FED_PES_UNILB,
	FED_PES_NETLB,FED_PES_BRULB,FED_SEC_IMP,FED_DEF_TIP,FED_POR_DEF,FED_LOTE,AR_IMPMX,AR_EXPMX,AR_IMPFO,FED_CON_PED,MA_GENERICO,PA_CODIGO,
	LE_CODIGO,LED_INDICED,EX_CODIGO,FED_ORD_COMP,FED_NOORDEN,FED_USO_COMMINV,EQ_GEN,EQ_IMPFO,EQ_EXPMX,TI_CODIGO,FED_TENVIO,FED_INBOND,FED_TIPOINBOND,
	FED_RATEEXPMX,FED_RATEIMPFO,FED_RELEMP,FED_FECHA_STRUCT,FED_DISCHARGE,LE_FOLIO,SPI_CODIGO,FED_SALDO,FED_RETRABAJO,ADE_CODIGO,MA_EMPAQUE,
	FED_CANTEMP,FED_FAC_NUM,FED_FEC_ENV,FED_CON_CERTORIG,FED_COS_UNI_CO,FED_GRA_MAT_CO,FED_EMP_CO,FED_NG_MAT_CO,FED_VA_CO,FED_CANTGEN,
	MO_CODIGO,FED_DESCARGADO,FED_PARTTYPE,ME_GENERICO,FED_TIP_ENS,PID_INDICED,MA_NOPARTECL,ME_AREXPMX,FED_NAFTA,FED_DEFTXT1,FED_DEFTXT2,FED_DEFNO3,
	FED_DEFNO4,PID_INDICEDLIGA,PID_INDICEDLIGAR1,TCO_CODIGO,PI_ORIGENKITPADRE,CS_CODIGO,SE_CODIGO,FED_RELCAJAS,END_INDICED,EN_CODIGO,FED_SALDOTRANS,
	FED_USOTRANS,FED_USOSALDO,CL_CODIGO,MA_STRUCT,FED_DESTNAFTA,AR_ORIG,AR_NG_EMP,FED_NOPARTEAUX,ETA_CODIGO,FED_NOPARTESTRUCT,FED_NG_MX,FED_GENERA_EMPDET,
	FED_GRAVA_VA,FED_PARTIDA,FED_SECF4,FED_PRECIO_UNI,FED_PRECIO_TOT,FED_PIDSECUENCIA,FED_FOLIO_CERT,FED_POR_CERT,@PICODIGO/*04699*/ as PedExp_codigo
from factexpdet
where factexpdet.fed_indiced in (
	SELECT factexpdet.fed_indiced
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGA 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_CODIGO = PEDEXP.PI_CODIGO
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) AND (PEDEXP.PI_ESTATUS <> 'R')
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
	and not(KARDESPED.kap_codigo is null)
	AND FACTEXP.PI_CODIGO=@PICODIGO--04699
	UNION
	SELECT factexpdet.fed_indiced
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGAR1 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_RECTIFICA = PEDEXP.PI_CODIGO                   
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) 
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
	and not(KARDESPED.kap_codigo is null)
	AND FACTEXP.PI_RECTIFICA=@PICODIGO --04699
)


--Paso #6
insert into pedexpdet_InformacionBaseParaCalcularPagoArt303 (PI_CODIGO,PID_INDICED,MA_CODIGO,PID_NOPARTE,PID_NOMBRE,PID_NAME,PID_COS_UNI,PID_COS_UNIADU,PID_COS_UNIGEN,PID_COS_UNIVA,PID_COS_UNIMATGRA,
					PID_CANT,PID_CAN_AR,PID_CAN_GEN,PID_VAL_ADU,PID_CTOT_DLS,ME_CODIGO,ME_GENERICO,PID_OBSERVA,MA_GENERICO,EQ_GENERICO,EQ_IMPMX,AR_IMPMX,
					ME_ARIMPMX,AR_EXPFO,PID_RATEEXPFO,PID_SEC_IMP,PID_DEF_TIP,PID_POR_DEF,CS_CODIGO,PID_KIT_POR,TI_CODIGO,PA_ORIGEN,PA_PROCEDE,SPI_CODIGO,
					PR_CODIGO,PID_IMPRIMIR,PID_GENERA_EMP,PID_CANT_DESP,EQ_EXPFO,PIB_INDICEB,PID_DESCARGABLE,PID_MA_CODIGOPADREKIT,TCO_CODIGO,SE_CODIGO,
					PI_EXPBO,PID_REGIONFIN,PID_PEDTRANS,PID_FECHAPEDTRANS,AD_TRANS,PID_PAGACONTRIB,PID_NOPARTEAUX,PID_INDICEDLIGA,PID_ORD_COMP,PID_CODIGOFACT,
					PID_SECUENCIA,PID_POSECUENCIA,PID_INDICEDORIG,PID_CTOT_MN,PID_GENERA_EMPDET,PID_PEDF4ORIG,PID_PES_UNIKG,PID_SERVICIO,PG_CODIGO,CP_TRANS
				)
select @PICODIGO/*04699*/ as PedExp_codigo,PID_INDICED,MA_CODIGO,PID_NOPARTE,PID_NOMBRE,PID_NAME,PID_COS_UNI,PID_COS_UNIADU,PID_COS_UNIGEN,PID_COS_UNIVA,PID_COS_UNIMATGRA,
	PID_CANT,PID_CAN_AR,PID_CAN_GEN,PID_VAL_ADU,PID_CTOT_DLS,ME_CODIGO,ME_GENERICO,PID_OBSERVA,MA_GENERICO,EQ_GENERICO,EQ_IMPMX,AR_IMPMX,
	ME_ARIMPMX,AR_EXPFO,PID_RATEEXPFO,PID_SEC_IMP,PID_DEF_TIP,PID_POR_DEF,CS_CODIGO,PID_KIT_POR,TI_CODIGO,PA_ORIGEN,PA_PROCEDE,SPI_CODIGO,
	PR_CODIGO,PID_IMPRIMIR,PID_GENERA_EMP,PID_CANT_DESP,EQ_EXPFO,PIB_INDICEB,PID_DESCARGABLE,PID_MA_CODIGOPADREKIT,TCO_CODIGO,SE_CODIGO,
	PI_EXPBO,PID_REGIONFIN,PID_PEDTRANS,PID_FECHAPEDTRANS,AD_TRANS,PID_PAGACONTRIB,PID_NOPARTEAUX,PID_INDICEDLIGA,PID_ORD_COMP,PID_CODIGOFACT,
	PID_SECUENCIA,PID_POSECUENCIA,PID_INDICEDORIG,PID_CTOT_MN,PID_GENERA_EMPDET,PID_PEDF4ORIG,PID_PES_UNIKG,PID_SERVICIO,PG_CODIGO,CP_TRANS
from pedimpdet
where pedimpdet.pid_indiced in (
	SELECT pedexpdet.pid_indiced
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGA 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_CODIGO = PEDEXP.PI_CODIGO
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) AND (PEDEXP.PI_ESTATUS <> 'R')
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
	and not(KARDESPED.kap_codigo is null)
	AND FACTEXP.PI_CODIGO=@PICODIGO--04699
	UNION
	SELECT pedexpdet.pid_indiced
	FROM KARDESPEDPPS 
	RIGHT OUTER JOIN KARDESPED ON KARDESPEDPPS.KAP_CODIGO = KARDESPED.KAP_CODIGO 
	LEFT OUTER JOIN FACTEXPDET ON KARDESPED.KAP_INDICED_FACT = FACTEXPDET.FED_INDICED 
	LEFT OUTER JOIN FACTEXP ON KARDESPED.KAP_FACTRANS = FACTEXP.FE_CODIGO 
	LEFT OUTER JOIN PEDIMP 
	RIGHT OUTER JOIN PEDIMPDET ON PEDIMP.PI_CODIGO = PEDIMPDET.PI_CODIGO 
		ON KARDESPED.KAP_INDICED_PED = PEDIMPDET.PID_INDICED 
	LEFT OUTER JOIN PEDIMPDET PEDEXPDET ON PEDEXPDET.PID_INDICED = FACTEXPDET.PID_INDICEDLIGAR1 
	LEFT OUTER JOIN PEDIMP PEDEXP ON FACTEXP.PI_RECTIFICA = PEDEXP.PI_CODIGO                   
	WHERE (KARDESPED.KAP_INDICED_PED IS NOT NULL) 
	AND PEDIMP.CP_CODIGO IN (SELECT CP_CODIGO FROM CONFIGURACLAVEPED WHERE CCP_TIPO IN ('IT', 'IM', 'RE', 'IV', 'VT', 'ED', 'TS'))
	AND FACTEXPDET.FED_RETRABAJO<>'R' AND FACTEXP.TQ_CODIGO NOT IN (SELECT TQ_CODIGO FROM CONFIGURATEMBARQUE WHERE CFQ_TIPO='D')
	and not(KARDESPED.kap_codigo is null)
	AND FACTEXP.PI_RECTIFICA=@PICODIGO --04699
)

GO
