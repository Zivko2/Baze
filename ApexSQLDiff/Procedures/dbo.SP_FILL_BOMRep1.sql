SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO































/* inserta en la tabla TempBOM_CALCULABASE  los del nivel diferentes del 1 el bom  para calculo de costos y calculo de aranceles*/
CREATE PROCEDURE [dbo].[SP_FILL_BOMRep1] (@BST_PT INT, @BST_HIJO INT, @BST_ENTRAVIGOR DATETIME, @BST_PERINI DATETIME, @BST_INCORPOR1 decimal(38,6), @CF_NIVELES int, @nivel int, @BST_CODIGOPT int, @SPI_CODIGO int, @mensaje char(1) output)   as

SET NOCOUNT ON 

declare @BST_HIJO1 int, @BST_INCORPOR decimal(38,6), @BST_DISCH char(1), @TI_CODIGO char(1), @ME_CODIGO int, @Factconv decimal(28,14), 
    @BST_PERINI1 datetime, @BST_PERFIN datetime, @ME_GEN int, @BST_TRANS char(1), @BST_TIPOCOSTO char(1), 
    @MA_TIP_ENS char(1), @PA_CODIGO int, @nivelr int, @bst_perini2 datetime, @BST_CODIGO int, @incorporacionfinal decimal(38,6),
    @bst_tipo char(1), @bm_codigo int


	SET @nivelr=@nivel+1


			INSERT INTO BOM_REP (BST_HIJO, BST_INCORPOR, BST_DISCH, TI_CODIGO,  ME_CODIGO, FACTCONV, 
				BST_PERINI, BST_PERFIN, ME_GEN, BST_TRANS, BST_TIPOCOSTO, MA_TIP_ENS, PA_CODIGO, 
				BST_CODIGO, BST_NIVEL, BST_PERTENECE, BST_PT, BST_ENTRAVIGOR, bst_tipo, BST_CODIGOPT, SPI_CODIGO, SPI_PT)


			SELECT     dbo.BOM_STRUCT.BST_HIJO, SUM(dbo.BOM_STRUCT.BST_INCORPOR)*@BST_INCORPOR1 AS BST_INCORPOR, dbo.BOM_STRUCT.BST_DISCH, 
			                      dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, 
			                      dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, 
			                      dbo.BOM_STRUCT.BST_TIP_ENS,
				        dbo.MAESTRO.PA_ORIGEN, max(dbo.BOM_STRUCT.BST_CODIGO), @nivelr, @BST_HIJO, @BST_PT, @BST_ENTRAVIGOR, 'C' ,  @BST_CODIGOPT, 
					CASE WHEN dbo.CONFIGURATIPO.CFT_TIPO<>'P' and dbo.CONFIGURATIPO.CFT_TIPO<>'S' THEN 22 ELSE @SPI_CODIGO END, @SPI_CODIGO
				FROM         dbo.BOM_STRUCT LEFT OUTER JOIN
				                      dbo.MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = dbo.MAESTRO.MA_CODIGO LEFT OUTER JOIN
				                      dbo.CONFIGURATIPO ON dbo.MAESTRO.TI_CODIGO = dbo.CONFIGURATIPO.TI_CODIGO
				WHERE (dbo.CONFIGURATIPO.CFT_TIPO<>'P' and dbo.CONFIGURATIPO.CFT_TIPO<>'S') and dbo.BOM_STRUCT.BST_TIP_ENS='C'
				GROUP BY dbo.BOM_STRUCT.BST_HIJO, dbo.BOM_STRUCT.BST_DISCH, dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, 
				                      dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, 
				                      dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, dbo.BOM_STRUCT.BST_TIP_ENS, dbo.BOM_STRUCT.BSU_SUBENSAMBLE, 
				                      dbo.BOM_STRUCT.BST_INCORPOR, dbo.MAESTRO.PA_ORIGEN
				HAVING     (dbo.BOM_STRUCT.BSU_SUBENSAMBLE = @BST_HIJO)
				AND (dbo.BOM_STRUCT.BST_HIJO IS NOT NULL) AND dbo.BOM_STRUCT.BST_PERINI<=@BST_ENTRAVIGOR AND dbo.BOM_STRUCT.BST_PERFIN>=@BST_ENTRAVIGOR
				AND dbo.BOM_STRUCT.BST_INCORPOR >0
				ORDER BY dbo.BOM_STRUCT.BST_HIJO



DECLARE @CursorVar CURSOR

SET @CursorVar = CURSOR SCROLL DYNAMIC FOR

SELECT     dbo.BOM_STRUCT.BST_HIJO, SUM(dbo.BOM_STRUCT.BST_INCORPOR) AS BST_INCORPOR, dbo.BOM_STRUCT.BST_DISCH, 
                      dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, 
                      dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, 
                      dbo.BOM_STRUCT.BST_TIP_ENS, 
	       dbo.MAESTRO.PA_ORIGEN, max(dbo.BOM_STRUCT.BST_CODIGO)
FROM         dbo.BOM_STRUCT LEFT OUTER JOIN
                      dbo.MAESTRO ON dbo.BOM_STRUCT.BST_HIJO = dbo.MAESTRO.MA_CODIGO LEFT OUTER JOIN
                      dbo.CONFIGURATIPO ON dbo.MAESTRO.TI_CODIGO = dbo.CONFIGURATIPO.TI_CODIGO
WHERE (dbo.CONFIGURATIPO.CFT_TIPO='P' OR dbo.CONFIGURATIPO.CFT_TIPO='S') AND dbo.BOM_STRUCT.BST_TIP_ENS<>'P'
GROUP BY dbo.BOM_STRUCT.BST_HIJO, dbo.BOM_STRUCT.BST_DISCH, dbo.CONFIGURATIPO.CFT_TIPO, dbo.BOM_STRUCT.ME_CODIGO, 
                      dbo.BOM_STRUCT.FACTCONV, dbo.BOM_STRUCT.BST_PERINI, dbo.BOM_STRUCT.BST_PERFIN, dbo.BOM_STRUCT.ME_GEN, 
                      dbo.BOM_STRUCT.BST_TRANS, dbo.MAESTRO.BST_TIPOCOSTO, dbo.BOM_STRUCT.BST_TIP_ENS, dbo.BOM_STRUCT.BSU_SUBENSAMBLE, 
                      dbo.BOM_STRUCT.BST_INCORPOR, dbo.MAESTRO.PA_ORIGEN
HAVING     (dbo.BOM_STRUCT.BSU_SUBENSAMBLE = @BST_HIJO)
AND (dbo.BOM_STRUCT.BST_HIJO IS NOT NULL) AND dbo.BOM_STRUCT.BST_PERINI<=@BST_ENTRAVIGOR AND dbo.BOM_STRUCT.BST_PERFIN>=@BST_ENTRAVIGOR
AND dbo.BOM_STRUCT.BST_INCORPOR >0
ORDER BY dbo.BOM_STRUCT.BST_HIJO

 OPEN @CursorVar
  FETCH NEXT FROM @CursorVar
	INTO @BST_HIJO1, @BST_INCORPOR, @BST_DISCH, @TI_CODIGO, @ME_CODIGO, 
	@FACTCONV, @BST_PERINI1, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO,
	@MA_TIP_ENS, @PA_CODIGO, @BST_CODIGO

  WHILE (@@fetch_status = 0) 
  BEGIN  


	set @incorporacionfinal=@BST_INCORPOR* @BST_INCORPOR1



		set @bst_tipo='P'
		begin


			IF  @BST_HIJO1<> @BST_HIJO
			begin
	
				insert into BOM_REP(BST_CODIGO, BST_PT, BST_CODIGOPT, bst_tipo, BST_ENTRAVIGOR, BST_HIJO, BST_INCORPOR, 
				    BST_DISCH, TI_CODIGO, ME_CODIGO, FACTCONV, BST_PERINI, BST_PERFIN, ME_GEN, 
				    BST_TRANS, BST_TIPOCOSTO, MA_TIP_ENS, BST_NIVEL, BST_PERTENECE, PA_CODIGO, SPI_CODIGO, SPI_PT)
				values
				(@BST_CODIGO, @BST_PT, @BST_CODIGOPT, @bst_tipo, @BST_ENTRAVIGOR, @BST_HIJO1, @incorporacionfinal, @BST_DISCH, @TI_CODIGO, @ME_CODIGO, 
				@FACTCONV, @BST_PERINI1, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO,
				@MA_TIP_ENS, @nivelr, @BST_HIJO, @PA_CODIGO, @SPI_CODIGO, @SPI_CODIGO)

			end
				if @@NESTLEVEL <32
				exec  SP_FILL_BOMREP1 @BST_PT, @BST_HIJO1, @BST_ENTRAVIGOR, @BST_PERINI1, @incorporacionfinal, @CF_NIVELES, @nivelr, @BST_CODIGOPT, @SPI_CODIGO, @mensaje=@mensaje output
				else
				begin
					set @mensaje='S'
					break
				end
	
		end
	


	FETCH NEXT FROM @CursorVar INTO @BST_HIJO1, @BST_INCORPOR, @BST_DISCH, @TI_CODIGO, 			
	@ME_CODIGO, @FACTCONV, @BST_PERINI1, @BST_PERFIN, @ME_GEN, @BST_TRANS, @BST_TIPOCOSTO,
	@MA_TIP_ENS, @PA_CODIGO, @BST_CODIGO

END
	CLOSE @CursorVar
	DEALLOCATE @CursorVar






























GO
