SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_CORRIGEENTIDADES_DIRECCIONES_NULAS]   as

		UPDATE FACTEXP
	SET     CL_DESTFIN= CL_DESTINI
	FROM         FACTEXP
	WHERE     (CL_DESTINI IS NOT NULL) AND (CL_DESTFIN IS NULL)
	
	
	UPDATE FACTEXP
	SET     DI_DESTFIN= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_DESTFIN AND DI_FISCAL='S')
	WHERE DI_DESTFIN IS NULL
	
	
	UPDATE FACTEXP
	SET     CL_IMP= CL_DESTINI
	FROM         FACTEXP
	WHERE     (CL_DESTINI IS NOT NULL) AND (CL_IMP IS NULL)
	
	
	UPDATE FACTEXP
	SET     DI_IMP= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_IMP AND DI_FISCAL='S')
	WHERE DI_IMP IS NULL
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_PROD= CLIENTEENTIDADES.CL_PROD 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_PROD IS NULL 
	
	
	UPDATE FACTEXP
	SET     DI_PROD= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_PROD AND DI_FISCAL='S')
	WHERE DI_PROD IS NULL
	
	
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_COMP= CLIENTEENTIDADES.CL_COMP 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_COMP IS NULL 
	
	
	
	UPDATE FACTEXP
	SET     DI_COMP= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_COMP AND DI_FISCAL='S')
	WHERE DI_COMP IS NULL
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_COMPFIN= CLIENTEENTIDADES.CL_COMPFIN 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_COMPFIN IS NULL 
	
	
	
	UPDATE FACTEXP
	SET     DI_COMPFIN= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_COMPFIN AND DI_FISCAL='S')
	WHERE DI_COMPFIN IS NULL
	
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_EXP= CLIENTEENTIDADES.CL_EXP 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_EXP IS NULL 
	
	
	UPDATE FACTEXP
	SET     DI_EXP= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_EXP AND DI_FISCAL='S')
	WHERE DI_EXP IS NULL
	
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_EXPFIN= CLIENTEENTIDADES.CL_EXPFIN 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_EXPFIN IS NULL 
	
	
	UPDATE FACTEXP
	SET     DI_EXPFIN= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_EXPFIN AND DI_FISCAL='S')
	WHERE DI_EXPFIN IS NULL
	
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_DESTINI= CLIENTEENTIDADES.CL_DESTINI 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_DESTINI IS NULL 
	
	
	
	UPDATE FACTEXP
	SET     DI_DESTINI= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_DESTINI AND DI_FISCAL='S')
	WHERE DI_DESTINI IS NULL
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_DESTFIN= CLIENTEENTIDADES.CL_DESTFIN 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_DESTFIN IS NULL 
	
	
	
	UPDATE FACTEXP
	SET     DI_DESTFIN= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_DESTFIN AND DI_FISCAL='S')
	WHERE DI_DESTFIN IS NULL
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_VEND= CLIENTEENTIDADES.CL_VEND 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_VEND IS NULL 
	
	
	
	
	UPDATE FACTEXP
	SET     DI_VEND= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_VEND AND DI_FISCAL='S')
	WHERE DI_VEND IS NULL
	
	
	UPDATE FACTEXP
	SET     FACTEXP.CL_IMP= CLIENTEENTIDADES.CL_IMP 
	FROM         CLIENTEENTIDADES INNER JOIN
	                      FACTEXP ON CLIENTEENTIDADES.TF_CODIGO = FACTEXP.TF_CODIGO INNER JOIN
	                      TFACTURA ON CLIENTEENTIDADES.TF_CODIGO = TFACTURA.TF_CODIGO
	WHERE     (CLIENTEENTIDADES.OM_TIPO = 'S') AND
	FACTEXP.CL_IMP IS NULL 
	
	
	
	UPDATE FACTEXP
	SET     DI_IMP= (SELECT DI_INDICE FROM DIR_CLIENTE WHERE CL_CODIGO = CL_IMP AND DI_FISCAL='S')
	WHERE DI_IMP IS NULL



	UPDATE dbo.FACTEXPDET
	SET     dbo.FACTEXPDET.FED_DESTNAFTA= CASE 
	when dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_MX FROM CONFIGURACION) THEN 'M'
	 when dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_USA FROM CONFIGURACION) or dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT CF_PAIS_CA FROM CONFIGURACION)
	then 'N'  WHEN 	  dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT PA_CODIGO FROM PAIS WHERE SPI_CODIGO IN ( SELECT SPI_CODIGO FROM SPI WHERE SPI_CLAVE='MX-UE')) 
	then 'U' when 	  dbo.DIR_CLIENTE.PA_CODIGO IN (SELECT PA_CODIGO FROM PAIS WHERE SPI_CODIGO IN ( SELECT SPI_CODIGO FROM SPI WHERE SPI_CLAVE='AELC')) 
	then 'A'  else 'F' end
	FROM         dbo.FACTEXPDET INNER JOIN
	                      dbo.FACTEXP ON dbo.FACTEXPDET.FE_CODIGO = dbo.FACTEXP.FE_CODIGO LEFT OUTER JOIN
	                      dbo.DIR_CLIENTE ON dbo.FACTEXP.DI_DESTFIN = dbo.DIR_CLIENTE.DI_INDICE


GO
