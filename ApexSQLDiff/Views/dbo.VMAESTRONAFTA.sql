SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW dbo.VMAESTRONAFTA
with encryption as
SELECT     dbo.MAESTRO.MA_CODIGO, MA_NOMBRE, MA_NAME, ME_COM, PA_ORIGEN, MA_GENERICO, AR_RETRA, AR_EXPFO, AR_IMPMX, TI_CODIGO, EQ_GEN, 
                      MA_DEF_TIP, MA_SEC_IMP, round(MA_PESO_KG,6) as MA_PESO_KG, round(MA_PESO_LB,6) as MA_PESO_LB, AR_DESP, MA_INV_GEN, MA_NOPARTE, EQ_IMPMX, EQ_EXPFO, 
                      AR_EXPMX, AR_IMPFO, MA_CANTEMP, EQ_DESP, EQ_RETRA, EQ_IMPFO, EQ_EXPFO2, 
                      EQ_EXPMX, MA_DISCHARGE, MA_EMPAQUE, MA_NOPARTEAUX, PA_PROCEDE, SPI_CODIGO, MA_EST_MAT, AR_IMPFOUSA, 
                      EQ_IMPFOUSA, MA_TIP_ENS, 'MA_NAFTA'=CASE WHEN dbo.MAESTRO.MA_CODIGO in
	         (SELECT NAFTA.MA_CODIGO FROM NAFTA INNER JOIN SPI ON NAFTA.SPI_CODIGO = SPI.SPI_CODIGO	WHERE SPI.SPI_CLAVE = 'NAFTA' and NFT_CALIFICO='S'
	         and NFT_PERINI<=GETDATE() AND NFT_PERFIN>=GETDATE() AND NAFTA.MA_CODIGO=MAESTRO.MA_CODIGO) 
	         and TI_CODIGO IN (select ti_codigo from configuratipo where cft_tipo='P' or cft_tipo='S') AND (dbo.MAESTRO.MA_TIP_ENS='F' OR dbo.MAESTRO.MA_TIP_ENS='E')
	         then 'S' else 
		(CASE WHEN dbo.MAESTRO.MA_CODIGO in (SELECT  CERTORIGMPDET.MA_CODIGO
		FROM  CERTORIGMPDET INNER JOIN CERTORIGMP ON CERTORIGMPDET.CMP_CODIGO = CERTORIGMP.CMP_CODIGO 
		WHERE  CERTORIGMP.CMP_TIPO<> 'P' AND CERTORIGMPDET.PA_CLASE=MAESTRO.PA_ORIGEN AND LEFT(REPLACE(CERTORIGMPDET.CMP_FRACCION,'.',''),6)=LEFT(REPLACE(ARANCEL.AR_FRACCION,'.',''),6) AND  CERTORIGMP.SPI_CODIGO IN (SELECT spi_codigo FROM spi  WHERE spi_clave = 'nafta')
		AND CERTORIGMP.CMP_AFFIDAVIT='S' AND CERTORIGMP.CMP_ESTATUS='V' AND  CERTORIGMP.CMP_IFECHA<=GETDATE() AND CERTORIGMP.CMP_FECHATRANS>=GETDATE() AND CERTORIGMPDET.MA_CODIGO=MAESTRO.MA_CODIGO)
		THEN 'S' ELSE
		(CASE WHEN PA_ORIGEN IN (SELECT CF_PAIS_USA FROM CONFIGURACION) AND MA_DEF_TIP='P' THEN 'S'
		ELSE 'N' END) END) end, dbo.MAESTRO.CS_CODIGO, SE_CODIGO, MA_FAMILIA, MA_SERVICIO, MA_ESTRUCTURA,
		ANX_CAS_NUM,
		'MA_9801' =CASE WHEN TI_CODIGO not in (select ti_codigo from configuratipo where cft_tipo='P' or cft_tipo='S') and dbo.MAESTRO.MA_CODIGO in (SELECT     CERTORIGMPDET.MA_CODIGO
			FROM  CERTORIGMPDET INNER JOIN CERTORIGMP ON CERTORIGMPDET.CMP_CODIGO = CERTORIGMP.CMP_CODIGO
			WHERE  LEFT(REPLACE(CERTORIGMPDET.CMP_FRACCION,'.',''),6)=LEFT(REPLACE(ARANCEL.AR_FRACCION,'.',''),6) 
			AND CERTORIGMPDET.PA_CLASE IN (SELECT CF_PAIS_USA FROM CONFIGURACION)
			AND  CERTORIGMP.SPI_CODIGO IN (SELECT spi_codigo FROM spi  WHERE spi_clave = 'nafta')
			AND CERTORIGMP.CMP_ESTATUS='V' AND  CERTORIGMP.CMP_IFECHA<=GETDATE() AND CERTORIGMP.CMP_FECHATRANS>=GETDATE() AND CERTORIGMPDET.MA_CODIGO=MAESTRO.MA_CODIGO and cmp_affidavit='S')
		THEN 'S'
		ELSE 'N' END
FROM         dbo.MAESTRO LEFT OUTER JOIN ANEXO24 ON dbo.MAESTRO.MA_CODIGO=ANEXO24.MA_CODIGO LEFT OUTER JOIN ARANCEL ON 
dbo.MAESTRO.AR_IMPMX=ARANCEL.AR_CODIGO
WHERE    ma_inv_gen='I'













































































GO
