SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW dbo.VPEDIMPFACT1
with encryption as
	SELECT     dbo.FACTIMP.PI_CODIGO, dbo.FACTIMP.FI_CODIGO, dbo.FACTIMP.FI_FOLIO, dbo.FACTIMP.FI_FECHA, dbo.FACTIMP.IT_CODIGO, 
	      dbo.FACTIMP.MO_CODIGO, round(SUM(dbo.FACTIMPDET.FID_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTIMP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTIMPDET.FID_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTIMP.PI_CODIGO),1),2)
                   WHEN dbo.FACTIMP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTIMPDET.FID_COS_TOT),2) ELSE round(SUM(isnull(FACTIMPDET.FID_COS_TOT,0)*FACTIMP.FI_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTIMP.PI_CODIGO),1),2) END,
		dbo.FACTIMP.PR_CODIGO, dbo.FACTIMP.DI_PROVEE AS DI_CODIGO, dbo.FACTIMP.FI_CONSECUTIVOPED, dbo.FACTIMP.FI_CONT_REG
	FROM         dbo.FACTIMP LEFT OUTER JOIN
	      dbo.FACTIMPDET ON dbo.FACTIMP.FI_CODIGO = dbo.FACTIMPDET.FI_CODIGO
	WHERE     (dbo.FACTIMP.PI_CODIGO <> - 1) AND FI_FACTAGRU NOT IN (SELECT PI_FACTAGRU FROM PEDIMP WHERE PI_MOVIMIENTO='E' AND PI_USAFACTAGRU = 'S')
	GROUP BY dbo.FACTIMP.PI_CODIGO, dbo.FACTIMP.FI_CODIGO, dbo.FACTIMP.FI_FOLIO, dbo.FACTIMP.FI_FECHA, dbo.FACTIMP.IT_CODIGO, 
	      dbo.FACTIMP.MO_CODIGO, dbo.FACTIMP.PR_CODIGO, dbo.FACTIMP.DI_PROVEE, dbo.FACTIMP.FI_CONSECUTIVOPED,  dbo.FACTIMP.FI_CONT_REG

UNION
	SELECT     dbo.FACTIMP.PI_RECTIFICA, dbo.FACTIMP.FI_CODIGO, dbo.FACTIMP.FI_FOLIO, dbo.FACTIMP.FI_FECHA, dbo.FACTIMP.IT_CODIGO, 
	      dbo.FACTIMP.MO_CODIGO, round(SUM(dbo.FACTIMPDET.FID_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTIMP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTIMPDET.FID_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTIMP.PI_RECTIFICA),1),2)
                   WHEN dbo.FACTIMP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTIMPDET.FID_COS_TOT),2) ELSE round(SUM(dbo.FACTIMPDET.FID_COS_TOT)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTIMP.PI_RECTIFICA),1),2) END,
	      dbo.FACTIMP.PR_CODIGO, dbo.FACTIMP.DI_PROVEE, dbo.FACTIMP.FI_CONSECUTIVOPED, dbo.FACTIMP.FI_CONT_REG
	FROM         dbo.FACTIMP LEFT OUTER JOIN
	      dbo.FACTIMPDET ON dbo.FACTIMP.FI_CODIGO = dbo.FACTIMPDET.FI_CODIGO
	WHERE     (dbo.FACTIMP.PI_RECTIFICA <> - 1) AND FI_FACTAGRU NOT IN (SELECT PI_FACTAGRU FROM PEDIMP WHERE PI_MOVIMIENTO='E' AND PI_USAFACTAGRU = 'S' AND PI_FACTAGRU<>-1)
	GROUP BY dbo.FACTIMP.PI_RECTIFICA, dbo.FACTIMP.FI_CODIGO, dbo.FACTIMP.FI_FOLIO, dbo.FACTIMP.FI_FECHA, dbo.FACTIMP.IT_CODIGO, 
	      dbo.FACTIMP.MO_CODIGO, dbo.FACTIMP.PR_CODIGO, dbo.FACTIMP.DI_PROVEE, dbo.FACTIMP.FI_CONSECUTIVOPED, dbo.FACTIMP.FI_CONSECUTIVOPED, dbo.FACTIMP.FI_CONT_REG
UNION
-- agrupadora
	SELECT PEDIMP.PI_CODIGO, FACTIMPAGRU.FIA_CODIGO, FACTIMPAGRU.FIA_FOLIO, 
	    FACTIMPAGRU.FIA_FECHA, FACTIMPAGRU.IT_CODIGO, 
	    FACTIMPAGRU.MO_CODIGO, PIF_VALMONEXT, PIF_FACTORMONEXT, PIF_VALDLLS, FACTIMPAGRU.PR_CODIGO, 
	    FACTIMPAGRU.DI_PROVEE,  0, ''	    
	FROM FACTIMPAGRU INNER JOIN PEDIMP
	ON PEDIMP.PI_FACTAGRU = FACTIMPAGRU.FIA_CODIGO INNER JOIN 
	 (SELECT FACTIMP.PI_CODIGO, round(SUM(FACTIMPDET.FID_COS_TOT),2) AS PIF_VALMONEXT, 
	    CASE WHEN (CASE WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN SUM(FACTIMPDET.FID_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1)
	    WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    SUM(FACTIMPDET.FID_COS_TOT) ELSE SUM(isnull(FACTIMPDET.FID_COS_TOT,0)*FACTIMP.FI_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1) END) > 0 THEN 
	    ROUND(SUM(FACTIMPDET.FID_COS_TOT) / (CASE WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN SUM(FACTIMPDET.FID_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1)
	    WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    SUM(FACTIMPDET.FID_COS_TOT) ELSE SUM(isnull(FACTIMPDET.FID_COS_TOT,0)*FACTIMP.FI_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1) END),4) ELSE 1 END AS PIF_FACTORMONEXT, 
	      'PIF_VALDLLS'=CASE WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN round(SUM(FACTIMPDET.FID_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1),2) 
	    WHEN MAX(FACTIMP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    round(SUM(FACTIMPDET.FID_COS_TOT),2) ELSE round(SUM(isnull(FACTIMPDET.FID_COS_TOT,0)*FACTIMP.FI_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTIMP.PI_CODIGO)),1),2) END 
	  FROM FACTIMP LEFT OUTER JOIN 
	      FACTIMPDET ON FACTIMP.FI_CODIGO = FACTIMPDET.FI_CODIGO
	  WHERE FACTIMP.PI_CODIGO <> -1 AND FACTIMP.PI_CODIGO<>0
	 GROUP BY FACTIMP.PI_CODIGO) FACTURAIMP ON FACTURAIMP.PI_CODIGO=PEDIMP.PI_CODIGO 
	WHERE  PEDIMP.PI_USAFACTAGRU = 'S'
UNION
	SELECT     dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTEXPDET.FED_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1),2)
                   WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(dbo.FACTEXPDET.FED_COS_TOT)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1),2) END,
	dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
	FROM         dbo.FACTEXP LEFT OUTER JOIN
	      dbo.FACTEXPDET ON dbo.FACTEXP.FE_CODIGO = dbo.FACTEXPDET.FE_CODIGO
	WHERE     (dbo.FACTEXP.PI_CODIGO <> - 1) AND FE_FACTAGRU NOT IN (SELECT PI_FACTAGRU FROM PEDIMP WHERE PI_MOVIMIENTO='S' AND PI_USAFACTAGRU = 'S' AND PI_FACTAGRU<>-1)
	GROUP BY dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
UNION

	SELECT     dbo.FACTEXP.PI_RECTIFICA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTEXPDET.FED_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_RECTIFICA),1),2)
                   WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(dbo.FACTEXPDET.FED_COS_TOT)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_RECTIFICA),1),2) END,
	dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
	FROM         dbo.FACTEXP LEFT OUTER JOIN
	      dbo.FACTEXPDET ON dbo.FACTEXP.FE_CODIGO = dbo.FACTEXPDET.FE_CODIGO
	WHERE     (dbo.FACTEXP.PI_RECTIFICA <> - 1) AND FE_FACTAGRU NOT IN (SELECT PI_FACTAGRU FROM PEDIMP WHERE PI_MOVIMIENTO='S' AND PI_USAFACTAGRU = 'S' AND PI_FACTAGRU<>-1)
	GROUP BY dbo.FACTEXP.PI_RECTIFICA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
UNION
-- agrupadora
	SELECT PEDIMP.PI_CODIGO, FACTEXPAGRU.FEA_CODIGO, FACTEXPAGRU.FEA_FOLIO, 
	    FACTEXPAGRU.FEA_FECHA, FACTEXPAGRU.IT_COMPANY1, 
	    FACTEXPAGRU.MO_CODIGO, PIF_VALMONEXT, PIF_FACTORMONEXT, PIF_VALDLLS, 
	FACTEXPAGRU.CL_DESTINI, FACTEXPAGRU.DI_DESTINI,  0 AS FEA_CONSECUTIVOPED, ''
	FROM FACTEXPAGRU INNER JOIN PEDIMP
	ON PEDIMP.PI_FACTAGRU = FACTEXPAGRU.FEA_CODIGO INNER JOIN 
	 (SELECT FACTEXP.PI_CODIGO, round(SUM(FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 
	    CASE WHEN (CASE WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN SUM(FACTEXPDET.FED_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1)
	    WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    SUM(FACTEXPDET.FED_COS_TOT) ELSE SUM(isnull(FACTEXPDET.FED_COS_TOT,0)*FACTEXP.FE_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1) END) > 0 THEN 
	    ROUND(SUM(FACTEXPDET.FED_COS_TOT) / (CASE WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN SUM(FACTEXPDET.FED_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1)
	    WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    SUM(FACTEXPDET.FED_COS_TOT) ELSE SUM(isnull(FACTEXPDET.FED_COS_TOT,0)*FACTEXP.FE_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1) END),4) ELSE 1 END AS PIF_FACTORMONEXT, 
	      'PIF_VALDLLS'=CASE WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
	    THEN round(SUM(FACTEXPDET.FED_COS_TOT)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1),2) 
	    WHEN MAX(FACTEXP.MO_CODIGO) IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
	    round(SUM(FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(isnull(FACTEXPDET.FED_COS_TOT,0)*FACTEXP.FE_TIPOCAMBIO)/isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = MAX(FACTEXP.PI_CODIGO)),1),2) END 
	  FROM FACTEXP LEFT OUTER JOIN 
	      FACTEXPDET ON FACTEXP.FE_CODIGO = FACTEXPDET.FE_CODIGO
	  WHERE FACTEXP.PI_CODIGO <> -1 AND FACTEXP.PI_CODIGO<>0
	 GROUP BY FACTEXP.PI_CODIGO) FACTURAIMP ON FACTURAIMP.PI_CODIGO=PEDIMP.PI_CODIGO 
	WHERE  PEDIMP.PI_USAFACTAGRU = 'S'
--complementario
UNION
	SELECT     dbo.PEDIMP.PI_COMPLEMENTA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTEXPDET.FED_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1),2)
                   WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(dbo.FACTEXPDET.FED_COS_TOT)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1),2) END,
	dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
	FROM         dbo.FACTEXP LEFT OUTER JOIN
	      dbo.FACTEXPDET ON dbo.FACTEXP.FE_CODIGO = dbo.FACTEXPDET.FE_CODIGO  LEFT OUTER JOIN
                   dbo.PEDIMP ON dbo.PEDIMP.PI_CODIGO = dbo.FACTEXP.PI_CODIGO
	WHERE     (dbo.PEDIMP.PI_COMPLEMENTA <> - 1)
	GROUP BY dbo.PEDIMP.PI_COMPLEMENTA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED,  dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CONT1_REG
UNION
	SELECT     dbo.PEDIMP.PI_COMPLEMENTA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTEXPDET.FED_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_RECTIFICA),1),2)
                   WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(dbo.FACTEXPDET.FED_COS_TOT)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_RECTIFICA),1),2) END,
	dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
	FROM         dbo.FACTEXP LEFT OUTER JOIN
	      dbo.FACTEXPDET ON dbo.FACTEXP.FE_CODIGO = dbo.FACTEXPDET.FE_CODIGO  LEFT OUTER JOIN
                   dbo.PEDIMP ON dbo.PEDIMP.PI_CODIGO = dbo.FACTEXP.PI_RECTIFICA
	WHERE     (dbo.PEDIMP.PI_COMPLEMENTA <> - 1)
	GROUP BY dbo.PEDIMP.PI_COMPLEMENTA, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.PI_RECTIFICA, dbo.FACTEXP.FE_CONT1_REG
union
-- transferencias (faturas de exportacion relacionadas a la transferencia)
	SELECT     dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) AS PIF_VALMONEXT, 1 AS PIF_FACTORMONEXT, 
                   'PIF_VALDLLS'=CASE WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 154) 
                    THEN round(SUM(dbo.FACTEXPDET.FED_COS_TOT)/ isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1),2)
                   WHEN dbo.FACTEXP.MO_CODIGO IN (SELECT MO_CODIGO FROM MONEDA WHERE MONEDA.PA_CODIGO = 233) THEN 
                   round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2) ELSE round(SUM(dbo.FACTEXPDET.FED_COS_TOT),2)*isnull((SELECT PI_TIP_CAM FROM PEDIMP WHERE PI_CODIGO = dbo.FACTEXP.PI_CODIGO),1) END,
	     dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.FE_CONT1_REG
	FROM         dbo.PEDIMPRELTRANS INNER JOIN
	                      dbo.FACTEXPDET ON dbo.PEDIMPRELTRANS.FED_INDICED = dbo.FACTEXPDET.FED_INDICED INNER JOIN
	                      dbo.PEDIMPDET ON dbo.PEDIMPRELTRANS.PID_INDICED = dbo.PEDIMPDET.PID_INDICED INNER JOIN
	                      dbo.FACTEXP ON dbo.FACTEXPDET.FE_CODIGO = dbo.FACTEXP.FE_CODIGO
	WHERE FE_FACTAGRU NOT IN (SELECT PI_FACTAGRU FROM PEDIMP WHERE PI_MOVIMIENTO='S' AND PI_FACTAGRU<>-1)
	GROUP BY dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CODIGO, dbo.FACTEXP.FE_FOLIO, dbo.FACTEXP.FE_FECHA, dbo.FACTEXP.IT_COMPANY1, 
	      dbo.FACTEXP.MO_CODIGO, dbo.FACTEXP.CL_DESTINI, dbo.FACTEXP.DI_DESTINI, dbo.FACTEXP.FE_CONSECUTIVOPED, dbo.FACTEXP.PI_CODIGO, dbo.FACTEXP.FE_CONT1_REG







GO
